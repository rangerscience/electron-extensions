const { ipcRenderer, webFrame } = require('electron');
const constants = require('../../common/constants');
process.setMaxListeners(100);
// Check whether pattern matches.
// https://developer.chrome.com/extensions/match_patterns
const matchesPattern = function (pattern) {
    if (pattern === '<all_urls>')
        return true;
    const regexp = new RegExp('^' + pattern.replace(/\*/g, '.*') + '$');
    const url = `${location.protocol}//${location.host}${location.pathname}`;
    return url.match(regexp);
};
const setupContentScript = function (extensionId, worldId, callback) {
    const chromeAPIs = require('../chrome-api').injectTo(extensionId, false, {});
    webFrame.executeJavaScriptInIsolatedWorld(worldId, [{ code: 'window', url: `${extensionId}://ChromeAPI` }], function (isolatedWorldWindow) {
        isolatedWorldWindow.chrome = chromeAPIs;
        callback(isolatedWorldWindow);
    });
};
// Run the code with chrome API integrated.
const injectContentScript = function (worldId, scripts) {
    webFrame.executeJavaScriptInIsolatedWorld(worldId, scripts);
};
// Run injected scripts.
// https://developer.chrome.com/extensions/content_scripts
const addContentScript = function (extensionId, script) {
    if (!script.matches.some(matchesPattern))
        return;
    if (script.exclude_matches && script.exclude_matches.some(matchesPattern))
        return;
    const worldId = require('../isolated-worlds').getIsolatedWorldId(extensionId);
    const fire = () => injectContentScript(worldId, script.js.map((js) => ({
        code: js.code,
        url: js.url
    })));
    if (script.js) {
        if (script.runAt === 'document_start') {
            process.once('document-start', fire);
        }
        else if (script.runAt === 'document_end') {
            process.once('document-end', fire);
        }
        else if (script.runAt === 'document_idle') {
            document.addEventListener('DOMContentLoaded', fire);
        }
    }
    if (script.css) {
        for (const { code } of script.css) {
            process.once('document-end', () => {
                var node = document.createElement('style');
                node.innerHTML = code;
                window.document.body.appendChild(node);
            });
        }
    }
};
// Handle the request of chrome.tabs.executeJavaScript.
ipcRenderer.on(constants.TABS_EXECUTESCRIPT, function (event, senderWebContentsId, requestId, extensionId, url, code) {
    const worldId = require('../isolated-worlds').getIsolatedWorldId(extensionId);
    const result = injectContentScript(worldId, [{ url, code }]);
    ipcRenderer.sendToAll(senderWebContentsId, `${constants.TABS_EXECUTESCRIPT_RESULT_}${requestId}`, result);
});
// Read the renderer process preferences.
const getContentScripts = () => ipcRenderer.sendSync('GET_CONTENTSCRIPTS_SYNC');
const getContentSecurityPolicy = () => ipcRenderer.sendSync('GET_CONTENTSECURITYPOLICY_SYNC');
const contentScripts = getContentScripts();
const setIsolatedWorldInfo = (worldId, humanReadableName, securityOrigin, csp) => {
    webFrame.setIsolatedWorldInfo(worldId, {
        securityOrigin,
        name: humanReadableName,
        csp,
    });
};
Object.keys(contentScripts).forEach(key => {
    const cs = contentScripts[key];
    const worldId = require('../isolated-worlds').getIsolatedWorldId(cs.extensionId);
    const contentSecurityPolicy = getContentSecurityPolicy();
    // Defaults to Chromium kDefaultIsolatedWorldCSP_Secure
    // https://cs.chromium.org/chromium/src/extensions/common/manifest_handlers/csp_info.cc?l=36
    const csp = contentSecurityPolicy.policy || "script-src 'self'; object-src 'self'";
    setIsolatedWorldInfo(worldId, cs.extensionName, `${constants.EXTENSION_PROTOCOL}://${cs.extensionId}`, csp);
    if (cs.contentScripts) {
        setupContentScript(cs.extensionId, worldId, function (isolatedWorldWindow) {
            // native window open workaround
            const { ipcRendererInternal } = require('@electron/internal/renderer/ipc-renderer-internal');
            const { guestInstanceId, openerId } = process;
            // hardcoded gmelius extension id
            const shouldUseNonNativeWinOpen = cs.extensionId === 'dheionainndbbpoacpnopgmnihkcmnkl';
            require('../window-setup')(isolatedWorldWindow, ipcRendererInternal, guestInstanceId, openerId, shouldUseNonNativeWinOpen);
            // end workaround
            require('../xhr').default(isolatedWorldWindow);
            for (const script of cs.contentScripts) {
                addContentScript(cs.extensionId, script);
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1zY3JpcHRzLWluamVjdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3JlbmRlcmVyL2luamVjdG9ycy9jb250ZW50LXNjcmlwdHMtaW5qZWN0b3IuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTSxFQUFFLFdBQVcsRUFBRSxRQUFRLEVBQUUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDdEQsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFFcEQsT0FBTyxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUU3QixpQ0FBaUM7QUFDakMseURBQXlEO0FBQ3pELE1BQU0sY0FBYyxHQUFHLFVBQVUsT0FBTztJQUN0QyxJQUFJLE9BQU8sS0FBSyxZQUFZO1FBQUUsT0FBTyxJQUFJLENBQUE7SUFDekMsTUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFBO0lBQ25FLE1BQU0sR0FBRyxHQUFHLEdBQUcsUUFBUSxDQUFDLFFBQVEsS0FBSyxRQUFRLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtJQUN4RSxPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUE7QUFDMUIsQ0FBQyxDQUFBO0FBRUQsTUFBTSxrQkFBa0IsR0FBRyxVQUFVLFdBQVcsRUFBRSxPQUFPLEVBQUUsUUFBUTtJQUNqRSxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUE7SUFFNUUsUUFBUSxDQUFDLGdDQUFnQyxDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsR0FBRyxXQUFXLGNBQWMsRUFBRSxDQUFDLEVBQUUsVUFBVSxtQkFBbUI7UUFDdkksbUJBQW1CLENBQUMsTUFBTSxHQUFHLFVBQVUsQ0FBQztRQUN4QyxRQUFRLENBQUMsbUJBQW1CLENBQUMsQ0FBQTtJQUMvQixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQTtBQUVELDJDQUEyQztBQUMzQyxNQUFNLG1CQUFtQixHQUFHLFVBQVUsT0FBTyxFQUFFLE9BQU87SUFDcEQsUUFBUSxDQUFDLGdDQUFnQyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQztBQUM5RCxDQUFDLENBQUE7QUFFRCx3QkFBd0I7QUFDeEIsMERBQTBEO0FBQzFELE1BQU0sZ0JBQWdCLEdBQUcsVUFBVSxXQUFXLEVBQUUsTUFBTTtJQUNwRCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDO1FBQUUsT0FBTTtJQUNoRCxJQUFJLE1BQU0sQ0FBQyxlQUFlLElBQUksTUFBTSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDO1FBQUUsT0FBTTtJQUNqRixNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUU3RSxNQUFNLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDckUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJO1FBQ2IsR0FBRyxFQUFFLEVBQUUsQ0FBQyxHQUFHO0tBQ1osQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVMLElBQUksTUFBTSxDQUFDLEVBQUUsRUFBRTtRQUNiLElBQUksTUFBTSxDQUFDLEtBQUssS0FBSyxnQkFBZ0IsRUFBRTtZQUNyQyxPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxDQUFBO1NBQ3JDO2FBQU0sSUFBSSxNQUFNLENBQUMsS0FBSyxLQUFLLGNBQWMsRUFBRTtZQUMxQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQTtTQUNuQzthQUFNLElBQUksTUFBTSxDQUFDLEtBQUssS0FBSyxlQUFlLEVBQUU7WUFDM0MsUUFBUSxDQUFDLGdCQUFnQixDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxDQUFBO1NBQ3BEO0tBQ0Y7SUFFRCxJQUFJLE1BQU0sQ0FBQyxHQUFHLEVBQUU7UUFDZCxLQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxNQUFNLENBQUMsR0FBRyxFQUFFO1lBQ2pDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEdBQUcsRUFBRTtnQkFDaEMsSUFBSSxJQUFJLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQTtnQkFDMUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7Z0JBQ3JCLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUN4QyxDQUFDLENBQUMsQ0FBQTtTQUNIO0tBQ0Y7QUFDSCxDQUFDLENBQUE7QUFFRCx1REFBdUQ7QUFDdkQsV0FBVyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLEVBQUUsVUFBVSxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxHQUFHLEVBQUUsSUFBSTtJQUNsSCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsQ0FBQTtJQUM3RSxNQUFNLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDNUQsV0FBVyxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLFNBQVMsQ0FBQywwQkFBMEIsR0FBRyxTQUFTLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQTtBQUMzRyxDQUFDLENBQUMsQ0FBQTtBQUVGLHlDQUF5QztBQUN6QyxNQUFNLGlCQUFpQixHQUFHLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMseUJBQXlCLENBQUMsQ0FBQztBQUNoRixNQUFNLHdCQUF3QixHQUFHLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztBQUM5RixNQUFNLGNBQWMsR0FBRyxpQkFBaUIsRUFBRSxDQUFDO0FBRTNDLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsY0FBYyxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQy9FLFFBQVEsQ0FBQyxvQkFBb0IsQ0FDM0IsT0FBTyxFQUNQO1FBQ0UsY0FBYztRQUNkLElBQUksRUFBRSxpQkFBaUI7UUFDdkIsR0FBRztLQUNKLENBQUMsQ0FBQztBQUNQLENBQUMsQ0FBQztBQUVGLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO0lBQ3hDLE1BQU0sRUFBRSxHQUFHLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMvQixNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUE7SUFFaEYsTUFBTSxxQkFBcUIsR0FBRyx3QkFBd0IsRUFBRSxDQUFDO0lBQ3pELHVEQUF1RDtJQUN2RCw0RkFBNEY7SUFDNUYsTUFBTSxHQUFHLEdBQUcscUJBQXFCLENBQUMsTUFBTSxJQUFJLHNDQUFzQyxDQUFDO0lBRW5GLG9CQUFvQixDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsYUFBYSxFQUFFLEdBQUcsU0FBUyxDQUFDLGtCQUFrQixNQUFNLEVBQUUsQ0FBQyxXQUFXLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUU1RyxJQUFJLEVBQUUsQ0FBQyxjQUFjLEVBQUU7UUFDckIsa0JBQWtCLENBQUMsRUFBRSxDQUFDLFdBQVcsRUFBRSxPQUFPLEVBQUUsVUFBVSxtQkFBbUI7WUFDdkUsZ0NBQWdDO1lBQ2hDLE1BQU0sRUFBRSxtQkFBbUIsRUFBRSxHQUFHLE9BQU8sQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO1lBRTdGLE1BQU0sRUFBRSxlQUFlLEVBQUUsUUFBUSxFQUFFLEdBQUcsT0FBTyxDQUFDO1lBRTlDLGlDQUFpQztZQUNqQyxNQUFNLHlCQUF5QixHQUFHLEVBQUUsQ0FBQyxXQUFXLEtBQUssa0NBQWtDLENBQUM7WUFFeEYsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsbUJBQW1CLEVBQUUsbUJBQW1CLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSx5QkFBeUIsQ0FBQyxDQUFDO1lBQzNILGlCQUFpQjtZQUVqQixPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFFL0MsS0FBSyxNQUFNLE1BQU0sSUFBSSxFQUFFLENBQUMsY0FBYyxFQUFFO2dCQUN0QyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFBO2FBQ3pDO1FBQ0gsQ0FBQyxDQUFDLENBQUE7S0FDSDtBQUNILENBQUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBpcGNSZW5kZXJlciwgd2ViRnJhbWUgfSA9IHJlcXVpcmUoJ2VsZWN0cm9uJyk7XG5jb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuLi8uLi9jb21tb24vY29uc3RhbnRzJyk7XG5cbnByb2Nlc3Muc2V0TWF4TGlzdGVuZXJzKDEwMCk7XG5cbi8vIENoZWNrIHdoZXRoZXIgcGF0dGVybiBtYXRjaGVzLlxuLy8gaHR0cHM6Ly9kZXZlbG9wZXIuY2hyb21lLmNvbS9leHRlbnNpb25zL21hdGNoX3BhdHRlcm5zXG5jb25zdCBtYXRjaGVzUGF0dGVybiA9IGZ1bmN0aW9uIChwYXR0ZXJuKSB7XG4gIGlmIChwYXR0ZXJuID09PSAnPGFsbF91cmxzPicpIHJldHVybiB0cnVlXG4gIGNvbnN0IHJlZ2V4cCA9IG5ldyBSZWdFeHAoJ14nICsgcGF0dGVybi5yZXBsYWNlKC9cXCovZywgJy4qJykgKyAnJCcpXG4gIGNvbnN0IHVybCA9IGAke2xvY2F0aW9uLnByb3RvY29sfS8vJHtsb2NhdGlvbi5ob3N0fSR7bG9jYXRpb24ucGF0aG5hbWV9YFxuICByZXR1cm4gdXJsLm1hdGNoKHJlZ2V4cClcbn1cblxuY29uc3Qgc2V0dXBDb250ZW50U2NyaXB0ID0gZnVuY3Rpb24gKGV4dGVuc2lvbklkLCB3b3JsZElkLCBjYWxsYmFjaykge1xuICBjb25zdCBjaHJvbWVBUElzID0gcmVxdWlyZSgnLi4vY2hyb21lLWFwaScpLmluamVjdFRvKGV4dGVuc2lvbklkLCBmYWxzZSwge30pXG5cbiAgd2ViRnJhbWUuZXhlY3V0ZUphdmFTY3JpcHRJbklzb2xhdGVkV29ybGQod29ybGRJZCwgW3sgY29kZTogJ3dpbmRvdycsIHVybDogYCR7ZXh0ZW5zaW9uSWR9Oi8vQ2hyb21lQVBJYCB9XSwgZnVuY3Rpb24gKGlzb2xhdGVkV29ybGRXaW5kb3cpIHtcbiAgICBpc29sYXRlZFdvcmxkV2luZG93LmNocm9tZSA9IGNocm9tZUFQSXM7XG4gICAgY2FsbGJhY2soaXNvbGF0ZWRXb3JsZFdpbmRvdylcbiAgfSk7XG59XG5cbi8vIFJ1biB0aGUgY29kZSB3aXRoIGNocm9tZSBBUEkgaW50ZWdyYXRlZC5cbmNvbnN0IGluamVjdENvbnRlbnRTY3JpcHQgPSBmdW5jdGlvbiAod29ybGRJZCwgc2NyaXB0cykge1xuICB3ZWJGcmFtZS5leGVjdXRlSmF2YVNjcmlwdEluSXNvbGF0ZWRXb3JsZCh3b3JsZElkLCBzY3JpcHRzKTtcbn1cblxuLy8gUnVuIGluamVjdGVkIHNjcmlwdHMuXG4vLyBodHRwczovL2RldmVsb3Blci5jaHJvbWUuY29tL2V4dGVuc2lvbnMvY29udGVudF9zY3JpcHRzXG5jb25zdCBhZGRDb250ZW50U2NyaXB0ID0gZnVuY3Rpb24gKGV4dGVuc2lvbklkLCBzY3JpcHQpIHtcbiAgaWYgKCFzY3JpcHQubWF0Y2hlcy5zb21lKG1hdGNoZXNQYXR0ZXJuKSkgcmV0dXJuXG4gIGlmIChzY3JpcHQuZXhjbHVkZV9tYXRjaGVzICYmIHNjcmlwdC5leGNsdWRlX21hdGNoZXMuc29tZShtYXRjaGVzUGF0dGVybikpIHJldHVyblxuICBjb25zdCB3b3JsZElkID0gcmVxdWlyZSgnLi4vaXNvbGF0ZWQtd29ybGRzJykuZ2V0SXNvbGF0ZWRXb3JsZElkKGV4dGVuc2lvbklkKVxuXG4gIGNvbnN0IGZpcmUgPSAoKSA9PiBpbmplY3RDb250ZW50U2NyaXB0KHdvcmxkSWQsIHNjcmlwdC5qcy5tYXAoKGpzKSA9PiAoe1xuICAgIGNvZGU6IGpzLmNvZGUsXG4gICAgdXJsOiBqcy51cmxcbiAgfSkpKTtcblxuICBpZiAoc2NyaXB0LmpzKSB7XG4gICAgaWYgKHNjcmlwdC5ydW5BdCA9PT0gJ2RvY3VtZW50X3N0YXJ0Jykge1xuICAgICAgcHJvY2Vzcy5vbmNlKCdkb2N1bWVudC1zdGFydCcsIGZpcmUpXG4gICAgfSBlbHNlIGlmIChzY3JpcHQucnVuQXQgPT09ICdkb2N1bWVudF9lbmQnKSB7XG4gICAgICBwcm9jZXNzLm9uY2UoJ2RvY3VtZW50LWVuZCcsIGZpcmUpXG4gICAgfSBlbHNlIGlmIChzY3JpcHQucnVuQXQgPT09ICdkb2N1bWVudF9pZGxlJykge1xuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZpcmUpXG4gICAgfVxuICB9XG5cbiAgaWYgKHNjcmlwdC5jc3MpIHtcbiAgICBmb3IgKGNvbnN0IHsgY29kZSB9IG9mIHNjcmlwdC5jc3MpIHtcbiAgICAgIHByb2Nlc3Mub25jZSgnZG9jdW1lbnQtZW5kJywgKCkgPT4ge1xuICAgICAgICB2YXIgbm9kZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJylcbiAgICAgICAgbm9kZS5pbm5lckhUTUwgPSBjb2RlXG4gICAgICAgIHdpbmRvdy5kb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKG5vZGUpXG4gICAgICB9KVxuICAgIH1cbiAgfVxufVxuXG4vLyBIYW5kbGUgdGhlIHJlcXVlc3Qgb2YgY2hyb21lLnRhYnMuZXhlY3V0ZUphdmFTY3JpcHQuXG5pcGNSZW5kZXJlci5vbihjb25zdGFudHMuVEFCU19FWEVDVVRFU0NSSVBULCBmdW5jdGlvbiAoZXZlbnQsIHNlbmRlcldlYkNvbnRlbnRzSWQsIHJlcXVlc3RJZCwgZXh0ZW5zaW9uSWQsIHVybCwgY29kZSkge1xuICBjb25zdCB3b3JsZElkID0gcmVxdWlyZSgnLi4vaXNvbGF0ZWQtd29ybGRzJykuZ2V0SXNvbGF0ZWRXb3JsZElkKGV4dGVuc2lvbklkKVxuICBjb25zdCByZXN1bHQgPSBpbmplY3RDb250ZW50U2NyaXB0KHdvcmxkSWQsIFt7IHVybCwgY29kZSB9XSlcbiAgaXBjUmVuZGVyZXIuc2VuZFRvQWxsKHNlbmRlcldlYkNvbnRlbnRzSWQsIGAke2NvbnN0YW50cy5UQUJTX0VYRUNVVEVTQ1JJUFRfUkVTVUxUX30ke3JlcXVlc3RJZH1gLCByZXN1bHQpXG59KVxuXG4vLyBSZWFkIHRoZSByZW5kZXJlciBwcm9jZXNzIHByZWZlcmVuY2VzLlxuY29uc3QgZ2V0Q29udGVudFNjcmlwdHMgPSAoKSA9PiBpcGNSZW5kZXJlci5zZW5kU3luYygnR0VUX0NPTlRFTlRTQ1JJUFRTX1NZTkMnKTtcbmNvbnN0IGdldENvbnRlbnRTZWN1cml0eVBvbGljeSA9ICgpID0+IGlwY1JlbmRlcmVyLnNlbmRTeW5jKCdHRVRfQ09OVEVOVFNFQ1VSSVRZUE9MSUNZX1NZTkMnKTtcbmNvbnN0IGNvbnRlbnRTY3JpcHRzID0gZ2V0Q29udGVudFNjcmlwdHMoKTtcblxuY29uc3Qgc2V0SXNvbGF0ZWRXb3JsZEluZm8gPSAod29ybGRJZCwgaHVtYW5SZWFkYWJsZU5hbWUsIHNlY3VyaXR5T3JpZ2luLCBjc3ApID0+IHtcbiAgd2ViRnJhbWUuc2V0SXNvbGF0ZWRXb3JsZEluZm8oXG4gICAgd29ybGRJZCxcbiAgICB7XG4gICAgICBzZWN1cml0eU9yaWdpbixcbiAgICAgIG5hbWU6IGh1bWFuUmVhZGFibGVOYW1lLFxuICAgICAgY3NwLFxuICAgIH0pO1xufTtcblxuT2JqZWN0LmtleXMoY29udGVudFNjcmlwdHMpLmZvckVhY2goa2V5ID0+IHtcbiAgY29uc3QgY3MgPSBjb250ZW50U2NyaXB0c1trZXldO1xuICBjb25zdCB3b3JsZElkID0gcmVxdWlyZSgnLi4vaXNvbGF0ZWQtd29ybGRzJykuZ2V0SXNvbGF0ZWRXb3JsZElkKGNzLmV4dGVuc2lvbklkKVxuXG4gIGNvbnN0IGNvbnRlbnRTZWN1cml0eVBvbGljeSA9IGdldENvbnRlbnRTZWN1cml0eVBvbGljeSgpO1xuICAvLyBEZWZhdWx0cyB0byBDaHJvbWl1bSBrRGVmYXVsdElzb2xhdGVkV29ybGRDU1BfU2VjdXJlXG4gIC8vIGh0dHBzOi8vY3MuY2hyb21pdW0ub3JnL2Nocm9taXVtL3NyYy9leHRlbnNpb25zL2NvbW1vbi9tYW5pZmVzdF9oYW5kbGVycy9jc3BfaW5mby5jYz9sPTM2XG4gIGNvbnN0IGNzcCA9IGNvbnRlbnRTZWN1cml0eVBvbGljeS5wb2xpY3kgfHwgXCJzY3JpcHQtc3JjICdzZWxmJzsgb2JqZWN0LXNyYyAnc2VsZidcIjtcblxuICBzZXRJc29sYXRlZFdvcmxkSW5mbyh3b3JsZElkLCBjcy5leHRlbnNpb25OYW1lLCBgJHtjb25zdGFudHMuRVhURU5TSU9OX1BST1RPQ09MfTovLyR7Y3MuZXh0ZW5zaW9uSWR9YCwgY3NwKTtcblxuICBpZiAoY3MuY29udGVudFNjcmlwdHMpIHtcbiAgICBzZXR1cENvbnRlbnRTY3JpcHQoY3MuZXh0ZW5zaW9uSWQsIHdvcmxkSWQsIGZ1bmN0aW9uIChpc29sYXRlZFdvcmxkV2luZG93KSB7XG4gICAgICAvLyBuYXRpdmUgd2luZG93IG9wZW4gd29ya2Fyb3VuZFxuICAgICAgY29uc3QgeyBpcGNSZW5kZXJlckludGVybmFsIH0gPSByZXF1aXJlKCdAZWxlY3Ryb24vaW50ZXJuYWwvcmVuZGVyZXIvaXBjLXJlbmRlcmVyLWludGVybmFsJyk7XG5cbiAgICAgIGNvbnN0IHsgZ3Vlc3RJbnN0YW5jZUlkLCBvcGVuZXJJZCB9ID0gcHJvY2VzcztcblxuICAgICAgLy8gaGFyZGNvZGVkIGdtZWxpdXMgZXh0ZW5zaW9uIGlkXG4gICAgICBjb25zdCBzaG91bGRVc2VOb25OYXRpdmVXaW5PcGVuID0gY3MuZXh0ZW5zaW9uSWQgPT09ICdkaGVpb25haW5uZGJicG9hY3Bub3BnbW5paGtjbW5rbCc7XG5cbiAgICAgIHJlcXVpcmUoJy4uL3dpbmRvdy1zZXR1cCcpKGlzb2xhdGVkV29ybGRXaW5kb3csIGlwY1JlbmRlcmVySW50ZXJuYWwsIGd1ZXN0SW5zdGFuY2VJZCwgb3BlbmVySWQsIHNob3VsZFVzZU5vbk5hdGl2ZVdpbk9wZW4pO1xuICAgICAgLy8gZW5kIHdvcmthcm91bmRcblxuICAgICAgcmVxdWlyZSgnLi4veGhyJykuZGVmYXVsdChpc29sYXRlZFdvcmxkV2luZG93KTtcblxuICAgICAgZm9yIChjb25zdCBzY3JpcHQgb2YgY3MuY29udGVudFNjcmlwdHMpIHtcbiAgICAgICAgYWRkQ29udGVudFNjcmlwdChjcy5leHRlbnNpb25JZCwgc2NyaXB0KVxuICAgICAgfVxuICAgIH0pXG4gIH1cbn0pXG4iXX0=