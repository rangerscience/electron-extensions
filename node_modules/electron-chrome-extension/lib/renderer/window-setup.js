// This file overrides this one from electron:
// https://raw.githubusercontent.com/electron/electron/65fe703dc2cb3c8850d6373ddf93520a8adcdbd4/lib/renderer/window-setup.js
//
// The main difference is that here we allow ourselves to take precedence
// over `nativeWindowOpen` for specific URLs
const { defineProperty } = Object;
// Helper function to resolve relative url.
const a = document.createElement('a');
const resolveURL = url => {
    a.href = url;
    return a.href;
};
// Use this method to ensure values expected as strings in the main process
// are convertible to strings in the renderer process. This ensures exceptions
// converting values to strings are thrown in this process.
const toString = value => value != null ? `${value}` : value;
const windowProxies = new Map();
const getOrCreateProxy = (ipcRenderer, guestId) => {
    if (windowProxies.has(guestId)) {
        return windowProxies.get(guestId);
    }
    const proxy = new BrowserWindowProxy(ipcRenderer, guestId);
    windowProxies.set(guestId, proxy);
    return proxy;
};
function BrowserWindowProxy(ipcRenderer, guestId) {
    this.closed = false;
    defineProperty(this, 'location', {
        get() {
            const url = ipcRenderer.sendSync('ELECTRON_GUEST_WINDOW_MANAGER_WEB_CONTENTS_METHOD_SYNC', guestId, 'getURL');
            return new URL(url);
        },
        set(url) {
            url = resolveURL(url);
            return ipcRenderer.sendSync('ELECTRON_GUEST_WINDOW_MANAGER_WEB_CONTENTS_METHOD_SYNC', guestId, 'loadURL', url);
        }
    });
    ipcRenderer.once(`ELECTRON_GUEST_WINDOW_MANAGER_WINDOW_CLOSED_${guestId}`, () => {
        windowProxies.delete(guestId);
        this.closed = true;
    });
    this.close = () => {
        ipcRenderer.send('ELECTRON_GUEST_WINDOW_MANAGER_WINDOW_CLOSE', guestId);
    };
    this.focus = () => {
        ipcRenderer.send('ELECTRON_GUEST_WINDOW_MANAGER_WINDOW_METHOD', guestId, 'focus');
    };
    this.blur = () => {
        ipcRenderer.send('ELECTRON_GUEST_WINDOW_MANAGER_WINDOW_METHOD', guestId, 'blur');
    };
    this.print = () => {
        ipcRenderer.send('ELECTRON_GUEST_WINDOW_MANAGER_WEB_CONTENTS_METHOD', guestId, 'print');
    };
    this.postMessage = (message, targetOrigin) => {
        ipcRenderer.send('ELECTRON_GUEST_WINDOW_MANAGER_WINDOW_POSTMESSAGE', guestId, message, null, null);
    };
    this.eval = (...args) => {
        ipcRenderer.send('ELECTRON_GUEST_WINDOW_MANAGER_WEB_CONTENTS_METHOD', guestId, 'executeJavaScript', ...args);
    };
}
module.exports = (win, ipcRenderer, guestInstanceId, openerId, nonNativeWinOpenForEmptyUrl = false) => {
    Object.defineProperty(win.navigator, 'userAgent', {
        value: win.navigator.userAgent.replace(/Electron\/\S*\s/, ''),
        configurable: false,
        writable: false,
    });
    const originalWinOpen = win.open;
    if (nonNativeWinOpenForEmptyUrl) {
        win.open = (url, frameName, features) => {
            if (url !== '') {
                return originalWinOpen.apply(win, [url]);
            }
            const guestId = ipcRenderer.sendSync('ELECTRON_GUEST_WINDOW_MANAGER_WINDOW_OPEN', url, toString(frameName), toString(features));
            if (guestId !== null) {
                return getOrCreateProxy(ipcRenderer, guestId);
            }
            return null;
        };
    }
    if (win.opener === null) {
        if (!!openerId) {
            win.opener = getOrCreateProxy(ipcRenderer, openerId);
        }
        // This next code block polyfills Mixmax event forwarding
        // between the opened window and the iframe's event listener.
        // Electron loses event references between the content-scripts
        // and the iframe.
        // We manually trigger the intented effect.
        win.addEventListener('message', (event) => {
            if (event.data && event.data.method === 'loginFinished') {
                win.location.reload();
            }
        });
    }
    ipcRenderer.removeAllListeners('ELECTRON_GUEST_WINDOW_POSTMESSAGE');
    ipcRenderer.on('ELECTRON_GUEST_WINDOW_POSTMESSAGE', (event, sourceId, message, sourceOrigin) => {
        event = new MessageEvent('message', { data: message, origin: sourceOrigin });
        event.source = getOrCreateProxy(ipcRenderer, sourceId);
        win.dispatchEvent(event);
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93LXNldHVwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3JlbmRlcmVyL3dpbmRvdy1zZXR1cC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw4Q0FBOEM7QUFDOUMsNEhBQTRIO0FBQzVILEVBQUU7QUFDRix5RUFBeUU7QUFDekUsNENBQTRDO0FBQzVDLE1BQU0sRUFBRSxjQUFjLEVBQUUsR0FBRyxNQUFNLENBQUM7QUFFbEMsMkNBQTJDO0FBQzNDLE1BQU0sQ0FBQyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdEMsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLEVBQUU7SUFDdkIsQ0FBQyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUM7SUFDYixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDaEIsQ0FBQyxDQUFDO0FBRUYsMkVBQTJFO0FBQzNFLDhFQUE4RTtBQUM5RSwyREFBMkQ7QUFDM0QsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFFN0QsTUFBTSxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUVoQyxNQUFNLGdCQUFnQixHQUFHLENBQUMsV0FBVyxFQUFFLE9BQU8sRUFBRSxFQUFFO0lBQ2hELElBQUksYUFBYSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUM5QixPQUFPLGFBQWEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDbkM7SUFFRCxNQUFNLEtBQUssR0FBRyxJQUFJLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMzRCxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUVsQyxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMs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RUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDO1FBQzdFLEtBQUssQ0FBQyxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRXZELEdBQUcsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDM0IsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUaGlzIGZpbGUgb3ZlcnJpZGVzIHRoaXMgb25lIGZyb20gZWxlY3Ryb246XG4vLyBodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vZWxlY3Ryb24vZWxlY3Ryb24vNjVmZTcwM2RjMmNiM2M4ODUwZDYzNzNkZGY5MzUyMGE4YWRjZGJkNC9saWIvcmVuZGVyZXIvd2luZG93LXNldHVwLmpzXG4vL1xuLy8gVGhlIG1haW4gZGlmZmVyZW5jZSBpcyB0aGF0IGhlcmUgd2UgYWxsb3cgb3Vyc2VsdmVzIHRvIHRha2UgcHJlY2VkZW5jZVxuLy8gb3ZlciBgbmF0aXZlV2luZG93T3BlbmAgZm9yIHNwZWNpZmljIFVSTHNcbmNvbnN0IHsgZGVmaW5lUHJvcGVydHkgfSA9IE9iamVjdDtcblxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIHJlc29sdmUgcmVsYXRpdmUgdXJsLlxuY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTtcbmNvbnN0IHJlc29sdmVVUkwgPSB1cmwgPT4ge1xuICBhLmhyZWYgPSB1cmw7XG4gIHJldHVybiBhLmhyZWY7XG59O1xuXG4vLyBVc2UgdGhpcyBtZXRob2QgdG8gZW5zdXJlIHZhbHVlcyBleHBlY3RlZCBhcyBzdHJpbmdzIGluIHRoZSBtYWluIHByb2Nlc3Ncbi8vIGFyZSBjb252ZXJ0aWJsZSB0byBzdHJpbmdzIGluIHRoZSByZW5kZXJlciBwcm9jZXNzLiBUaGlzIGVuc3VyZXMgZXhjZXB0aW9uc1xuLy8gY29udmVydGluZyB2YWx1ZXMgdG8gc3RyaW5ncyBhcmUgdGhyb3duIGluIHRoaXMgcHJvY2Vzcy5cbmNvbnN0IHRvU3RyaW5nID0gdmFsdWUgPT4gdmFsdWUgIT0gbnVsbCA/IGAke3ZhbHVlfWAgOiB2YWx1ZTtcblxuY29uc3Qgd2luZG93UHJveGllcyA9IG5ldyBNYXAoKTtcblxuY29uc3QgZ2V0T3JDcmVhdGVQcm94eSA9IChpcGNSZW5kZXJlciwgZ3Vlc3RJZCkgPT4ge1xuICBpZiAod2luZG93UHJveGllcy5oYXMoZ3Vlc3RJZCkpIHtcbiAgICByZXR1cm4gd2luZG93UHJveGllcy5nZXQoZ3Vlc3RJZCk7XG4gIH1cblxuICBjb25zdCBwcm94eSA9IG5ldyBCcm93c2VyV2luZG93UHJveHkoaXBjUmVuZGVyZXIsIGd1ZXN0SWQpO1xuICB3aW5kb3dQcm94aWVzLnNldChndWVzdElkLCBwcm94eSk7XG5cbiAgcmV0dXJuIHByb3h5O1xufTtcblxuZnVuY3Rpb24gQnJvd3NlcldpbmRvd1Byb3h5KGlwY1JlbmRlcmVyLCBndWVzdElkKSB7XG4gIHRoaXMuY2xvc2VkID0gZmFsc2U7XG5cbiAgZGVmaW5lUHJvcGVydHkodGhpcywgJ2xvY2F0aW9uJywge1xuICAgIGdldCgpIHtcbiAgICAgIGNvbnN0IHVybCA9IGlwY1JlbmRlcmVyLnNlbmRTeW5jKCdFTEVDVFJPTl9HVUVTVF9XSU5ET1dfTUFOQUdFUl9XRUJfQ09OVEVOVFNfTUVUSE9EX1NZTkMnLCBndWVzdElkLCAnZ2V0VVJMJyk7XG4gICAgICByZXR1cm4gbmV3IFVSTCh1cmwpO1xuICAgIH0sXG4gICAgc2V0KHVybCkge1xuICAgICAgdXJsID0gcmVzb2x2ZVVSTCh1cmwpO1xuICAgICAgcmV0dXJuIGlwY1JlbmRlcmVyLnNlbmRTeW5jKCdFTEVDVFJPTl9HVUVTVF9XSU5ET1dfTUFOQUdFUl9XRUJfQ09OVEVOVFNfTUVUSE9EX1NZTkMnLCBndWVzdElkLCAnbG9hZFVSTCcsIHVybCk7XG4gICAgfVxuICB9KTtcblxuICBpcGNSZW5kZXJlci5vbmNlKGBFTEVDVFJPTl9HVUVTVF9XSU5ET1dfTUFOQUdFUl9XSU5ET1dfQ0xPU0VEXyR7Z3Vlc3RJZH1gLCAoKSA9PiB7XG4gICAgd2luZG93UHJveGllcy5kZWxldGUoZ3Vlc3RJZCk7XG4gICAgdGhpcy5jbG9zZWQgPSB0cnVlO1xuICB9KTtcblxuICB0aGlzLmNsb3NlID0gKCkgPT4ge1xuICAgIGlwY1JlbmRlcmVyLnNlbmQoJ0VMRUNUUk9OX0dVRVNUX1dJTkRPV19NQU5BR0VSX1dJTkRPV19DTE9TRScsIGd1ZXN0SWQpO1xuICB9O1xuXG4gIHRoaXMuZm9jdXMgPSAoKSA9PiB7XG4gICAgaXBjUmVuZGVyZXIuc2VuZCgnRUxFQ1RST05fR1VFU1RfV0lORE9XX01BTkFHRVJfV0lORE9XX01FVEhPRCcsIGd1ZXN0SWQsICdmb2N1cycpO1xuICB9O1xuXG4gIHRoaXMuYmx1ciA9ICgpID0+IHtcbiAgICBpcGNSZW5kZXJlci5zZW5kKCdFTEVDVFJPTl9HVUVTVF9XSU5ET1dfTUFOQUdFUl9XSU5ET1dfTUVUSE9EJywgZ3Vlc3RJZCwgJ2JsdXInKTtcbiAgfTtcblxuICB0aGlzLnByaW50ID0gKCkgPT4ge1xuICAgIGlwY1JlbmRlcmVyLnNlbmQoJ0VMRUNUUk9OX0dVRVNUX1dJTkRPV19NQU5BR0VSX1dFQl9DT05URU5UU19NRVRIT0QnLCBndWVzdElkLCAncHJpbnQnKTtcbiAgfTtcblxuICB0aGlzLnBvc3RNZXNzYWdlID0gKG1lc3NhZ2UsIHRhcmdldE9yaWdpbikgPT4ge1xuICAgIGlwY1JlbmRlcmVyLnNlbmQoJ0VMRUNUUk9OX0dVRVNUX1dJTkRPV19NQU5BR0VSX1dJTkRPV19QT1NUTUVTU0FHRScsIGd1ZXN0SWQsIG1lc3NhZ2UsIG51bGwsIG51bGwpO1xuICB9O1xuXG4gIHRoaXMuZXZhbCA9ICguLi5hcmdzKSA9PiB7XG4gICAgaXBjUmVuZGVyZXIuc2VuZCgnRUxFQ1RST05fR1VFU1RfV0lORE9XX01BTkFHRVJfV0VCX0NPTlRFTlRTX01FVEhPRCcsIGd1ZXN0SWQsICdleGVjdXRlSmF2YVNjcmlwdCcsIC4uLmFyZ3MpO1xuICB9O1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9ICh3aW4sIGlwY1JlbmRlcmVyLCBndWVzdEluc3RhbmNlSWQsIG9wZW5lcklkLCBub25OYXRpdmVXaW5PcGVuRm9yRW1wdHlVcmwgPSBmYWxzZSkgPT4ge1xuICBPYmplY3QuZGVmaW5lUHJvcGVydHkod2luLm5hdmlnYXRvciwgJ3VzZXJBZ2VudCcsIHtcbiAgICB2YWx1ZTogd2luLm5hdmlnYXRvci51c2VyQWdlbnQucmVwbGFjZSgvRWxlY3Ryb25cXC9cXFMqXFxzLywgJycpLFxuICAgIGNvbmZpZ3VyYWJsZTogZmFsc2UsXG4gICAgd3JpdGFibGU6IGZhbHNlLFxuICB9KTtcblxuICBjb25zdCBvcmlnaW5hbFdpbk9wZW4gPSB3aW4ub3BlbjtcblxuICBpZiAobm9uTmF0aXZlV2luT3BlbkZvckVtcHR5VXJsKSB7XG4gICAgd2luLm9wZW4gPSAodXJsLCBmcmFtZU5hbWUsIGZlYXR1cmVzKSA9PiB7XG4gICAgICBpZiAodXJsICE9PSAnJykge1xuICAgICAgICByZXR1cm4gb3JpZ2luYWxXaW5PcGVuLmFwcGx5KHdpbiwgW3VybF0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBndWVzdElkID0gaXBjUmVuZGVyZXIuc2VuZFN5bmMoJ0VMRUNUUk9OX0dVRVNUX1dJTkRPV19NQU5BR0VSX1dJTkRPV19PUEVOJywgdXJsLCB0b1N0cmluZyhmcmFtZU5hbWUpLCB0b1N0cmluZyhmZWF0dXJlcykpO1xuXG4gICAgICBpZiAoZ3Vlc3RJZCAhPT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gZ2V0T3JDcmVhdGVQcm94eShpcGNSZW5kZXJlciwgZ3Vlc3RJZCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH07XG4gIH1cblxuICBpZiAod2luLm9wZW5lciA9PT0gbnVsbCkge1xuICAgIGlmICghIW9wZW5lcklkKSB7XG4gICAgICB3aW4ub3BlbmVyID0gZ2V0T3JDcmVhdGVQcm94eShpcGNSZW5kZXJlciwgb3BlbmVySWQpO1xuICAgIH1cblxuICAgIC8vIFRoaXMgbmV4dCBjb2RlIGJsb2NrIHBvbHlmaWxscyBNaXhtYXggZXZlbnQgZm9yd2FyZGluZ1xuICAgIC8vIGJldHdlZW4gdGhlIG9wZW5lZCB3aW5kb3cgYW5kIHRoZSBpZnJhbWUncyBldmVudCBsaXN0ZW5lci5cbiAgICAvLyBFbGVjdHJvbiBsb3NlcyBldmVudCByZWZlcmVuY2VzIGJldHdlZW4gdGhlIGNvbnRlbnQtc2NyaXB0c1xuICAgIC8vIGFuZCB0aGUgaWZyYW1lLlxuICAgIC8vIFdlIG1hbnVhbGx5IHRyaWdnZXIgdGhlIGludGVudGVkIGVmZmVjdC5cbiAgICB3aW4uYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIChldmVudCkgPT4ge1xuICAgICAgaWYgKGV2ZW50LmRhdGEgJiYgZXZlbnQuZGF0YS5tZXRob2QgPT09ICdsb2dpbkZpbmlzaGVkJykge1xuICAgICAgICB3aW4ubG9jYXRpb24ucmVsb2FkKCk7XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG5cbiAgaXBjUmVuZGVyZXIucmVtb3ZlQWxsTGlzdGVuZXJzKCdFTEVDVFJPTl9HVUVTVF9XSU5ET1dfUE9TVE1FU1NBR0UnKTtcbiAgaXBjUmVuZGVyZXIub24oJ0VMRUNUUk9OX0dVRVNUX1dJTkRPV19QT1NUTUVTU0FHRScsIChldmVudCwgc291cmNlSWQsIG1lc3NhZ2UsIHNvdXJjZU9yaWdpbikgPT4ge1xuICAgIGV2ZW50ID0gbmV3IE1lc3NhZ2VFdmVudCgnbWVzc2FnZScsIHsgZGF0YTogbWVzc2FnZSwgb3JpZ2luOiBzb3VyY2VPcmlnaW4gfSk7XG4gICAgZXZlbnQuc291cmNlID0gZ2V0T3JDcmVhdGVQcm94eShpcGNSZW5kZXJlciwgc291cmNlSWQpO1xuXG4gICAgd2luLmRpc3BhdGNoRXZlbnQoZXZlbnQpO1xuICB9KTtcbn07XG4iXX0=