const { ipcRenderer } = require('electron');
const url = require('url');
const Event = require('./event');
const constants = require('../../common/constants');
const { log } = require('../../common/utils');
const Port = require('./runtime/port');
let originResultID = 1;
class Runtime {
    constructor(context, extensionId, isBackgroundPage) {
        this.context = context;
        this.id = extensionId;
        this.isBackgroundPage = isBackgroundPage;
        this.onConnect = new Event();
        this.onMessage = new Event();
        this.onInstalled = new Event();
        this.onStartup = new Event();
        this.onUpdateAvailable = new Event();
        this.onSuspend = new Event();
        this.getURL = this.getURL.bind(this);
        this.getPlatformInfo = this.getPlatformInfo.bind(this);
        this.connect = this.connect.bind(this);
        this.sendMessage = this.sendMessage.bind(this);
        this.getManifest = this.getManifest.bind(this);
        this.setUninstallURL = this.setUninstallURL.bind(this);
    }
    getURL(path) {
        let canonicalPath = undefined;
        if (path) {
            if (path.startsWith('/')) {
                canonicalPath = path;
            }
            else {
                canonicalPath = `/${path}`;
            }
        }
        else {
            canonicalPath = '/';
        }
        return url.format({
            protocol: constants.EXTENSION_PROTOCOL,
            slashes: true,
            hostname: this.id,
            pathname: canonicalPath
        });
    }
    getPlatformInfo() {
        const archMapNodeChrome = {
            'arm': 'arm',
            'ia32': 'x86-32',
            'x64': 'x86-64'
        };
        const osMapNodeChrome = {
            'darwin': 'mac',
            'freebsd': 'openbsd',
            'linux': 'linux',
            'sunos': 'linux',
            'win32': 'win'
        };
        const arch = archMapNodeChrome[process.arch];
        const platform = osMapNodeChrome[process.platform];
        return {
            PlatformOs: platform,
            PlatformArch: arch,
            PlatformNaclArch: arch
        };
    }
    connect(...args) {
        if (this.isBackgroundPage) {
            console.error('chrome.runtime.connect is not supported in background page');
            return;
        }
        // Parse the optional args.
        let targetExtensionId = this.id;
        let connectInfo = { name: '' };
        if (args.length === 1) {
            connectInfo = args[0];
        }
        else if (args.length === 2) {
            [targetExtensionId, connectInfo] = args;
        }
        const url = window && window.location ? window.location.href : undefined;
        const { tabId, portId } = ipcRenderer.sendSync(constants.RUNTIME_CONNECT, targetExtensionId, connectInfo, url);
        return Port.get(this.context, tabId, portId, this.id, connectInfo.name);
    }
    sendMessage(...args) {
        if (this.isBackgroundPage) {
            console.error('chrome.runtime.sendMessage is not supported in background page');
            return;
        }
        // Parse the optional args.
        let targetExtensionId = this.id;
        let message;
        if (args.length === 1) {
            message = args[0];
        }
        else if (args.length === 2) {
            // A case of not provide extension-id: (message, responseCallback)
            if (typeof args[1] === 'function') {
                ipcRenderer.once(`${constants.RUNTIME_SENDMESSAGE_RESULT_}${originResultID}`, (event, result) => {
                    // log(`Runtime message result (runtime.js) #${originResultID}:`, args[0], result)
                    return args[1](result);
                });
                message = args[0];
            }
            else {
                [targetExtensionId, message] = args;
            }
        }
        else {
            console.error('options is not supported');
            ipcRenderer.once(`${constants.RUNTIME_SENDMESSAGE_RESULT_}${originResultID}`, (event, result) => args[2](result));
        }
        ipcRenderer.send(constants.RUNTIME_SENDMESSAGE, targetExtensionId, message, originResultID);
        originResultID++;
    }
    getManifest() {
        return ipcRenderer.sendSync(constants.RUNTIME_GET_MANIFEST, this.id);
    }
    setUninstallURL(url, callback) {
        if (callback)
            return callback;
    }
}
const store = new Map();
const getRuntime = (extensionId, isBackgroundPage) => {
    const key = `${extensionId}-${isBackgroundPage}`;
    if (store.has(key)) {
        return store.get(key);
    }
    else {
        const newRuntime = new Runtime(extensionId, isBackgroundPage);
        store.set(key, newRuntime);
        return newRuntime;
    }
};
exports.setup = (extensionId, isBackgroundPage) => getRuntime(extensionId, isBackgroundPage);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVudGltZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yZW5kZXJlci9hcGkvcnVudGltZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLEVBQUUsV0FBVyxFQUFFLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUUzQixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDakMsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDcEQsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQzlDLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0FBRXRDLElBQUksY0FBYyxHQUFHLENBQUMsQ0FBQTtBQUV0QixNQUFNLE9BQU87SUFFWCxZQUFZLE9BQU8sRUFBRSxXQUFXLEVBQUUsZ0JBQWdCO1FBQ2hELElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxFQUFFLEdBQUcsV0FBVyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUV6QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUE7UUFDNUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFBO1FBQzVCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQTtRQUM5QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksS0FBSyxFQUFFLENBQUE7UUFDNUIsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksS0FBSyxFQUFFLENBQUE7UUFDcEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEtBQUssRUFBRSxDQUFBO1FB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QUFBO0tBQ2xCO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsT0FBTyxDQUFDLEtBQUssR0FBRyxDQUFDLFdBQVcsRUFBRSxnQkFBZ0IsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBpcGNSZW5kZXJlciB9ID0gcmVxdWlyZSgnZWxlY3Ryb24nKTtcbmNvbnN0IHVybCA9IHJlcXVpcmUoJ3VybCcpO1xuXG5jb25zdCBFdmVudCA9IHJlcXVpcmUoJy4vZXZlbnQnKTtcbmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4uLy4uL2NvbW1vbi9jb25zdGFudHMnKTtcbmNvbnN0IHsgbG9nIH0gPSByZXF1aXJlKCcuLi8uLi9jb21tb24vdXRpbHMnKTtcbmNvbnN0IFBvcnQgPSByZXF1aXJlKCcuL3J1bnRpbWUvcG9ydCcpXG5cbmxldCBvcmlnaW5SZXN1bHRJRCA9IDFcblxuY2xhc3MgUnVudGltZSB7XG5cbiAgY29uc3RydWN0b3IoY29udGV4dCwgZXh0ZW5zaW9uSWQsIGlzQmFja2dyb3VuZFBhZ2UpIHtcbiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICAgIHRoaXMuaWQgPSBleHRlbnNpb25JZDtcbiAgICB0aGlzLmlzQmFja2dyb3VuZFBhZ2UgPSBpc0JhY2tncm91bmRQYWdlO1xuXG4gICAgdGhpcy5vbkNvbm5lY3QgPSBuZXcgRXZlbnQoKVxuICAgIHRoaXMub25NZXNzYWdlID0gbmV3IEV2ZW50KClcbiAgICB0aGlzLm9uSW5zdGFsbGVkID0gbmV3IEV2ZW50KClcbiAgICB0aGlzLm9uU3RhcnR1cCA9IG5ldyBFdmVudCgpXG4gICAgdGhpcy5vblVwZGF0ZUF2YWlsYWJsZSA9IG5ldyBFdmVudCgpXG4gICAgdGhpcy5vblN1c3BlbmQgPSBuZXcgRXZlbnQoKVxuXG4gICAgdGhpcy5nZXRVUkwgPSB0aGlzLmdldFVSTC5iaW5kKHRoaXMpXG4gICAgdGhpcy5nZXRQbGF0Zm9ybUluZm8gPSB0aGlzLmdldFBsYXRmb3JtSW5mby5iaW5kKHRoaXMpXG4gICAgdGhpcy5jb25uZWN0ID0gdGhpcy5jb25uZWN0LmJpbmQodGhpcylcbiAgICB0aGlzLnNlbmRNZXNzYWdlID0gdGhpcy5zZW5kTWVzc2FnZS5iaW5kKHRoaXMpXG4gICAgdGhpcy5nZXRNYW5pZmVzdCA9IHRoaXMuZ2V0TWFuaWZlc3QuYmluZCh0aGlzKVxuICAgIHRoaXMuc2V0VW5pbnN0YWxsVVJMID0gdGhpcy5zZXRVbmluc3RhbGxVUkwuYmluZCh0aGlzKVxuICB9XG5cbiAgZ2V0VVJMKHBhdGgpIHtcbiAgICBsZXQgY2Fub25pY2FsUGF0aCA9IHVuZGVmaW5lZDtcblxuICAgIGlmIChwYXRoKSB7XG4gICAgICBpZiAocGF0aC5zdGFydHNXaXRoKCcvJykpIHtcbiAgICAgICAgY2Fub25pY2FsUGF0aCA9IHBhdGg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjYW5vbmljYWxQYXRoID0gYC8ke3BhdGh9YDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY2Fub25pY2FsUGF0aCA9ICcvJztcbiAgICB9XG5cbiAgICByZXR1cm4gdXJsLmZvcm1hdCh7XG4gICAgICBwcm90b2NvbDogY29uc3RhbnRzLkVYVEVOU0lPTl9QUk9UT0NPTCxcbiAgICAgIHNsYXNoZXM6IHRydWUsXG4gICAgICBob3N0bmFtZTogdGhpcy5pZCxcbiAgICAgIHBhdGhuYW1lOiBjYW5vbmljYWxQYXRoXG4gICAgfSlcbiAgfVxuXG4gIGdldFBsYXRmb3JtSW5mbygpIHtcbiAgICBjb25zdCBhcmNoTWFwTm9kZUNocm9tZSA9IHtcbiAgICAgICdhcm0nOiAnYXJtJyxcbiAgICAgICdpYTMyJzogJ3g4Ni0zMicsXG4gICAgICAneDY0JzogJ3g4Ni02NCdcbiAgICB9XG4gICAgY29uc3Qgb3NNYXBOb2RlQ2hyb21lID0ge1xuICAgICAgJ2Rhcndpbic6ICdtYWMnLFxuICAgICAgJ2ZyZWVic2QnOiAnb3BlbmJzZCcsXG4gICAgICAnbGludXgnOiAnbGludXgnLFxuICAgICAgJ3N1bm9zJzogJ2xpbnV4JyxcbiAgICAgICd3aW4zMic6ICd3aW4nXG4gICAgfVxuXG4gICAgY29uc3QgYXJjaCA9IGFyY2hNYXBOb2RlQ2hyb21lW3Byb2Nlc3MuYXJjaF07XG4gICAgY29uc3QgcGxhdGZvcm0gPSBvc01hcE5vZGVDaHJvbWVbcHJvY2Vzcy5wbGF0Zm9ybV07XG4gICAgcmV0dXJuIHtcbiAgICAgIFBsYXRmb3JtT3M6IHBsYXRmb3JtLFxuICAgICAgUGxhdGZvcm1BcmNoOiBhcmNoLFxuICAgICAgUGxhdGZvcm1OYWNsQXJjaDogYXJjaFxuICAgIH1cbiAgfVxuXG4gIGNvbm5lY3QoLi4uYXJncykge1xuICAgIGlmICh0aGlzLmlzQmFja2dyb3VuZFBhZ2UpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2Nocm9tZS5ydW50aW1lLmNvbm5lY3QgaXMgbm90IHN1cHBvcnRlZCBpbiBiYWNrZ3JvdW5kIHBhZ2UnKVxuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgLy8gUGFyc2UgdGhlIG9wdGlvbmFsIGFyZ3MuXG4gICAgbGV0IHRhcmdldEV4dGVuc2lvbklkID0gdGhpcy5pZFxuICAgIGxldCBjb25uZWN0SW5mbyA9IHsgbmFtZTogJycgfVxuICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgY29ubmVjdEluZm8gPSBhcmdzWzBdXG4gICAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xuICAgICAgW3RhcmdldEV4dGVuc2lvbklkLCBjb25uZWN0SW5mb10gPSBhcmdzXG4gICAgfVxuXG4gICAgY29uc3QgdXJsID0gd2luZG93ICYmIHdpbmRvdy5sb2NhdGlvbiA/IHdpbmRvdy5sb2NhdGlvbi5ocmVmIDogdW5kZWZpbmVkO1xuICAgIGNvbnN0IHsgdGFiSWQsIHBvcnRJZCB9ID0gaXBjUmVuZGVyZXIuc2VuZFN5bmMoY29uc3RhbnRzLlJVTlRJTUVfQ09OTkVDVCwgdGFyZ2V0RXh0ZW5zaW9uSWQsIGNvbm5lY3RJbmZvLCB1cmwpXG4gICAgcmV0dXJuIFBvcnQuZ2V0KHRoaXMuY29udGV4dCwgdGFiSWQsIHBvcnRJZCwgdGhpcy5pZCwgY29ubmVjdEluZm8ubmFtZSlcbiAgfVxuXG4gIHNlbmRNZXNzYWdlKC4uLmFyZ3MpIHtcbiAgICBpZiAodGhpcy5pc0JhY2tncm91bmRQYWdlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZSBpcyBub3Qgc3VwcG9ydGVkIGluIGJhY2tncm91bmQgcGFnZScpXG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICAvLyBQYXJzZSB0aGUgb3B0aW9uYWwgYXJncy5cbiAgICBsZXQgdGFyZ2V0RXh0ZW5zaW9uSWQgPSB0aGlzLmlkXG4gICAgbGV0IG1lc3NhZ2VcbiAgICBpZiAoYXJncy5sZW5ndGggPT09IDEpIHtcbiAgICAgIG1lc3NhZ2UgPSBhcmdzWzBdXG4gICAgfSBlbHNlIGlmIChhcmdzLmxlbmd0aCA9PT0gMikge1xuICAgICAgLy8gQSBjYXNlIG9mIG5vdCBwcm92aWRlIGV4dGVuc2lvbi1pZDogKG1lc3NhZ2UsIHJlc3BvbnNlQ2FsbGJhY2spXG4gICAgICBpZiAodHlwZW9mIGFyZ3NbMV0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgaXBjUmVuZGVyZXIub25jZShgJHtjb25zdGFudHMuUlVOVElNRV9TRU5ETUVTU0FHRV9SRVNVTFRffSR7b3JpZ2luUmVzdWx0SUR9YCwgKGV2ZW50LCByZXN1bHQpID0+IHtcbiAgICAgICAgICAvLyBsb2coYFJ1bnRpbWUgbWVzc2FnZSByZXN1bHQgKHJ1bnRpbWUuanMpICMke29yaWdpblJlc3VsdElEfTpgLCBhcmdzWzBdLCByZXN1bHQpXG4gICAgICAgICAgcmV0dXJuIGFyZ3NbMV0ocmVzdWx0KTtcbiAgICAgICAgfSlcbiAgICAgICAgbWVzc2FnZSA9IGFyZ3NbMF1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIFt0YXJnZXRFeHRlbnNpb25JZCwgbWVzc2FnZV0gPSBhcmdzXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ29wdGlvbnMgaXMgbm90IHN1cHBvcnRlZCcpXG4gICAgICBpcGNSZW5kZXJlci5vbmNlKGAke2NvbnN0YW50cy5SVU5USU1FX1NFTkRNRVNTQUdFX1JFU1VMVF99JHtvcmlnaW5SZXN1bHRJRH1gLCAoZXZlbnQsIHJlc3VsdCkgPT4gYXJnc1syXShyZXN1bHQpKVxuICAgIH1cblxuICAgIGlwY1JlbmRlcmVyLnNlbmQoY29uc3RhbnRzLlJVTlRJTUVfU0VORE1FU1NBR0UsIHRhcmdldEV4dGVuc2lvbklkLCBtZXNzYWdlLCBvcmlnaW5SZXN1bHRJRClcbiAgICBvcmlnaW5SZXN1bHRJRCsrXG4gIH1cblxuICBnZXRNYW5pZmVzdCgpIHtcbiAgICByZXR1cm4gaXBjUmVuZGVyZXIuc2VuZFN5bmMoY29uc3RhbnRzLlJVTlRJTUVfR0VUX01BTklGRVNULCB0aGlzLmlkKVxuICB9XG5cbiAgc2V0VW5pbnN0YWxsVVJMKHVybCwgY2FsbGJhY2spIHtcbiAgICBpZiAoY2FsbGJhY2spXG4gICAgICByZXR1cm4gY2FsbGJhY2tcbiAgfVxufVxuXG5jb25zdCBzdG9yZSA9IG5ldyBNYXAoKTtcblxuY29uc3QgZ2V0UnVudGltZSA9IChleHRlbnNpb25JZCwgaXNCYWNrZ3JvdW5kUGFnZSkgPT4ge1xuICBjb25zdCBrZXkgPSBgJHtleHRlbnNpb25JZH0tJHtpc0JhY2tncm91bmRQYWdlfWA7XG5cbiAgaWYgKHN0b3JlLmhhcyhrZXkpKSB7XG4gICAgcmV0dXJuIHN0b3JlLmdldChrZXkpXG4gIH0gZWxzZSB7XG4gICAgY29uc3QgbmV3UnVudGltZSA9IG5ldyBSdW50aW1lKGV4dGVuc2lvbklkLCBpc0JhY2tncm91bmRQYWdlKVxuICAgIHN0b3JlLnNldChrZXksIG5ld1J1bnRpbWUpXG4gICAgcmV0dXJuIG5ld1J1bnRpbWVcbiAgfVxufVxuXG5leHBvcnRzLnNldHVwID0gKGV4dGVuc2lvbklkLCBpc0JhY2tncm91bmRQYWdlKSA9PiBnZXRSdW50aW1lKGV4dGVuc2lvbklkLCBpc0JhY2tncm91bmRQYWdlKVxuIl19