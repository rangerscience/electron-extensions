const { ipcRenderer } = require('electron');
const constants = require('../common/constants');
const { log } = require('../common/utils');
const Event = require('./api/event');
const loggingProxy = require('./logging-proxy').default;
const MessageSender = require('./api/runtime/message-sender');
const Tab = require('./api/runtime/tab');
const Port = require('./api/runtime/port');
const subscribeAndForwardEvents = require('./event-dispatcher').default;
let nextId = 0;
// Inject chrome API to the |context|
exports.injectTo = function (extensionId, isBackgroundPage, context) {
    let chrome;
    if (context) {
        context.chrome ? context.chrome : context.chrome = {};
        chrome = context.chrome;
    }
    else {
        chrome = {};
    }
    // Maintain ports references for debug purpose
    context.__ports = new Map();
    chrome.runtime = require('./api/runtime').setup(context, extensionId, isBackgroundPage);
    chrome.storage = require('./api/storage').setup(extensionId);
    chrome.browserAction = require('./api/browser-action').setup(extensionId);
    chrome.notifications = require('./api/notifications').setup(extensionId);
    chrome.webRequest = require('./api/web-request').setup(extensionId);
    chrome.i18n = require('./api/i18n').setup(extensionId);
    chrome.webNavigation = require('./api/web-navigation').setup();
    chrome.omnibox = require('./api/omnibox').setup(extensionId);
    chrome.windows = require('./api/windows').default(extensionId);
    chrome.extension = {
        getURL: (...args) => chrome.runtime.getURL(...args),
        getPlatformInfo: (...args) => chrome.runtime.getPlatformInfo(...args),
        connect: (...args) => chrome.runtime.connect(...args),
        sendMessage: (...args) => chrome.runtime.sendMessage(...args),
        isAllowedIncognitoAccess: () => false,
        onConnect: chrome.runtime.onConnect,
        onMessage: chrome.runtime.onMessage,
    };
    chrome.contextMenus = {
        create: function () { return {}; },
        update: function () { return {}; },
        remove: function () { return {}; },
        removeAll: function () { return {}; },
        onClicked: new Event()
    };
    chrome.tabs = {
        executeScript(tabId, details, callback) {
            const requestId = ++nextId;
            ipcRenderer.once(`${constants.TABS_EXECUTESCRIPT_RESULT_}${requestId}`, (event, result) => {
                callback([event.result]);
            });
            ipcRenderer.send(constants.TABS_EXECUTESCRIPT, requestId, tabId, extensionId, details);
        },
        sendMessage(tabId, message, options, responseCallback) {
            if (responseCallback) {
                ipcRenderer.on(`${constants.TABS_SEND_MESSAGE_RESULT_}${chrome.runtime.originResultID}`, (event, result) => responseCallback(result));
            }
            ipcRenderer.send(constants.TABS_SEND_MESSAGE, tabId, extensionId, isBackgroundPage, message, chrome.runtime.originResultID);
            chrome.runtime.incrementOriginResultID();
        },
        insertCSS(tabId, details, cb) {
            if (cb)
                cb();
        },
        get(tabId, cb) {
            const requestId = ++nextId;
            ipcRenderer.once(`${constants.TABS_GET_RESULT_}${requestId}`, (event, result) => {
                cb(result);
            });
            ipcRenderer.send(constants.TABS_GET, requestId, extensionId, tabId);
        },
        getCurrent() {
        },
        create(details, cb) {
            cb && cb();
        },
        query(args, cb) {
            const requestId = ++nextId;
            ipcRenderer.once(`${constants.TABS_QUERY_RESULT_}${requestId}`, (event, result) => {
                cb(result);
            });
            ipcRenderer.send(constants.TABS_QUERY, requestId, extensionId);
        },
        onUpdated: new Event(),
        onCreated: new Event(),
        onRemoved: new Event(),
        onActivated: new Event(),
    };
    chrome.pageAction = {
        show() { },
        hide() { },
        setTitle() { },
        getTitle() { },
        setIcon() { },
        setPopup() { },
        getPopup() { }
    };
    chrome.cookies = require('./api/cookies').default(extensionId);
    ipcRenderer.on(`${constants.RUNTIME_ONCONNECT_}${extensionId}`, (event, tabId, portId, connectInfo, url) => {
        chrome.runtime.onConnect.emit(Port.get(context, tabId, portId, extensionId, connectInfo.name, url));
    });
    ipcRenderer.on(`${constants.RUNTIME_ONMESSAGE_}${extensionId}`, (event, tabId, message, resultID) => {
        chrome.runtime.onMessage.emit(message, new MessageSender({ tabId, extensionId }), (messageResult) => {
            // log(`Runtime message result (chrome-api.js) #${resultID}:`, message, messageResult)
            ipcRenderer.send(`${constants.RUNTIME_ONMESSAGE_RESULT_}${resultID}`, messageResult);
        });
    });
    ipcRenderer.on(constants.TABS_ONCREATED, (event, tabId) => {
        chrome.tabs.onCreated.emit(new Tab(tabId));
    });
    ipcRenderer.on(constants.TABS_ONREMOVED, (event, tabId) => {
        chrome.tabs.onRemoved.emit(tabId);
    });
    chrome.runtime.onInstalled.emit({ reason: 'install' });
    subscribeAndForwardEvents(chrome);
    return chrome;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hyb21lLWFwaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZW5kZXJlci9jaHJvbWUtYXBpLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sRUFBRSxXQUFXLEVBQUUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFFNUMsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDakQsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzNDLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUNyQyxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDeEQsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLDhCQUE4QixDQUFDLENBQUM7QUFDOUQsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFDekMsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDM0MsTUFBTSx5QkFBeUIsR0FBRyxPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFFeEUsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO0FBRWYscUNBQXFDO0FBQ3JDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsVUFBVSxXQUFXLEVBQUUsZ0JBQWdCLEVBQUUsT0FBTztJQUNqRSxJQUFJLE1BQU0sQ0FBQztJQUVYLElBQUksT0FBTyxFQUFFO1FBQ1gsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUE7UUFDckQsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUE7S0FDeEI7U0FBTTtRQUNMLE1BQU0sR0FBRyxFQUFFLENBQUE7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QUM7SUFFSCxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUV2RCx5QkFBeUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUVsQyxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IGlwY1JlbmRlcmVyIH0gPSByZXF1aXJlKCdlbGVjdHJvbicpO1xuXG5jb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuLi9jb21tb24vY29uc3RhbnRzJyk7XG5jb25zdCB7IGxvZyB9ID0gcmVxdWlyZSgnLi4vY29tbW9uL3V0aWxzJyk7XG5jb25zdCBFdmVudCA9IHJlcXVpcmUoJy4vYXBpL2V2ZW50Jyk7XG5jb25zdCBsb2dnaW5nUHJveHkgPSByZXF1aXJlKCcuL2xvZ2dpbmctcHJveHknKS5kZWZhdWx0O1xuY29uc3QgTWVzc2FnZVNlbmRlciA9IHJlcXVpcmUoJy4vYXBpL3J1bnRpbWUvbWVzc2FnZS1zZW5kZXInKTtcbmNvbnN0IFRhYiA9IHJlcXVpcmUoJy4vYXBpL3J1bnRpbWUvdGFiJyk7XG5jb25zdCBQb3J0ID0gcmVxdWlyZSgnLi9hcGkvcnVudGltZS9wb3J0Jyk7XG5jb25zdCBzdWJzY3JpYmVBbmRGb3J3YXJkRXZlbnRzID0gcmVxdWlyZSgnLi9ldmVudC1kaXNwYXRjaGVyJykuZGVmYXVsdDtcblxubGV0IG5leHRJZCA9IDA7XG5cbi8vIEluamVjdCBjaHJvbWUgQVBJIHRvIHRoZSB8Y29udGV4dHxcbmV4cG9ydHMuaW5qZWN0VG8gPSBmdW5jdGlvbiAoZXh0ZW5zaW9uSWQsIGlzQmFja2dyb3VuZFBhZ2UsIGNvbnRleHQpIHtcbiAgbGV0IGNocm9tZTtcblxuICBpZiAoY29udGV4dCkge1xuICAgIGNvbnRleHQuY2hyb21lID8gY29udGV4dC5jaHJvbWUgOiBjb250ZXh0LmNocm9tZSA9IHt9XG4gICAgY2hyb21lID0gY29udGV4dC5jaHJvbWVcbiAgfSBlbHNlIHtcbiAgICBjaHJvbWUgPSB7fVxuICB9XG5cbiAgLy8gTWFpbnRhaW4gcG9ydHMgcmVmZXJlbmNlcyBmb3IgZGVidWcgcHVycG9zZVxuICBjb250ZXh0Ll9fcG9ydHMgPSBuZXcgTWFwKCk7XG5cbiAgY2hyb21lLnJ1bnRpbWUgPSByZXF1aXJlKCcuL2FwaS9ydW50aW1lJykuc2V0dXAoY29udGV4dCwgZXh0ZW5zaW9uSWQsIGlzQmFja2dyb3VuZFBhZ2UpO1xuICBjaHJvbWUuc3RvcmFnZSA9IHJlcXVpcmUoJy4vYXBpL3N0b3JhZ2UnKS5zZXR1cChleHRlbnNpb25JZCk7XG4gIGNocm9tZS5icm93c2VyQWN0aW9uID0gcmVxdWlyZSgnLi9hcGkvYnJvd3Nlci1hY3Rpb24nKS5zZXR1cChleHRlbnNpb25JZCk7XG4gIGNocm9tZS5ub3RpZmljYXRpb25zID0gcmVxdWlyZSgnLi9hcGkvbm90aWZpY2F0aW9ucycpLnNldHVwKGV4dGVuc2lvbklkKTtcbiAgY2hyb21lLndlYlJlcXVlc3QgPSByZXF1aXJlKCcuL2FwaS93ZWItcmVxdWVzdCcpLnNldHVwKGV4dGVuc2lvbklkKTtcbiAgY2hyb21lLmkxOG4gPSByZXF1aXJlKCcuL2FwaS9pMThuJykuc2V0dXAoZXh0ZW5zaW9uSWQpO1xuICBjaHJvbWUud2ViTmF2aWdhdGlvbiA9IHJlcXVpcmUoJy4vYXBpL3dlYi1uYXZpZ2F0aW9uJykuc2V0dXAoKTtcbiAgY2hyb21lLm9tbmlib3ggPSByZXF1aXJlKCcuL2FwaS9vbW5pYm94Jykuc2V0dXAoZXh0ZW5zaW9uSWQpO1xuICBjaHJvbWUud2luZG93cyA9IHJlcXVpcmUoJy4vYXBpL3dpbmRvd3MnKS5kZWZhdWx0KGV4dGVuc2lvbklkKTtcblxuICBjaHJvbWUuZXh0ZW5zaW9uID0ge1xuICAgIGdldFVSTDogKC4uLmFyZ3MpID0+IGNocm9tZS5ydW50aW1lLmdldFVSTCguLi5hcmdzKSxcbiAgICBnZXRQbGF0Zm9ybUluZm86ICguLi5hcmdzKSA9PiBjaHJvbWUucnVudGltZS5nZXRQbGF0Zm9ybUluZm8oLi4uYXJncyksXG4gICAgY29ubmVjdDogKC4uLmFyZ3MpID0+IGNocm9tZS5ydW50aW1lLmNvbm5lY3QoLi4uYXJncyksXG4gICAgc2VuZE1lc3NhZ2U6ICguLi5hcmdzKSA9PiBjaHJvbWUucnVudGltZS5zZW5kTWVzc2FnZSguLi5hcmdzKSxcbiAgICBpc0FsbG93ZWRJbmNvZ25pdG9BY2Nlc3M6ICgpID0+IGZhbHNlLFxuICAgIG9uQ29ubmVjdDogY2hyb21lLnJ1bnRpbWUub25Db25uZWN0LFxuICAgIG9uTWVzc2FnZTogY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLFxuICB9O1xuXG4gIGNocm9tZS5jb250ZXh0TWVudXMgPSB7XG4gICAgY3JlYXRlOiBmdW5jdGlvbiAoKSB7IHJldHVybiB7fSB9LFxuICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgeyByZXR1cm4ge30gfSxcbiAgICByZW1vdmU6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHt9IH0sXG4gICAgcmVtb3ZlQWxsOiBmdW5jdGlvbiAoKSB7IHJldHVybiB7fSB9LFxuICAgIG9uQ2xpY2tlZDogbmV3IEV2ZW50KClcbiAgfTtcblxuICBjaHJvbWUudGFicyA9IHtcbiAgICBleGVjdXRlU2NyaXB0KHRhYklkLCBkZXRhaWxzLCBjYWxsYmFjaykge1xuICAgICAgY29uc3QgcmVxdWVzdElkID0gKytuZXh0SWQ7XG4gICAgICBpcGNSZW5kZXJlci5vbmNlKGAke2NvbnN0YW50cy5UQUJTX0VYRUNVVEVTQ1JJUFRfUkVTVUxUX30ke3JlcXVlc3RJZH1gLCAoZXZlbnQsIHJlc3VsdCkgPT4ge1xuICAgICAgICBjYWxsYmFjayhbZXZlbnQucmVzdWx0XSk7XG4gICAgICB9KTtcbiAgICAgIGlwY1JlbmRlcmVyLnNlbmQoY29uc3RhbnRzLlRBQlNfRVhFQ1VURVNDUklQVCwgcmVxdWVzdElkLCB0YWJJZCwgZXh0ZW5zaW9uSWQsIGRldGFpbHMpXG4gICAgfSxcblxuICAgIHNlbmRNZXNzYWdlKHRhYklkLCBtZXNzYWdlLCBvcHRpb25zLCByZXNwb25zZUNhbGxiYWNrKSB7XG4gICAgICBpZiAocmVzcG9uc2VDYWxsYmFjaykge1xuICAgICAgICBpcGNSZW5kZXJlci5vbihgJHtjb25zdGFudHMuVEFCU19TRU5EX01FU1NBR0VfUkVTVUxUX30ke2Nocm9tZS5ydW50aW1lLm9yaWdpblJlc3VsdElEfWAsIChldmVudCwgcmVzdWx0KSA9PiByZXNwb25zZUNhbGxiYWNrKHJlc3VsdCkpO1xuICAgICAgfVxuICAgICAgaXBjUmVuZGVyZXIuc2VuZChjb25zdGFudHMuVEFCU19TRU5EX01FU1NBR0UsIHRhYklkLCBleHRlbnNpb25JZCwgaXNCYWNrZ3JvdW5kUGFnZSwgbWVzc2FnZSwgY2hyb21lLnJ1bnRpbWUub3JpZ2luUmVzdWx0SUQpO1xuICAgICAgY2hyb21lLnJ1bnRpbWUuaW5jcmVtZW50T3JpZ2luUmVzdWx0SUQoKVxuICAgIH0sXG5cbiAgICBpbnNlcnRDU1ModGFiSWQsIGRldGFpbHMsIGNiKSB7XG4gICAgICBpZiAoY2IpIGNiKCk7XG4gICAgfSxcblxuICAgIGdldCh0YWJJZCwgY2IpIHtcbiAgICAgIGNvbnN0IHJlcXVlc3RJZCA9ICsrbmV4dElkO1xuICAgICAgaXBjUmVuZGVyZXIub25jZShgJHtjb25zdGFudHMuVEFCU19HRVRfUkVTVUxUX30ke3JlcXVlc3RJZH1gLCAoZXZlbnQsIHJlc3VsdCkgPT4ge1xuICAgICAgICBjYihyZXN1bHQpO1xuICAgICAgfSk7XG5cbiAgICAgIGlwY1JlbmRlcmVyLnNlbmQoY29uc3RhbnRzLlRBQlNfR0VULCByZXF1ZXN0SWQsIGV4dGVuc2lvbklkLCB0YWJJZCk7XG4gICAgfSxcblxuICAgIGdldEN1cnJlbnQoKSB7XG4gICAgfSxcblxuICAgIGNyZWF0ZShkZXRhaWxzLCBjYikge1xuICAgICAgY2IgJiYgY2IoKTtcbiAgICB9LFxuXG4gICAgcXVlcnkoYXJncywgY2IpIHtcbiAgICAgIGNvbnN0IHJlcXVlc3RJZCA9ICsrbmV4dElkO1xuICAgICAgaXBjUmVuZGVyZXIub25jZShgJHtjb25zdGFudHMuVEFCU19RVUVSWV9SRVNVTFRffSR7cmVxdWVzdElkfWAsIChldmVudCwgcmVzdWx0KSA9PiB7XG4gICAgICAgIGNiKHJlc3VsdCk7XG4gICAgICB9KTtcblxuICAgICAgaXBjUmVuZGVyZXIuc2VuZChjb25zdGFudHMuVEFCU19RVUVSWSwgcmVxdWVzdElkLCBleHRlbnNpb25JZCk7XG4gICAgfSxcblxuICAgIG9uVXBkYXRlZDogbmV3IEV2ZW50KCksXG4gICAgb25DcmVhdGVkOiBuZXcgRXZlbnQoKSxcbiAgICBvblJlbW92ZWQ6IG5ldyBFdmVudCgpLFxuICAgIG9uQWN0aXZhdGVkOiBuZXcgRXZlbnQoKSxcbiAgfTtcblxuICBjaHJvbWUucGFnZUFjdGlvbiA9IHtcbiAgICBzaG93KCkgeyB9LFxuICAgIGhpZGUoKSB7IH0sXG4gICAgc2V0VGl0bGUoKSB7IH0sXG4gICAgZ2V0VGl0bGUoKSB7IH0sXG4gICAgc2V0SWNvbigpIHsgfSxcbiAgICBzZXRQb3B1cCgpIHsgfSxcbiAgICBnZXRQb3B1cCgpIHsgfVxuICB9O1xuXG4gIGNocm9tZS5jb29raWVzID0gcmVxdWlyZSgnLi9hcGkvY29va2llcycpLmRlZmF1bHQoZXh0ZW5zaW9uSWQpO1xuXG4gIGlwY1JlbmRlcmVyLm9uKGAke2NvbnN0YW50cy5SVU5USU1FX09OQ09OTkVDVF99JHtleHRlbnNpb25JZH1gLCAoZXZlbnQsIHRhYklkLCBwb3J0SWQsIGNvbm5lY3RJbmZvLCB1cmwpID0+IHtcbiAgICBjaHJvbWUucnVudGltZS5vbkNvbm5lY3QuZW1pdChQb3J0LmdldChjb250ZXh0LCB0YWJJZCwgcG9ydElkLCBleHRlbnNpb25JZCwgY29ubmVjdEluZm8ubmFtZSwgdXJsKSlcbiAgfSk7XG5cbiAgaXBjUmVuZGVyZXIub24oYCR7Y29uc3RhbnRzLlJVTlRJTUVfT05NRVNTQUdFX30ke2V4dGVuc2lvbklkfWAsIChldmVudCwgdGFiSWQsIG1lc3NhZ2UsIHJlc3VsdElEKSA9PiB7XG4gICAgY2hyb21lLnJ1bnRpbWUub25NZXNzYWdlLmVtaXQobWVzc2FnZSwgbmV3IE1lc3NhZ2VTZW5kZXIoeyB0YWJJZCwgZXh0ZW5zaW9uSWQgfSksIChtZXNzYWdlUmVzdWx0KSA9PiB7XG4gICAgICAvLyBsb2coYFJ1bnRpbWUgbWVzc2FnZSByZXN1bHQgKGNocm9tZS1hcGkuanMpICMke3Jlc3VsdElEfTpgLCBtZXNzYWdlLCBtZXNzYWdlUmVzdWx0KVxuICAgICAgaXBjUmVuZGVyZXIuc2VuZChgJHtjb25zdGFudHMuUlVOVElNRV9PTk1FU1NBR0VfUkVTVUxUX30ke3Jlc3VsdElEfWAsIG1lc3NhZ2VSZXN1bHQpXG4gICAgfSlcbiAgfSk7XG5cbiAgaXBjUmVuZGVyZXIub24oY29uc3RhbnRzLlRBQlNfT05DUkVBVEVELCAoZXZlbnQsIHRhYklkKSA9PiB7XG4gICAgY2hyb21lLnRhYnMub25DcmVhdGVkLmVtaXQobmV3IFRhYih0YWJJZCkpXG4gIH0pO1xuXG4gIGlwY1JlbmRlcmVyLm9uKGNvbnN0YW50cy5UQUJTX09OUkVNT1ZFRCwgKGV2ZW50LCB0YWJJZCkgPT4ge1xuICAgIGNocm9tZS50YWJzLm9uUmVtb3ZlZC5lbWl0KHRhYklkKVxuICB9KTtcblxuICBjaHJvbWUucnVudGltZS5vbkluc3RhbGxlZC5lbWl0KHsgcmVhc29uOiAnaW5zdGFsbCcgfSk7XG5cbiAgc3Vic2NyaWJlQW5kRm9yd2FyZEV2ZW50cyhjaHJvbWUpO1xuXG4gIHJldHVybiBjaHJvbWU7XG59O1xuIl19