"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const xml_js_1 = require("xml-js");
class InterpreterProvider {
    static parseVersion(version) {
        const split = version.split('.');
        const parsed = split.map((elem) => parseInt(elem, 10));
        return {
            number: version,
            parsed,
        };
    }
    interpret(installed) {
        const { id, location, manifest: { update_url, version, }, } = installed;
        const parsedVersion = InterpreterProvider.parseVersion(version);
        return {
            id,
            location,
            version: parsedVersion,
            updateUrl: update_url,
        };
    }
    shouldUpdate(extension, updateInfos) {
        const parsedUpdates = this.readUpdateManifest(updateInfos.xml);
        const updateCheck = this.findUpdate(extension.id, parsedUpdates);
        if (!updateCheck) {
            return false;
        }
        const newVersion = this.getNewVersion(updateCheck);
        if (newVersion) {
            return this.greaterThan(newVersion, extension.version);
        }
        return false;
    }
    sortLastVersion(versions) {
        const noVersion = { number: '', parsed: [] };
        const highest = versions.reduce((previous, value) => {
            const greater = this.greaterThan(value, previous);
            return (greater) ? value : previous;
        }, noVersion);
        if (highest === noVersion) {
            throw new Error('No versions could be read and found');
        }
        return highest;
    }
    readUpdateManifest(xml) {
        return xml_js_1.xml2js(xml, { compact: false });
    }
    // todo: Improve the "any"
    findUpdate(extensionId, parsedUpdates) {
        const updates = this.getNested(parsedUpdates, ['elements', '0', 'elements']);
        if (!updates)
            return undefined;
        for (const update of updates) {
            if (extensionId === update.attributes.appid) {
                return update;
            }
        }
        return undefined;
    }
    getNewVersion(updateCheck) {
        const version = this.getNested(updateCheck, ['elements', '0', 'attributes', 'version']);
        if (!version) {
            return; // no update available
        }
        return InterpreterProvider.parseVersion(version);
    }
    greaterThan(a, b) {
        const x = a.parsed;
        const y = b.parsed;
        // Compare each digit of the version
        for (let i = 0; i < x.length; i = i + 1) {
            // The order of the rules is important
            if (isNaN(x[i]))
                return false; // If A[i] is not a number, then A cannot be higher or whatever
            if (y[i] === undefined)
                return true; // If B[i] has no value when A[i] has one, A is higher
            if (x[i] < y[i])
                return false; // If A[i] is lower than B[i], then A is not higher
            if (x[i] > y[i])
                return true; // If A[i] is higher than B[i], then A is higher
            // If none of the rules returned, then the numbers are equal, go to the next step
        }
        return false;
    }
    getNested(nestedObj, pathArr) {
        return pathArr.reduce((obj, key) => {
            return (obj && obj[key]) ? obj[key] : undefined;
        }, nestedObj);
    }
}
exports.default = InterpreterProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW50ZXJwcmV0ZXItcHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYnJvd3Nlci9mZXRjaGVyL2ludGVycHJldGVyLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQWdDO0FBYWhDLE1BQXFCLG1CQUFtQjtJQUMvQixNQUFNLENBQUMsWUFBWSxDQUFDLE9BQWU7UUFDeEMsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNqQyxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBWSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFL0QsT0FBTztZQUNMLE1BQU0sRUFBRSxPQUFPO1lBQ2YsTUFBTTtTQUNQLENBQUM7SUFDSixDQUFDO0lBRUQsU0FBUyxDQUFDLFNBQW1CO1FBQzNCLE1BQU0sRUFDSixFQUFFLEVBQ0YsUUFBUSxFQUNSLFFBQVEsRUFBRSxFQUNSLFVBQVUsRUFDVixPQUFPLEdBQ1IsR0FDRixHQUFHLFNBQVMsQ0FBQztRQUVkLE1BQU0sYUFBYSxHQUFHLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVoRSxPQUFPO1lBQ0wsRUFBRTtZQUNGLFFBQVE7WUFDUixPQUFPLEVBQUUsYUFBYTtZQUN0QixTQUFTLEVBQUUsVUFBVTtTQUN0QixDQUFDO0lBQ0osQ0FBQztJQUVELFlBQVksQ0FBQyxTQUFxQixFQUFFLFdBQW9CO1FBQ3RELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRWpFLElBQUksQ0FBQyxXQUFXLEVB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LElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQUUsT0FBTyxJQUFJLENBQUMsQ0FBUyxnREFBZ0Q7WUFDdEYsaUZBQWlGO1NBQ2xGO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRU8sU0FBUyxDQUFDLFNBQWlCLEVBQUUsT0FBaUI7UUFDcEQsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUNuQixDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNYLE9BQU8sQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ2xELENBQUMsRUFDRCxTQUFTLENBQ1YsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQXRIRCxzQ0FzSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB4bWwyanMgfSBmcm9tICd4bWwtanMnO1xuXG5pbXBvcnQge1xuICBJRXh0ZW5zaW9uLFxuICBJVmVyc2lvbixcbn0gZnJvbSAnLi4vLi4vY29tbW9uL3R5cGVzJztcblxuaW1wb3J0IHtcbiAgSUludGVycHJldGVyUHJvdmlkZXIsXG4gIElJbnN0YWxsLFxuICBJVXBkYXRlLFxufSBmcm9tICcuL3R5cGVzJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW50ZXJwcmV0ZXJQcm92aWRlciBpbXBsZW1lbnRzIElJbnRlcnByZXRlclByb3ZpZGVyIHtcbiAgcHVibGljIHN0YXRpYyBwYXJzZVZlcnNpb24odmVyc2lvbjogc3RyaW5nKSB7XG4gICAgY29uc3Qgc3BsaXQgPSB2ZXJzaW9uLnNwbGl0KCcuJyk7XG4gICAgY29uc3QgcGFyc2VkID0gc3BsaXQubWFwKChlbGVtOiBzdHJpbmcpID0+IHBhcnNlSW50KGVsZW0sIDEwKSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbnVtYmVyOiB2ZXJzaW9uLFxuICAgICAgcGFyc2VkLFxuICAgIH07XG4gIH1cblxuICBpbnRlcnByZXQoaW5zdGFsbGVkOiBJSW5zdGFsbCkge1xuICAgIGNvbnN0IHtcbiAgICAgIGlkLFxuICAgICAgbG9jYXRpb24sXG4gICAgICBtYW5pZmVzdDoge1xuICAgICAgICB1cGRhdGVfdXJsLFxuICAgICAgICB2ZXJzaW9uLFxuICAgICAgfSxcbiAgICB9ID0gaW5zdGFsbGVkO1xuXG4gICAgY29uc3QgcGFyc2VkVmVyc2lvbiA9IEludGVycHJldGVyUHJvdmlkZXIucGFyc2VWZXJzaW9uKHZlcnNpb24pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGlkLFxuICAgICAgbG9jYXRpb24sXG4gICAgICB2ZXJzaW9uOiBwYXJzZWRWZXJzaW9uLFxuICAgICAgdXBkYXRlVXJsOiB1cGRhdGVfdXJsLFxuICAgIH07XG4gIH1cblxuICBzaG91bGRVcGRhdGUoZXh0ZW5zaW9uOiBJRXh0ZW5zaW9uLCB1cGRhdGVJbmZvczogSVVwZGF0ZSkge1xuICAgIGNvbnN0IHBhcnNlZFVwZGF0ZXMgPSB0aGlzLnJlYWRVcGRhdGVNYW5pZmVzdCh1cGRhdGVJbmZvcy54bWwpO1xuICAgIGNvbnN0IHVwZGF0ZUNoZWNrID0gdGhpcy5maW5kVXBkYXRlKGV4dGVuc2lvbi5pZCwgcGFyc2VkVXBkYXRlcyk7XG5cbiAgICBpZiAoIXVwZGF0ZUNoZWNrKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgbmV3VmVyc2lvbiA9IHRoaXMuZ2V0TmV3VmVyc2lvbih1cGRhdGVDaGVjayk7XG5cbiAgICBpZiAobmV3VmVyc2lvbikge1xuICAgICAgcmV0dXJuIHRoaXMuZ3JlYXRlclRoYW4obmV3VmVyc2lvbiwgZXh0ZW5zaW9uLnZlcnNpb24pO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHNvcnRMYXN0VmVyc2lvbih2ZXJzaW9uczogSVZlcnNpb25bXSkge1xuICAgIGNvbnN0IG5vVmVyc2lvbiA9IHsgbnVtYmVyOiAnJywgcGFyc2VkOiBbXSB9O1xuICAgIGNvbnN0IGhpZ2hlc3QgPSB2ZXJzaW9ucy5yZWR1Y2UoXG4gICAgICAocHJldmlvdXMsIHZhbHVlKSA9PiB7XG4gICAgICAgIGNvbnN0IGdyZWF0ZXIgPSB0aGlzLmdyZWF0ZXJUaGFuKHZhbHVlLCBwcmV2aW91cyk7XG4gICAgICAgIHJldHVybiAoZ3JlYXRlcikgPyB2YWx1ZSA6IHByZXZpb3VzO1xuICAgICAgfSxcbiAgICAgIG5vVmVyc2lvblxuICAgICk7XG5cbiAgICBpZiAoaGlnaGVzdCA9PT0gbm9WZXJzaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHZlcnNpb25zIGNvdWxkIGJlIHJlYWQgYW5kIGZvdW5kJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhpZ2hlc3Q7XG4gIH1cblxuICBwcml2YXRlIHJlYWRVcGRhdGVNYW5pZmVzdCh4bWw6IHN0cmluZyk6IG9iamVjdCB7XG4gICAgcmV0dXJuIHhtbDJqcyh4bWwsIHsgY29tcGFjdDogZmFsc2UgfSk7XG4gIH1cblxuICAvLyB0b2RvOiBJbXByb3ZlIHRoZSBcImFueVwiXG4gIHByaXZhdGUgZmluZFVwZGF0ZShleHRlbnNpb25JZDogSUV4dGVuc2lvblsnaWQnXSwgcGFyc2VkVXBkYXRlczogYW55KTogYW55IHtcbiAgICBjb25zdCB1cGRhdGVzID0gdGhpcy5nZXROZXN0ZWQocGFyc2VkVXBkYXRlcywgWydlbGVtZW50cycsICcwJywgJ2VsZW1lbnRzJ10pO1xuICAgIGlmICghdXBkYXRlcykgcmV0dXJuIHVuZGVmaW5lZDtcblxuICAgIGZvciAoY29uc3QgdXBkYXRlIG9mIHVwZGF0ZXMpIHtcbiAgICAgIGlmIChleHRlbnNpb25JZCA9PT0gdXBkYXRlLmF0dHJpYnV0ZXMuYXBwaWQpIHtcbiAgICAgICAgcmV0dXJuIHVwZGF0ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROZXdWZXJzaW9uKHVwZGF0ZUNoZWNrOiBhbnkpOiBJVmVyc2lvbiB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgdmVyc2lvbiA9IHRoaXMuZ2V0TmVzdGVkKFxuICAgICAgdXBkYXRlQ2hlY2ssIFsnZWxlbWVudHMnLCAnMCcsICdhdHRyaWJ1dGVzJywgJ3ZlcnNpb24nXVxuICAgICk7XG5cbiAgICBpZiAoIXZlcnNpb24pIHtcbiAgICAgIHJldHVybjsgLy8gbm8gdXBkYXRlIGF2YWlsYWJsZVxuICAgIH1cblxuICAgIHJldHVybiBJbnRlcnByZXRlclByb3ZpZGVyLnBhcnNlVmVyc2lvbih2ZXJzaW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgZ3JlYXRlclRoYW4oYTogSVZlcnNpb24sIGI6IElWZXJzaW9uKSB7XG4gICAgY29uc3QgeCA9IGEucGFyc2VkO1xuICAgIGNvbnN0IHkgPSBiLnBhcnNlZDtcbiAgICAvLyBDb21wYXJlIGVhY2ggZGlnaXQgb2YgdGhlIHZlcnNpb25cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHgubGVuZ3RoOyBpID0gaSArIDEpIHtcbiAgICAgIC8vIFRoZSBvcmRlciBvZiB0aGUgcnVsZXMgaXMgaW1wb3J0YW50XG4gICAgICBpZiAoaXNOYU4oeFtpXSkpIHJldHVybiBmYWxzZTsgICAgICAgIC8vIElmIEFbaV0gaXMgbm90IGEgbnVtYmVyLCB0aGVuIEEgY2Fubm90IGJlIGhpZ2hlciBvciB3aGF0ZXZlclxuICAgICAgaWYgKHlbaV0gPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRydWU7ICAvLyBJZiBCW2ldIGhhcyBubyB2YWx1ZSB3aGVuIEFbaV0gaGFzIG9uZSwgQSBpcyBoaWdoZXJcbiAgICAgIGlmICh4W2ldIDwgeVtpXSkgcmV0dXJuIGZhbHNlOyAgICAgICAgLy8gSWYgQVtpXSBpcyBsb3dlciB0aGFuIEJbaV0sIHRoZW4gQSBpcyBub3QgaGlnaGVyXG4gICAgICBpZiAoeFtpXSA+IHlbaV0pIHJldHVybiB0cnVlOyAgICAgICAgIC8vIElmIEFbaV0gaXMgaGlnaGVyIHRoYW4gQltpXSwgdGhlbiBBIGlzIGhpZ2hlclxuICAgICAgLy8gSWYgbm9uZSBvZiB0aGUgcnVsZXMgcmV0dXJuZWQsIHRoZW4gdGhlIG51bWJlcnMgYXJlIGVxdWFsLCBnbyB0byB0aGUgbmV4dCBzdGVwXG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TmVzdGVkKG5lc3RlZE9iajogb2JqZWN0LCBwYXRoQXJyOiBzdHJpbmdbXSkge1xuICAgIHJldHVybiBwYXRoQXJyLnJlZHVjZShcbiAgICAgIChvYmosIGtleSkgPT4ge1xuICAgICAgICByZXR1cm4gKG9iaiAmJiBvYmpba2V5XSkgPyBvYmpba2V5XSA6IHVuZGVmaW5lZDtcbiAgICAgIH0sXG4gICAgICBuZXN0ZWRPYmpcbiAgICApO1xuICB9XG59XG4iXX0=