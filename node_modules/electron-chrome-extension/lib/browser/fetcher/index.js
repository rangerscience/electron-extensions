"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const events_1 = require("events");
const types_1 = require("../../common/types");
const storage_provider_1 = tslib_1.__importDefault(require("./storage-provider"));
const download_provider_1 = tslib_1.__importDefault(require("./download-provider"));
const interpreter_provider_1 = tslib_1.__importDefault(require("./interpreter-provider"));
const types_2 = require("./types");
const defaultConfig = {
    downloader: new download_provider_1.default(),
    storager: new storage_provider_1.default(),
    interpreter: new interpreter_provider_1.default(),
    autoUpdateInterval: 300000,
    autoUpdate: false,
};
class Fetcher extends events_1.EventEmitter {
    constructor(customConfiguration = {}) {
        if (Fetcher.instance) {
            return Fetcher.instance;
        }
        super();
        const configuration = Object.assign({}, defaultConfig, customConfiguration);
        const { storager, downloader, interpreter, autoUpdateInterval, autoUpdate, } = configuration;
        this.storager = storager;
        this.downloader = downloader;
        this.interpreter = interpreter;
        this.autoUpdateInterval = autoUpdateInterval;
        this.available = new Map();
        this.mutex = new Map();
        if (autoUpdate) {
            this.autoUpdateLoop = setInterval(this.autoUpdate.bind(this), this.autoUpdateInterval);
        }
        Fetcher.instance = this;
    }
    static reset() {
        if (Fetcher.instance) {
            Fetcher.instance.stopAutoUpdate();
            delete Fetcher.instance;
        }
    }
    list() {
        return this.available;
    }
    save(extension) {
        this.available.set(extension.id, extension);
    }
    get(extensionId) {
        return this.available.get(extensionId);
    }
    hasMutex(extensionId) {
        return this.mutex.has(extensionId);
    }
    getMutex(extensionId) {
        return this.mutex.get(extensionId);
    }
    fetch(extensionId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (this.mutex.has(extensionId)) {
                throw new Error(`Extension ${extensionId} is already being used`);
            }
            // todo: check if the extension already exists with this version ?
            // todo: react to errors
            this.mutex.set(extensionId, types_2.MutexStatus.Installing);
            const archiveCrx = yield this.downloader.downloadById(extensionId);
            const installed = yield this.storager.installExtension(archiveCrx);
            yield this.downloader.cleanupById(extensionId);
            const fetched = this.interpreter.interpret(installed);
            this.mutex.delete(extensionId);
            this.save(fetched);
            this.emit(types_1.ExtensionStatus.Installed, fetched);
            return fetched;
        });
    }
    update(extensionId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const shouldUpdate = yield this.checkForUpdate(extensionId);
            if (shouldUpdate) {
                const updated = yield this.fetch(extensionId);
                this.emit(types_1.ExtensionStatus.Updated, updated);
                return updated;
            }
            return false;
        });
    }
    checkForUpdate(extensionId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const cxInfos = this.available.get(extensionId);
            if (!cxInfos) {
                throw new Error('Unknown extension');
            }
            const updateInfos = yield this.downloader.getUpdateInfo(cxInfos);
            const shouldUpdate = this.interpreter.shouldUpdate(cxInfos, updateInfos);
            return shouldUpdate;
        });
    }
    // todo: pause or cancel if CX are being installed ?
    scanInstalledExtensions() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const installedInfos = yield this.storager.getInstalledExtension();
            for (const [key, value] of installedInfos) {
                const parsedVersions = Array.from(value.keys(), (version) => interpreter_provider_1.default.parseVersion(version));
                const latestVersion = this.interpreter.sortLastVersion(parsedVersions);
                const install = value.get(latestVersion.number);
                if (install) {
                    const cxInfo = this.interpreter.interpret(install);
                    this.available.set(key, cxInfo);
                    this.emit(types_1.ExtensionStatus.Discovered, cxInfo);
                }
            }
        });
    }
    autoUpdate() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const updates = [];
            for (const extensionId of this.available.keys()) {
                updates.push(this.update(extensionId));
            }
            const updatesResult = yield Promise.all(updates);
            return updatesResult.filter(Boolean);
        });
    }
    stopAutoUpdate() {
        clearInterval(this.autoUpdateLoop);
    }
}
exports.default = Fetcher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYnJvd3Nlci9mZXRjaGVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFzQztBQUV0Qyw4Q0FHNEI7QUFFNUIsa0ZBQWlEO0FBQ2pELG9GQUFtRDtBQUNuRCwwRkFBeUQ7QUFDekQsbUNBT2lCO0FBRWpCLE1BQU0sYUFBYSxHQUFtQjtJQUNwQyxVQUFVLEVBQUUsSUFBSSwyQkFBZ0IsRUFBRTtJQUNsQyxRQUFRLEVBQUUsSUFBSSwwQkFBZSxFQUFFO0lBQy9CLFdBQVcsRUFBRSxJQUFJLDhCQUFtQixFQUFFO0lBQ3RDLGtCQUFrQixFQUFFLE1BQU07SUFDMUIsVUFBVSxFQUFFLEtBQUs7Q0FDbEIsQ0FBQztBQUVGLE1BQXFCLE9BQVEsU0FBUSxxQkFBWTtJQWEvQyxZQUFZLHNCQUErQyxFQUFFO1FBQzNELElBQUksT0FBTyxDQUFDLFFBQVEsRUFBRTtZQUNwQixPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUM7U0FDekI7UUFFRCxLQUFLLEVBQUUsQ0FBQztRQUVSLE1BQU0sYUFBYSxxQkFBUSxhQUFhLEVBQUssbUJBQW1CLENBQUUsQ0FBQztRQUVuRSxNQUFNLEVBQ0osUUFBUSxFQUNSLFVBQVUsRUFDVixXQUFXLEVBQ1gsa0JBQWtCLEVBQ2xCLFVBQVUsR0FDWCxHQUFHLGFBQWEsQ0FBQztRQUVsQixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUUvQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUM7UUFFN0MsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUV2QixJQUFJLFVB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Q0FBQztLQUFBO0lBRVksVUFBVTs7WUFDckIsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBRW5CLEtBQUssTUFBTSxXQUFXLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDL0MsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7YUFDeEM7WUFFRCxNQUFNLGFBQWEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakQsT0FBTyxhQUFhLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZDLENBQUM7S0FBQTtJQUVELGNBQWM7UUFDWixhQUFhLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7Q0FDRjtBQWhLRCwwQkFnS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuXG5pbXBvcnQge1xuICBJRXh0ZW5zaW9uLFxuICBFeHRlbnNpb25TdGF0dXMsXG59IGZyb20gJy4uLy4uL2NvbW1vbi90eXBlcyc7XG5cbmltcG9ydCBTdG9yYWdlUHJvdmlkZXIgZnJvbSAnLi9zdG9yYWdlLXByb3ZpZGVyJztcbmltcG9ydCBEb3dubG9hZFByb3ZpZGVyIGZyb20gJy4vZG93bmxvYWQtcHJvdmlkZXInO1xuaW1wb3J0IEludGVycHJldGVyUHJvdmlkZXIgZnJvbSAnLi9pbnRlcnByZXRlci1wcm92aWRlcic7XG5pbXBvcnQge1xuICBJRmV0Y2hlckNvbmZpZyxcbiAgSUZldGNoZXIsXG4gIElEb3dubG9hZFByb3ZpZGVyLFxuICBJU3RvcmFnZVByb3ZpZGVyLFxuICBJSW50ZXJwcmV0ZXJQcm92aWRlcixcbiAgTXV0ZXhTdGF0dXMsXG59IGZyb20gJy4vdHlwZXMnO1xuXG5jb25zdCBkZWZhdWx0Q29uZmlnOiBJRmV0Y2hlckNvbmZpZyA9IHtcbiAgZG93bmxvYWRlcjogbmV3IERvd25sb2FkUHJvdmlkZXIoKSxcbiAgc3RvcmFnZXI6IG5ldyBTdG9yYWdlUHJvdmlkZXIoKSxcbiAgaW50ZXJwcmV0ZXI6IG5ldyBJbnRlcnByZXRlclByb3ZpZGVyKCksXG4gIGF1dG9VcGRhdGVJbnRlcnZhbDogMzAwMDAwLFxuICBhdXRvVXBkYXRlOiBmYWxzZSxcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEZldGNoZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIgaW1wbGVtZW50cyBJRmV0Y2hlciB7XG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBGZXRjaGVyO1xuXG4gIHB1YmxpYyBzdG9yYWdlcjogSVN0b3JhZ2VQcm92aWRlcjtcbiAgcHVibGljIGRvd25sb2FkZXI6IElEb3dubG9hZFByb3ZpZGVyO1xuICBwdWJsaWMgaW50ZXJwcmV0ZXI6IElJbnRlcnByZXRlclByb3ZpZGVyO1xuXG4gIHByaXZhdGUgbXV0ZXg6IE1hcDxJRXh0ZW5zaW9uWydpZCddLCBNdXRleFN0YXR1cz47XG4gIHByaXZhdGUgYXZhaWxhYmxlOiBNYXA8SUV4dGVuc2lvblsnaWQnXSwgSUV4dGVuc2lvbj47XG5cbiAgcHJpdmF0ZSBhdXRvVXBkYXRlTG9vcDogTm9kZUpTLlRpbWVyO1xuICBwcml2YXRlIGF1dG9VcGRhdGVJbnRlcnZhbDogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKGN1c3RvbUNvbmZpZ3VyYXRpb246IFBhcnRpYWw8SUZldGNoZXJDb25maWc+ID0ge30pIHtcbiAgICBpZiAoRmV0Y2hlci5pbnN0YW5jZSkge1xuICAgICAgcmV0dXJuIEZldGNoZXIuaW5zdGFuY2U7XG4gICAgfVxuXG4gICAgc3VwZXIoKTtcblxuICAgIGNvbnN0IGNvbmZpZ3VyYXRpb24gPSB7IC4uLmRlZmF1bHRDb25maWcsIC4uLmN1c3RvbUNvbmZpZ3VyYXRpb24gfTtcblxuICAgIGNvbnN0IHtcbiAgICAgIHN0b3JhZ2VyLFxuICAgICAgZG93bmxvYWRlcixcbiAgICAgIGludGVycHJldGVyLFxuICAgICAgYXV0b1VwZGF0ZUludGVydmFsLFxuICAgICAgYXV0b1VwZGF0ZSxcbiAgICB9ID0gY29uZmlndXJhdGlvbjtcblxuICAgIHRoaXMuc3RvcmFnZXIgPSBzdG9yYWdlcjtcbiAgICB0aGlzLmRvd25sb2FkZXIgPSBkb3dubG9hZGVyO1xuICAgIHRoaXMuaW50ZXJwcmV0ZXIgPSBpbnRlcnByZXRlcjtcblxuICAgIHRoaXMuYXV0b1VwZGF0ZUludGVydmFsID0gYXV0b1VwZGF0ZUludGVydmFsO1xuXG4gICAgdGhpcy5hdmFpbGFibGUgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5tdXRleCA9IG5ldyBNYXAoKTtcblxuICAgIGlmIChhdXRvVXBkYXRlKSB7XG4gICAgICB0aGlzLmF1dG9VcGRhdGVMb29wID0gc2V0SW50ZXJ2YWwoXG4gICAgICAgIHRoaXMuYXV0b1VwZGF0ZS5iaW5kKHRoaXMpLFxuICAgICAgICB0aGlzLmF1dG9VcGRhdGVJbnRlcnZhbFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBGZXRjaGVyLmluc3RhbmNlID0gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgcmVzZXQoKSB7XG4gICAgaWYgKEZldGNoZXIuaW5zdGFuY2UpIHtcbiAgICAgIEZldGNoZXIuaW5zdGFuY2Uuc3RvcEF1dG9VcGRhdGUoKTtcbiAgICAgIGRlbGV0ZSBGZXRjaGVyLmluc3RhbmNlO1xuICAgIH1cbiAgfVxuXG4gIGxpc3QoKSB7XG4gICAgcmV0dXJuIHRoaXMuYXZhaWxhYmxlO1xuICB9XG5cbiAgc2F2ZShleHRlbnNpb246IElFeHRlbnNpb24pIHtcbiAgICB0aGlzLmF2YWlsYWJsZS5zZXQoZXh0ZW5zaW9uLmlkLCBleHRlbnNpb24pO1xuICB9XG5cbiAgZ2V0KGV4dGVuc2lvbklkOiBJRXh0ZW5zaW9uWydpZCddKSB7XG4gICAgcmV0dXJuIHRoaXMuYXZhaWxhYmxlLmdldChleHRlbnNpb25JZCk7XG4gIH1cblxuICBoYXNNdXRleChleHRlbnNpb25JZDogSUV4dGVuc2lvblsnaWQnXSkge1xuICAgIHJldHVybiB0aGlzLm11dGV4LmhhcyhleHRlbnNpb25JZCk7XG4gIH1cblxuICBnZXRNdXRleChleHRlbnNpb25JZDogSUV4dGVuc2lvblsnaWQnXSkge1xuICAgIHJldHVybiB0aGlzLm11dGV4LmdldChleHRlbnNpb25JZCk7XG4gIH1cblxuICBhc3luYyBmZXRjaChleHRlbnNpb25JZDogSUV4dGVuc2lvblsnaWQnXSk6IFByb21pc2U8SUV4dGVuc2lvbj4ge1xuICAgIGlmICh0aGlzLm11dGV4LmhhcyhleHRlbnNpb25JZCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRXh0ZW5zaW9uICR7ZXh0ZW5zaW9uSWR9IGlzIGFscmVhZHkgYmVpbmcgdXNlZGApO1xuICAgIH1cblxuICAgIC8vIHRvZG86IGNoZWNrIGlmIHRoZSBleHRlbnNpb24gYWxyZWFkeSBleGlzdHMgd2l0aCB0aGlzIHZlcnNpb24gP1xuICAgIC8vIHRvZG86IHJlYWN0IHRvIGVycm9yc1xuXG4gICAgdGhpcy5tdXRleC5zZXQoZXh0ZW5zaW9uSWQsIE11dGV4U3RhdHVzLkluc3RhbGxpbmcpO1xuXG4gICAgY29uc3QgYXJjaGl2ZUNyeCA9IGF3YWl0IHRoaXMuZG93bmxvYWRlci5kb3dubG9hZEJ5SWQoZXh0ZW5zaW9uSWQpO1xuICAgIGNvbnN0IGluc3RhbGxlZCA9IGF3YWl0IHRoaXMuc3RvcmFnZXIuaW5zdGFsbEV4dGVuc2lvbihhcmNoaXZlQ3J4KTtcblxuICAgIGF3YWl0IHRoaXMuZG93bmxvYWRlci5jbGVhbnVwQnlJZChleHRlbnNpb25JZCk7XG5cbiAgICBjb25zdCBmZXRjaGVkID0gdGhpcy5pbnRlcnByZXRlci5pbnRlcnByZXQoaW5zdGFsbGVkKTtcblxuICAgIHRoaXMubXV0ZXguZGVsZXRlKGV4dGVuc2lvbklkKTtcbiAgICB0aGlzLnNhdmUoZmV0Y2hlZCk7XG4gICAgdGhpcy5lbWl0KEV4dGVuc2lvblN0YXR1cy5JbnN0YWxsZWQsIGZldGNoZWQpO1xuXG4gICAgcmV0dXJuIGZldGNoZWQ7XG4gIH1cblxuICBhc3luYyB1cGRhdGUoZXh0ZW5zaW9uSWQ6IElFeHRlbnNpb25bJ2lkJ10pIHtcbiAgICBjb25zdCBzaG91bGRVcGRhdGUgPSBhd2FpdCB0aGlzLmNoZWNrRm9yVXBkYXRlKGV4dGVuc2lvbklkKTtcblxuICAgIGlmIChzaG91bGRVcGRhdGUpIHtcbiAgICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB0aGlzLmZldGNoKGV4dGVuc2lvbklkKTtcbiAgICAgIHRoaXMuZW1pdChFeHRlbnNpb25TdGF0dXMuVXBkYXRlZCwgdXBkYXRlZCk7XG4gICAgICByZXR1cm4gdXBkYXRlZDtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBhc3luYyBjaGVja0ZvclVwZGF0ZShleHRlbnNpb25JZDogSUV4dGVuc2lvblsnaWQnXSkge1xuICAgIGNvbnN0IGN4SW5mb3MgPSB0aGlzLmF2YWlsYWJsZS5nZXQoZXh0ZW5zaW9uSWQpO1xuXG4gICAgaWYgKCFjeEluZm9zKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Vua25vd24gZXh0ZW5zaW9uJyk7XG4gICAgfVxuXG4gICAgY29uc3QgdXBkYXRlSW5mb3MgPSBhd2FpdCB0aGlzLmRvd25sb2FkZXIuZ2V0VXBkYXRlSW5mbyhjeEluZm9zKTtcbiAgICBjb25zdCBzaG91bGRVcGRhdGUgPSB0aGlzLmludGVycHJldGVyLnNob3VsZFVwZGF0ZShjeEluZm9zLCB1cGRhdGVJbmZvcyk7XG5cbiAgICByZXR1cm4gc2hvdWxkVXBkYXRlO1xuICB9XG5cbiAgLy8gdG9kbzogcGF1c2Ugb3IgY2FuY2VsIGlmIENYIGFyZSBiZWluZyBpbnN0YWxsZWQgP1xuICBhc3luYyBzY2FuSW5zdGFsbGVkRXh0ZW5zaW9ucygpIHtcbiAgICBjb25zdCBpbnN0YWxsZWRJbmZvcyA9IGF3YWl0IHRoaXMuc3RvcmFnZXIuZ2V0SW5zdGFsbGVkRXh0ZW5zaW9uKCk7XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBpbnN0YWxsZWRJbmZvcykge1xuICAgICAgY29uc3QgcGFyc2VkVmVyc2lvbnMgPSBBcnJheS5mcm9tKFxuICAgICAgICB2YWx1ZS5rZXlzKCksXG4gICAgICAgICh2ZXJzaW9uOiBzdHJpbmcpID0+IEludGVycHJldGVyUHJvdmlkZXIucGFyc2VWZXJzaW9uKHZlcnNpb24pXG4gICAgICApO1xuXG4gICAgICBjb25zdCBsYXRlc3RWZXJzaW9uID0gdGhpcy5pbnRlcnByZXRlci5zb3J0TGFzdFZlcnNpb24ocGFyc2VkVmVyc2lvbnMpO1xuICAgICAgY29uc3QgaW5zdGFsbCA9IHZhbHVlLmdldChsYXRlc3RWZXJzaW9uLm51bWJlcik7XG5cbiAgICAgIGlmIChpbnN0YWxsKSB7XG4gICAgICAgIGNvbnN0IGN4SW5mbyA9IHRoaXMuaW50ZXJwcmV0ZXIuaW50ZXJwcmV0KGluc3RhbGwpO1xuICAgICAgICB0aGlzLmF2YWlsYWJsZS5zZXQoa2V5LCBjeEluZm8pO1xuICAgICAgICB0aGlzLmVtaXQoRXh0ZW5zaW9uU3RhdHVzLkRpc2NvdmVyZWQsIGN4SW5mbyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGF1dG9VcGRhdGUoKSB7XG4gICAgY29uc3QgdXBkYXRlcyA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBleHRlbnNpb25JZCBvZiB0aGlzLmF2YWlsYWJsZS5rZXlzKCkpIHtcbiAgICAgIHVwZGF0ZXMucHVzaCh0aGlzLnVwZGF0ZShleHRlbnNpb25JZCkpO1xuICAgIH1cblxuICAgIGNvbnN0IHVwZGF0ZXNSZXN1bHQgPSBhd2FpdCBQcm9taXNlLmFsbCh1cGRhdGVzKTtcbiAgICByZXR1cm4gdXBkYXRlc1Jlc3VsdC5maWx0ZXIoQm9vbGVhbik7XG4gIH1cblxuICBzdG9wQXV0b1VwZGF0ZSgpIHtcbiAgICBjbGVhckludGVydmFsKHRoaXMuYXV0b1VwZGF0ZUxvb3ApO1xuICB9XG59XG4iXX0=