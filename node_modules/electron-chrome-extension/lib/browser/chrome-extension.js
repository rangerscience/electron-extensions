const { app, ipcMain, webContents, BrowserWindow, protocol } = require('electron');
const { getAllWebContents } = process.electronBinding('web_contents');
const ChromeAPIHandler = require('./handlers');
const { Buffer } = require('buffer');
const fs = require('fs');
const path = require('path');
const url = require('url');
const constants = require('../common/constants');
const wcAsTab = wc => ({
    id: wc.id,
    index: wc.id,
    windowId: 1,
    highlighted: wc.isFocused(),
    active: wc.isFocused(),
    pined: false,
    discarded: false,
    autoDiscardable: false,
    url: wc.getURL(),
    title: wc.getTitle(),
    incognito: false,
});
// TODO(zcbenz): Remove this when we have Object.values().
const objectValues = function (object) {
    return Object.keys(object).map(function (key) { return object[key]; });
};
// Mapping between extensionId(hostname) and manifest.
const manifestMap = {}; // extensionId => manifest
const manifestNameMap = {}; // name => manifest
const manifestWSMap = {}; // extensionId web store id => manifest
const apiHandlersMap = {};
const generateExtensionIdFromName = function (name) {
    return name.replace(/[\W_]+/g, '-').toLowerCase();
};
const isWindowOrWebView = function (webContents) {
    const type = webContents.getType();
    return type === 'window' || type === 'webview';
};
// Create or get manifest object from |srcDirectory|.
const getManifestFromPath = function (extensionId, srcDirectory) {
    let manifest;
    let manifestContent;
    try {
        manifestContent = fs.readFileSync(path.join(srcDirectory, 'manifest.json'));
    }
    catch (readError) {
        console.warn(`Reading ${path.join(srcDirectory, 'manifest.json')} failed.`);
        console.warn(readError.stack || readError);
        throw readError;
    }
    try {
        manifest = JSON.parse(manifestContent);
    }
    catch (parseError) {
        console.warn(`Parsing ${path.join(srcDirectory, 'manifest.json')} failed.`);
        console.warn(parseError.stack || parseError);
        throw parseError;
    }
    if (!manifestNameMap[manifest.name]) {
        manifestMap[extensionId] = manifestNameMap[manifest.name] = manifestWSMap[extensionId] = manifest;
        Object.assign(manifest, {
            srcDirectory: srcDirectory,
            extensionId,
            // We can not use 'file://' directly because all resources in the extension
            // will be treated as relative to the root in Chrome.
            startPage: url.format({
                protocol: constants.EXTENSION_PROTOCOL,
                slashes: true,
                hostname: extensionId,
                pathname: manifest.devtools_page
            })
        });
        return manifest;
    }
    else if (manifest && manifest.name) {
        console.warn(`Attempted to load extension "${manifest.name}" that has already been loaded.`);
    }
};
// Manage the background pages.
const backgroundPages = {};
const startBackgroundPages = function (manifest) {
    if (backgroundPages[manifest.extensionId] || !manifest.background)
        return;
    let html;
    let name;
    if (manifest.background.page) {
        name = manifest.background.page;
        html = fs.readFileSync(path.join(manifest.srcDirectory, manifest.background.page));
    }
    else {
        name = '_generated_background_page.html';
        const scripts = manifest.background.scripts.map((name) => {
            return `<script src="${name}"></script>`;
        }).join('');
        html = Buffer.from(`<html><body>${scripts}</body></html>`);
    }
    // ref: https://cs.chromium.org/chromium/src/chrome/browser/background/background_contents_service.cc?l=678
    const contents = webContents.create({
        isBackgroundPage: true,
        commandLineSwitches: [
            '--electron-chrome-extension-background-page',
            `--preload=${path.join(__dirname, '../renderer/index.js')}`
        ]
    });
    backgroundPages[manifest.extensionId] = { html: html, webContents: contents, name: name, src: manifest.srcDirectory };
    contents.loadURL(url.format({
        protocol: constants.EXTENSION_PROTOCOL,
        slashes: true,
        hostname: manifest.extensionId,
        pathname: name
    }));
};
const removeBackgroundPages = function (manifest) {
    if (!backgroundPages[manifest.extensionId])
        return;
    backgroundPages[manifest.extensionId].webContents.destroy();
    delete backgroundPages[manifest.extensionId];
};
const sendToBackgroundPages = function (...args) {
    for (const page of objectValues(backgroundPages)) {
        page.webContents.sendToAll(...args);
    }
};
const sendEventToExtensions = (e) => sendToBackgroundPages('cx-event', e);
// Dispatch web contents events to Chrome APIs
const hookWebContentsEvents = function (webContents) {
    const tabId = webContents.id;
    sendToBackgroundPages(constants.TABS_ONCREATED);
    webContents.on('will-navigate', (event, url) => {
        sendToBackgroundPages(constants.WEBNAVIGATION_ONBEFORENAVIGATE, {
            frameId: 0,
            parentFrameId: -1,
            processId: webContents.getProcessId(),
            tabId: tabId,
            timeStamp: Date.now(),
            url: url
        });
    });
    webContents.on('did-start-loading', (...args) => {
        const changeInfo = { status: 'loading' };
        sendEventToExtensions({
            channel: 'tabs.onUpdated',
            payload: [tabId, changeInfo, wcAsTab(webContents)],
        });
    });
    webContents.on('did-stop-loading', (...args) => {
        const changeInfo = { status: 'complete' };
        sendEventToExtensions({
            channel: 'tabs.onUpdated',
            payload: [tabId, changeInfo, wcAsTab(webContents)],
        });
    });
    webContents.on('did-navigate', (event, url) => {
        sendToBackgroundPages(constants.WEBNAVIGATION_ONCOMPLETED, {
            frameId: 0,
            parentFrameId: -1,
            processId: webContents.getProcessId(),
            tabId: tabId,
            timeStamp: Date.now(),
            url: url
        });
    });
    webContents.once('destroyed', () => {
        sendToBackgroundPages(constants.TABS_ONREMOVED, tabId);
    });
};
// Handle the chrome.* API messages.
let nextId = 0;
ipcMain.on(constants.RUNTIME_CONNECT, function (event, extensionId, connectInfo, url) {
    const page = backgroundPages[extensionId];
    if (!page) {
        console.error(`Connect to unknown extension ${extensionId}`);
        return;
    }
    const portId = ++nextId;
    event.returnValue = { tabId: page.webContents.id, portId };
    event.sender.once('render-view-deleted', () => {
        if (page.webContents.isDestroyed())
            return;
        page.webContents.sendToAll(`${constants.PORT_DISCONNECT_}${portId}`);
    });
    page.webContents.sendToAll(`${constants.RUNTIME_ONCONNECT_}${extensionId}`, event.sender.id, portId, connectInfo, url);
});
ipcMain.on(constants.I18N_MANIFEST, function (event, extensionId) {
    event.returnValue = manifestMap[extensionId];
});
let resultID = 1;
ipcMain.on(constants.RUNTIME_SENDMESSAGE, function (contentScriptEvent, extensionId, message, originResultID) {
    const page = backgroundPages[extensionId];
    if (!page) {
        console.error(`Connect to unknown extension ${extensionId}`);
        return;
    }
    page.webContents.sendToAll(`${constants.RUNTIME_ONMESSAGE_}${extensionId}`, contentScriptEvent.sender.id, message, resultID);
    ipcMain.once(`${constants.RUNTIME_ONMESSAGE_RESULT_}${resultID}`, (backgroundPageEvent, result) => {
        contentScriptEvent.sender.send(`${constants.RUNTIME_SENDMESSAGE_RESULT_}${originResultID}`, result);
    });
    resultID++;
});
ipcMain.on(constants.TABS_SEND_MESSAGE, function (event, tabId, extensionId, isBackgroundPage, message, originResultID) {
    const contents = webContents.fromId(tabId);
    if (!contents) {
        console.error(`Sending message to unknown tab ${tabId}`);
        return;
    }
    const senderTabId = isBackgroundPage ? null : event.sender.id;
    contents.sendToAll(`${constants.RUNTIME_ONMESSAGE_}${extensionId}`, senderTabId, message, resultID);
    ipcMain.once(`${constants.RUNTIME_ONMESSAGE_RESULT_}${resultID}`, (eventResult, result) => {
        eventResult.sender.send(`${constants.TABS_SEND_MESSAGE_RESULT_}${originResultID}`, result);
    });
    resultID++;
});
ipcMain.on(constants.TABS_EXECUTESCRIPT, function (event, requestId, tabId, extensionId, details) {
    const contents = webContents.fromId(tabId);
    if (!contents) {
        console.error(`Sending message to unknown tab ${tabId}`);
        return;
    }
    let code, url;
    if (details.file) {
        const manifest = manifestMap[extensionId];
        code = String(fs.readFileSync(path.join(manifest.srcDirectory, details.file)));
        url = `${constants.EXTENSION_PROTOCOL}://${extensionId}${details.file}`;
    }
    else {
        code = details.code;
        url = `${constants.EXTENSION_PROTOCOL}://${extensionId}/${String(Math.random()).substr(2, 8)}.js`;
    }
    contents.send(constants.TABS_EXECUTESCRIPT, event.sender.id, requestId, extensionId, url, code);
});
ipcMain.on(constants.TABS_QUERY, function (event, requestId, _extensionId) {
    const tabs = webContents.getAllWebContents()
        .filter(wc => wc.getType() === 'webview')
        .map(wcAsTab);
    event.sender.send(`${constants.TABS_QUERY_RESULT_}${requestId}`, tabs);
});
ipcMain.on(constants.TABS_GET, function (event, requestId, _extensionId, tabId) {
    const wc = webContents.getAllWebContents()
        .find(wc => wc.id === tabId);
    if (wc) {
        event.sender.send(`${constants.TABS_GET_RESULT_}${requestId}`, wcAsTab(wc));
    }
    else {
        event.sender.send(`${constants.TABS_GET_RESULT_}${requestId}`, undefined);
    }
});
ipcMain.on(constants.RUNTIME_GET_MANIFEST, (event, extensionId) => {
    event.returnValue = manifestMap[extensionId];
});
// Transfer the content scripts to renderer.
const contentScripts = {};
const injectContentScripts = function (manifest) {
    if (contentScripts[manifest.name] || !manifest.content_scripts)
        return;
    const readArrayOfFiles = function (relativePath) {
        return {
            url: `${constants.EXTENSION_PROTOCOL}://${manifest.extensionId}${relativePath}`,
            code: String(fs.readFileSync(path.join(manifest.srcDirectory, relativePath)))
        };
    };
    const contentScriptToEntry = function (script) {
        return {
            matches: script.matches,
            exclude_matches: script.exclude_matches,
            js: script.js ? script.js.map(readArrayOfFiles) : [],
            css: script.css ? script.css.map(readArrayOfFiles) : [],
            runAt: script.run_at || 'document_idle'
        };
    };
    try {
        const entry = {
            extensionId: manifest.extensionId,
            extensionName: manifest.name,
            contentScripts: manifest.content_scripts.map(contentScriptToEntry)
        };
        contentScripts[manifest.name] = entry;
    }
    catch (e) {
        console.error('Failed to read content scripts', e);
    }
};
const contentSecurityPolicy = {
    extensionId: undefined,
    policy: undefined
};
const injectContentSecurityPolicy = function (manifest) {
    if (!manifest.content_security_policy)
        return;
    contentSecurityPolicy.extensionId = manifest.extensionId;
    contentSecurityPolicy.policy = manifest.content_security_policy;
};
const removeContentScripts = function (manifest) {
    if (!contentScripts[manifest.name])
        return;
    delete contentScripts[manifest.name];
};
ipcMain.on('GET_CONTENTSCRIPTS_SYNC', e => {
    e.returnValue = contentScripts;
});
ipcMain.on('GET_CONTENTSECURITYPOLICY_SYNC', e => {
    e.returnValue = contentSecurityPolicy;
});
// Transfer the |manifest| to a format that can be recognized by the
// |DevToolsAPI.addExtensions|.
const manifestToExtensionInfo = function (manifest) {
    return {
        startPage: manifest.startPage,
        srcDirectory: manifest.srcDirectory,
        name: manifest.name,
        exposeExperimentalAPIs: true
    };
};
// Load the extensions for the window.
const loadExtension = function (manifest) {
    const { extensionId } = manifest;
    if (!(extensionId in apiHandlersMap)) {
        apiHandlersMap[extensionId] = new ChromeAPIHandler(extensionId, sendEventToExtensions);
    }
    startBackgroundPages(manifest);
    injectContentScripts(manifest);
    injectContentSecurityPolicy(manifest);
};
const loadDevToolsExtensions = function (win, manifests) {
    if (!win.devToolsWebContents)
        return;
    manifests.forEach(loadExtension);
    const extensionInfoArray = manifests.map(manifestToExtensionInfo);
    extensionInfoArray.forEach((extension) => {
        win.devToolsWebContents._grantOriginAccess(extension.startPage);
    });

    // ref: https://github.com/electron/electron/pull/17614/files#diff-8d85c651cb0fb8feef2c4694d52da2e3R400
    //win.devToolsWebContents.executeJavaScript(`InspectorFrontendAPI.addExtensions(${JSON.stringify(extensionInfoArray)})`);
};
app.on('web-contents-created', function (event, webContents) {
    if (!isWindowOrWebView(webContents))
        return;
    hookWebContentsEvents(webContents);
    webContents.on('devtools-opened', function () {
        loadDevToolsExtensions(webContents, objectValues(manifestMap));
    });
});
module.exports = {
    sendEventToExtensions,
    // should be removed when we have a typed extensions memory store
    getExtensionById: function (extensionId) {
        const bgExt = backgroundPages[extensionId];
        if (bgExt) {
            return {
                src: bgExt.src,
                backgroundPage: {
                    name: bgExt.name,
                    html: bgExt.html,
                },
            };
        }
        const manifest = manifestWSMap[extensionId];
        if (manifest) {
            const ext = backgroundPages[manifest.extensionId];
            if (ext) {
                return {
                    src: ext.src,
                    backgroundPage: {
                        name: ext.name,
                        html: ext.html,
                    },
                };
            }
        }
        return undefined;
    },
    // The public API to add/remove extensions.
    addExtension: function (extensionId, srcDirectory) {
        const manifest = getManifestFromPath(extensionId, srcDirectory);
        if (manifest) {
            loadExtension(manifest);
            for (const webContents of getAllWebContents()) {
                if (isWindowOrWebView(webContents)) {
                    loadDevToolsExtensions(webContents, [manifest]);
                }
            }
            return manifest.name;
        }
    },
    removeExtension: function (id) {
        const manifest = manifestWSMap[id];
        if (!manifest)
            return;
        const { extensionId } = manifest;
        apiHandlersMap[extensionId].release();
        delete apiHandlersMap[extensionId];
        removeBackgroundPages(manifest);
        removeContentScripts(manifest);
        delete manifestMap[manifest.extensionId];
        delete manifestNameMap[manifest.name];
        delete manifestWSMap[id];
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hyb21lLWV4dGVuc2lvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9icm93c2VyL2Nocm9tZS1leHRlbnNpb24uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUE7QUFDbEYsTUFBTSxFQUFFLGlCQUFpQixFQUFFLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxjQUFjLENBQUMsQ0FBQTtBQUNyRSxNQUFNLGdCQUFnQixHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUUvQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQ3BDLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUN4QixNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUE7QUFDNUIsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFBO0FBRTFCLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBRWpELE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNyQixFQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUU7SUFDVCxLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUU7SUFDWixRQUFRLEVBQUUsQ0FBQztJQUNYLFdBQVcsRUFBRSxFQUFFLENBQUMsU0FBUyxFQUFFO0lBQzNCLE1BQU0sRUFBRSxFQUFFLENBQUMsU0FBUyxFQUFFO0lBQ3RCLEtBQUssRUFBRSxLQUFLO0lBQ1osU0FBUyxFQUFFLEtBQUs7SUFDaEIsZUFBZSxFQUFFLEtBQUs7SUFDdEIsR0FBRyxFQUFFLEVBQUUsQ0FBQyxNQUFNLEVBQUU7SUFDaEIsS0FBSyxFQUFFLEVB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QUFVLFdBQVcsRUFBRSxZQUFZO1FBQy9DLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQTtRQUMvRCxJQUFJLFFBQVEsRUFBRTtZQUNaLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQTtZQUN2QixLQUFLLE1BQU0sV0FBVyxJQUFJLGlCQUFpQixFQUFFLEVBQUU7Z0JBQzdDLElBQUksaUJBQWlCLENBQUMsV0FBVyxDQUFDLEVBQUU7b0JBQ2xDLHNCQUFzQixDQUFDLFdBQVcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7aUJBQ2hEO2FBQ0Y7WUFDRCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUE7U0FDckI7SUFDSCxDQUFDO0lBRUQsZUFBZSxFQUFFLFVBQVUsRUFBRTtRQUMzQixNQUFNLFFBQVEsR0FBRyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFbkMsSUFBSSxDQUFDLFFBQVE7WUFBRSxPQUFNO1FBQ3JCLE1BQU0sRUFBRSxXQUFXLEVBQUUsR0FBRyxRQUFRLENBQUM7UUFFakMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3RDLE9BQU8sY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRW5DLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQy9CLG9CQUFvQixDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQzlCLE9BQU8sV0FBVyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQTtRQUN4QyxPQUFPLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDckMsT0FBTyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDM0IsQ0FBQztDQUNGLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB7IGFwcCwgaXBjTWFpbiwgd2ViQ29udGVudHMsIEJyb3dzZXJXaW5kb3csIHByb3RvY29sIH0gPSByZXF1aXJlKCdlbGVjdHJvbicpXG5jb25zdCB7IGdldEFsbFdlYkNvbnRlbnRzIH0gPSBwcm9jZXNzLmVsZWN0cm9uQmluZGluZygnd2ViX2NvbnRlbnRzJylcbmNvbnN0IENocm9tZUFQSUhhbmRsZXIgPSByZXF1aXJlKCcuL2hhbmRsZXJzJyk7XG5cbmNvbnN0IHsgQnVmZmVyIH0gPSByZXF1aXJlKCdidWZmZXInKVxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5jb25zdCB1cmwgPSByZXF1aXJlKCd1cmwnKVxuXG5jb25zdCBjb25zdGFudHMgPSByZXF1aXJlKCcuLi9jb21tb24vY29uc3RhbnRzJyk7XG5cbmNvbnN0IHdjQXNUYWIgPSB3YyA9PiAoe1xuICBpZDogd2MuaWQsXG4gIGluZGV4OiB3Yy5pZCxcbiAgd2luZG93SWQ6IDEsXG4gIGhpZ2hsaWdodGVkOiB3Yy5pc0ZvY3VzZWQoKSxcbiAgYWN0aXZlOiB3Yy5pc0ZvY3VzZWQoKSxcbiAgcGluZWQ6IGZhbHNlLFxuICBkaXNjYXJkZWQ6IGZhbHNlLFxuICBhdXRvRGlzY2FyZGFibGU6IGZhbHNlLFxuICB1cmw6IHdjLmdldFVSTCgpLFxuICB0aXRsZTogd2MuZ2V0VGl0bGUoKSxcbiAgaW5jb2duaXRvOiBmYWxzZSxcbn0pXG5cbi8vIFRPRE8oemNiZW56KTogUmVtb3ZlIHRoaXMgd2hlbiB3ZSBoYXZlIE9iamVjdC52YWx1ZXMoKS5cbmNvbnN0IG9iamVjdFZhbHVlcyA9IGZ1bmN0aW9uIChvYmplY3QpIHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKG9iamVjdCkubWFwKGZ1bmN0aW9uIChrZXkpIHsgcmV0dXJuIG9iamVjdFtrZXldIH0pXG59XG5cbi8vIE1hcHBpbmcgYmV0d2VlbiBleHRlbnNpb25JZChob3N0bmFtZSkgYW5kIG1hbmlmZXN0LlxuY29uc3QgbWFuaWZlc3RNYXAgPSB7fSAgLy8gZXh0ZW5zaW9uSWQgPT4gbWFuaWZlc3RcbmNvbnN0IG1hbmlmZXN0TmFtZU1hcCA9IHt9ICAvLyBuYW1lID0+IG1hbmlmZXN0XG5jb25zdCBtYW5pZmVzdFdTTWFwID0ge30gIC8vIGV4dGVuc2lvbklkIHdlYiBzdG9yZSBpZCA9PiBtYW5pZmVzdFxuY29uc3QgYXBpSGFuZGxlcnNNYXAgPSB7fTtcblxuY29uc3QgZ2VuZXJhdGVFeHRlbnNpb25JZEZyb21OYW1lID0gZnVuY3Rpb24gKG5hbWUpIHtcbiAgcmV0dXJuIG5hbWUucmVwbGFjZSgvW1xcV19dKy9nLCAnLScpLnRvTG93ZXJDYXNlKClcbn1cblxuY29uc3QgaXNXaW5kb3dPcldlYlZpZXcgPSBmdW5jdGlvbiAod2ViQ29udGVudHMpIHtcbiAgY29uc3QgdHlwZSA9IHdlYkNvbnRlbnRzLmdldFR5cGUoKVxuICByZXR1cm4gdHlwZSA9PT0gJ3dpbmRvdycgfHwgdHlwZSA9PT0gJ3dlYnZpZXcnXG59XG5cbi8vIENyZWF0ZSBvciBnZXQgbWFuaWZlc3Qgb2JqZWN0IGZyb20gfHNyY0RpcmVjdG9yeXwuXG5jb25zdCBnZXRNYW5pZmVzdEZyb21QYXRoID0gZnVuY3Rpb24gKGV4dGVuc2lvbklkLCBzcmNEaXJlY3RvcnkpIHtcbiAgbGV0IG1hbmlmZXN0XG4gIGxldCBtYW5pZmVzdENvbnRlbnRcblxuICB0cnkge1xuICAgIG1hbmlmZXN0Q29udGVudCA9IGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4oc3JjRGlyZWN0b3J5LCAnbWFuaWZlc3QuanNvbicpKVxuICB9IGNhdGNoIChyZWFkRXJyb3IpIHtcbiAgICBjb25zb2xlLndhcm4oYFJlYWRpbmcgJHtwYXRoLmpvaW4oc3JjRGlyZWN0b3J5LCAnbWFuaWZlc3QuanNvbicpfSBmYWlsZWQuYClcbiAgICBjb25zb2xlLndhcm4ocmVhZEVycm9yLnN0YWNrIHx8IHJlYWRFcnJvcilcbiAgICB0aHJvdyByZWFkRXJyb3JcbiAgfVxuXG4gIHRyeSB7XG4gICAgbWFuaWZlc3QgPSBKU09OLnBhcnNlKG1hbmlmZXN0Q29udGVudClcbiAgfSBjYXRjaCAocGFyc2VFcnJvcikge1xuICAgIGNvbnNvbGUud2FybihgUGFyc2luZyAke3BhdGguam9pbihzcmNEaXJlY3RvcnksICdtYW5pZmVzdC5qc29uJyl9IGZhaWxlZC5gKVxuICAgIGNvbnNvbGUud2FybihwYXJzZUVycm9yLnN0YWNrIHx8IHBhcnNlRXJyb3IpXG4gICAgdGhyb3cgcGFyc2VFcnJvclxuICB9XG4gIGlmICghbWFuaWZlc3ROYW1lTWFwW21hbmlmZXN0Lm5hbWVdKSB7XG4gICAgbWFuaWZlc3RNYXBbZXh0ZW5zaW9uSWRdID0gbWFuaWZlc3ROYW1lTWFwW21hbmlmZXN0Lm5hbWVdID0gbWFuaWZlc3RXU01hcFtleHRlbnNpb25JZF0gPSBtYW5pZmVzdFxuICAgIE9iamVjdC5hc3NpZ24obWFuaWZlc3QsIHtcbiAgICAgIHNyY0RpcmVjdG9yeTogc3JjRGlyZWN0b3J5LFxuICAgICAgZXh0ZW5zaW9uSWQsXG4gICAgICAvLyBXZSBjYW4gbm90IHVzZSAnZmlsZTovLycgZGlyZWN0bHkgYmVjYXVzZSBhbGwgcmVzb3VyY2VzIGluIHRoZSBleHRlbnNpb25cbiAgICAgIC8vIHdpbGwgYmUgdHJlYXRlZCBhcyByZWxhdGl2ZSB0byB0aGUgcm9vdCBpbiBDaHJvbWUuXG4gICAgICBzdGFydFBhZ2U6IHVybC5mb3JtYXQoe1xuICAgICAgICBwcm90b2NvbDogY29uc3RhbnRzLkVYVEVOU0lPTl9QUk9UT0NPTCxcbiAgICAgICAgc2xhc2hlczogdHJ1ZSxcbiAgICAgICAgaG9zdG5hbWU6IGV4dGVuc2lvbklkLFxuICAgICAgICBwYXRobmFtZTogbWFuaWZlc3QuZGV2dG9vbHNfcGFnZVxuICAgICAgfSlcbiAgICB9KVxuICAgIHJldHVybiBtYW5pZmVzdFxuICB9IGVsc2UgaWYgKG1hbmlmZXN0ICYmIG1hbmlmZXN0Lm5hbWUpIHtcbiAgICBjb25zb2xlLndhcm4oYEF0dGVtcHRlZCB0byBsb2FkIGV4dGVuc2lvbiBcIiR7bWFuaWZlc3QubmFtZX1cIiB0aGF0IGhhcyBhbHJlYWR5IGJlZW4gbG9hZGVkLmApXG4gIH1cbn1cblxuLy8gTWFuYWdlIHRoZSBiYWNrZ3JvdW5kIHBhZ2VzLlxuY29uc3QgYmFja2dyb3VuZFBhZ2VzID0ge31cblxuY29uc3Qgc3RhcnRCYWNrZ3JvdW5kUGFnZXMgPSBmdW5jdGlvbiAobWFuaWZlc3QpIHtcbiAgaWYgKGJhY2tncm91bmRQYWdlc1ttYW5pZmVzdC5leHRlbnNpb25JZF0gfHwgIW1hbmlmZXN0LmJhY2tncm91bmQpIHJldHVyblxuXG4gIGxldCBodG1sXG4gIGxldCBuYW1lXG4gIGlmIChtYW5pZmVzdC5iYWNrZ3JvdW5kLnBhZ2UpIHtcbiAgICBuYW1lID0gbWFuaWZlc3QuYmFja2dyb3VuZC5wYWdlXG4gICAgaHRtbCA9IGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4obWFuaWZlc3Quc3JjRGlyZWN0b3J5LCBtYW5pZmVzdC5iYWNrZ3JvdW5kLnBhZ2UpKVxuICB9IGVsc2Uge1xuICAgIG5hbWUgPSAnX2dlbmVyYXRlZF9iYWNrZ3JvdW5kX3BhZ2UuaHRtbCdcbiAgICBjb25zdCBzY3JpcHRzID0gbWFuaWZlc3QuYmFja2dyb3VuZC5zY3JpcHRzLm1hcCgobmFtZSkgPT4ge1xuICAgICAgcmV0dXJuIGA8c2NyaXB0IHNyYz1cIiR7bmFtZX1cIj48L3NjcmlwdD5gXG4gICAgfSkuam9pbignJylcbiAgICBodG1sID0gQnVmZmVyLmZyb20oYDxodG1sPjxib2R5PiR7c2NyaXB0c308L2JvZHk+PC9odG1sPmApXG4gIH1cblxuICAvLyByZWY6IGh0dHBzOi8vY3MuY2hyb21pdW0ub3JnL2Nocm9taXVtL3NyYy9jaHJvbWUvYnJvd3Nlci9iYWNrZ3JvdW5kL2JhY2tncm91bmRfY29udGVudHNfc2VydmljZS5jYz9sPTY3OFxuICBjb25zdCBjb250ZW50cyA9IHdlYkNvbnRlbnRzLmNyZWF0ZSh7XG4gICAgaXNCYWNrZ3JvdW5kUGFnZTogdHJ1ZSxcbiAgICBjb21tYW5kTGluZVN3aXRjaGVzOiBbXG4gICAgICAnLS1lbGVjdHJvbi1jaHJvbWUtZXh0ZW5zaW9uLWJhY2tncm91bmQtcGFnZScsXG4gICAgICBgLS1wcmVsb2FkPSR7cGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3JlbmRlcmVyL2luZGV4LmpzJyl9YFxuICAgIF1cbiAgfSk7XG5cbiAgYmFja2dyb3VuZFBhZ2VzW21hbmlmZXN0LmV4dGVuc2lvbklkXSA9IHsgaHRtbDogaHRtbCwgd2ViQ29udGVudHM6IGNvbnRlbnRzLCBuYW1lOiBuYW1lLCBzcmM6IG1hbmlmZXN0LnNyY0RpcmVjdG9yeSB9XG5cbiAgY29udGVudHMubG9hZFVSTCh1cmwuZm9ybWF0KHtcbiAgICBwcm90b2NvbDogY29uc3RhbnRzLkVYVEVOU0lPTl9QUk9UT0NPTCxcbiAgICBzbGFzaGVzOiB0cnVlLFxuICAgIGhvc3RuYW1lOiBtYW5pZmVzdC5leHRlbnNpb25JZCxcbiAgICBwYXRobmFtZTogbmFtZVxuICB9KSlcbn1cblxuY29uc3QgcmVtb3ZlQmFja2dyb3VuZFBhZ2VzID0gZnVuY3Rpb24gKG1hbmlmZXN0KSB7XG4gIGlmICghYmFja2dyb3VuZFBhZ2VzW21hbmlmZXN0LmV4dGVuc2lvbklkXSkgcmV0dXJuXG5cbiAgYmFja2dyb3VuZFBhZ2VzW21hbmlmZXN0LmV4dGVuc2lvbklkXS53ZWJDb250ZW50cy5kZXN0cm95KClcbiAgZGVsZXRlIGJhY2tncm91bmRQYWdlc1ttYW5pZmVzdC5leHRlbnNpb25JZF1cbn1cblxuY29uc3Qgc2VuZFRvQmFja2dyb3VuZFBhZ2VzID0gZnVuY3Rpb24gKC4uLmFyZ3MpIHtcbiAgZm9yIChjb25zdCBwYWdlIG9mIG9iamVjdFZhbHVlcyhiYWNrZ3JvdW5kUGFnZXMpKSB7XG4gICAgcGFnZS53ZWJDb250ZW50cy5zZW5kVG9BbGwoLi4uYXJncylcbiAgfVxufVxuXG5jb25zdCBzZW5kRXZlbnRUb0V4dGVuc2lvbnMgPSAoZSkgPT4gc2VuZFRvQmFja2dyb3VuZFBhZ2VzKCdjeC1ldmVudCcsIGUpO1xuXG4vLyBEaXNwYXRjaCB3ZWIgY29udGVudHMgZXZlbnRzIHRvIENocm9tZSBBUElzXG5jb25zdCBob29rV2ViQ29udGVudHNFdmVudHMgPSBmdW5jdGlvbiAod2ViQ29udGVudHMpIHtcbiAgY29uc3QgdGFiSWQgPSB3ZWJDb250ZW50cy5pZFxuXG4gIHNlbmRUb0JhY2tncm91bmRQYWdlcyhjb25zdGFudHMuVEFCU19PTkNSRUFURUQpXG5cbiAgd2ViQ29udGVudHMub24oJ3dpbGwtbmF2aWdhdGUnLCAoZXZlbnQsIHVybCkgPT4ge1xuICAgIHNlbmRUb0JhY2tncm91bmRQYWdlcyhjb25zdGFudHMuV0VCTkFWSUdBVElPTl9PTkJFRk9SRU5BVklHQVRFLCB7XG4gICAgICBmcmFtZUlkOiAwLFxuICAgICAgcGFyZW50RnJhbWVJZDogLTEsXG4gICAgICBwcm9jZXNzSWQ6IHdlYkNvbnRlbnRzLmdldFByb2Nlc3NJZCgpLFxuICAgICAgdGFiSWQ6IHRhYklkLFxuICAgICAgdGltZVN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgdXJsOiB1cmxcbiAgICB9KVxuICB9KVxuXG4gIHdlYkNvbnRlbnRzLm9uKCdkaWQtc3RhcnQtbG9hZGluZycsICguLi5hcmdzKSA9PiB7XG4gICAgY29uc3QgY2hhbmdlSW5mbyA9IHsgc3RhdHVzOiAnbG9hZGluZycgfTtcblxuICAgIHNlbmRFdmVudFRvRXh0ZW5zaW9ucyh7XG4gICAgICBjaGFubmVsOiAndGFicy5vblVwZGF0ZWQnLFxuICAgICAgcGF5bG9hZDogW3RhYklkLCBjaGFuZ2VJbmZvLCB3Y0FzVGFiKHdlYkNvbnRlbnRzKV0sXG4gICAgfSlcbiAgfSlcblxuICB3ZWJDb250ZW50cy5vbignZGlkLXN0b3AtbG9hZGluZycsICguLi5hcmdzKSA9PiB7XG4gICAgY29uc3QgY2hhbmdlSW5mbyA9IHsgc3RhdHVzOiAnY29tcGxldGUnIH07XG5cbiAgICBzZW5kRXZlbnRUb0V4dGVuc2lvbnMoe1xuICAgICAgY2hhbm5lbDogJ3RhYnMub25VcGRhdGVkJyxcbiAgICAgIHBheWxvYWQ6IFt0YWJJZCwgY2hhbmdlSW5mbywgd2NBc1RhYih3ZWJDb250ZW50cyldLFxuICAgIH0pXG4gIH0pXG5cbiAgd2ViQ29udGVudHMub24oJ2RpZC1uYXZpZ2F0ZScsIChldmVudCwgdXJsKSA9PiB7XG4gICAgc2VuZFRvQmFja2dyb3VuZFBhZ2VzKGNvbnN0YW50cy5XRUJOQVZJR0FUSU9OX09OQ09NUExFVEVELCB7XG4gICAgICBmcmFtZUlkOiAwLFxuICAgICAgcGFyZW50RnJhbWVJZDogLTEsXG4gICAgICBwcm9jZXNzSWQ6IHdlYkNvbnRlbnRzLmdldFByb2Nlc3NJZCgpLFxuICAgICAgdGFiSWQ6IHRhYklkLFxuICAgICAgdGltZVN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgdXJsOiB1cmxcbiAgICB9KVxuICB9KVxuXG4gIHdlYkNvbnRlbnRzLm9uY2UoJ2Rlc3Ryb3llZCcsICgpID0+IHtcbiAgICBzZW5kVG9CYWNrZ3JvdW5kUGFnZXMoY29uc3RhbnRzLlRBQlNfT05SRU1PVkVELCB0YWJJZClcbiAgfSlcbn1cblxuLy8gSGFuZGxlIHRoZSBjaHJvbWUuKiBBUEkgbWVzc2FnZXMuXG5sZXQgbmV4dElkID0gMFxuXG5pcGNNYWluLm9uKGNvbnN0YW50cy5SVU5USU1FX0NPTk5FQ1QsIGZ1bmN0aW9uIChldmVudCwgZXh0ZW5zaW9uSWQsIGNvbm5lY3RJbmZvLCB1cmwpIHtcbiAgY29uc3QgcGFnZSA9IGJhY2tncm91bmRQYWdlc1tleHRlbnNpb25JZF1cbiAgaWYgKCFwYWdlKSB7XG4gICAgY29uc29sZS5lcnJvcihgQ29ubmVjdCB0byB1bmtub3duIGV4dGVuc2lvbiAke2V4dGVuc2lvbklkfWApXG4gICAgcmV0dXJuXG4gIH1cblxuICBjb25zdCBwb3J0SWQgPSArK25leHRJZFxuICBldmVudC5yZXR1cm5WYWx1ZSA9IHsgdGFiSWQ6IHBhZ2Uud2ViQ29udGVudHMuaWQsIHBvcnRJZCB9XG5cbiAgZXZlbnQuc2VuZGVyLm9uY2UoJ3JlbmRlci12aWV3LWRlbGV0ZWQnLCAoKSA9PiB7XG4gICAgaWYgKHBhZ2Uud2ViQ29udGVudHMuaXNEZXN0cm95ZWQoKSkgcmV0dXJuXG4gICAgcGFnZS53ZWJDb250ZW50cy5zZW5kVG9BbGwoYCR7Y29uc3RhbnRzLlBPUlRfRElTQ09OTkVDVF99JHtwb3J0SWR9YClcbiAgfSlcbiAgcGFnZS53ZWJDb250ZW50cy5zZW5kVG9BbGwoYCR7Y29uc3RhbnRzLlJVTlRJTUVfT05DT05ORUNUX30ke2V4dGVuc2lvbklkfWAsIGV2ZW50LnNlbmRlci5pZCwgcG9ydElkLCBjb25uZWN0SW5mbywgdXJsKVxufSlcblxuaXBjTWFpbi5vbihjb25zdGFudHMuSTE4Tl9NQU5JRkVTVCwgZnVuY3Rpb24gKGV2ZW50LCBleHRlbnNpb25JZCkge1xuICBldmVudC5yZXR1cm5WYWx1ZSA9IG1hbmlmZXN0TWFwW2V4dGVuc2lvbklkXVxufSlcblxubGV0IHJlc3VsdElEID0gMVxuaXBjTWFpbi5vbihjb25zdGFudHMuUlVOVElNRV9TRU5ETUVTU0FHRSwgZnVuY3Rpb24gKGNvbnRlbnRTY3JpcHRFdmVudCwgZXh0ZW5zaW9uSWQsIG1lc3NhZ2UsIG9yaWdpblJlc3VsdElEKSB7XG4gIGNvbnN0IHBhZ2UgPSBiYWNrZ3JvdW5kUGFnZXNbZXh0ZW5zaW9uSWRdXG4gIGlmICghcGFnZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoYENvbm5lY3QgdG8gdW5rbm93biBleHRlbnNpb24gJHtleHRlbnNpb25JZH1gKVxuICAgIHJldHVyblxuICB9XG5cbiAgcGFnZS53ZWJDb250ZW50cy5zZW5kVG9BbGwoYCR7Y29uc3RhbnRzLlJVTlRJTUVfT05NRVNTQUdFX30ke2V4dGVuc2lvbklkfWAsIGNvbnRlbnRTY3JpcHRFdmVudC5zZW5kZXIuaWQsIG1lc3NhZ2UsIHJlc3VsdElEKVxuICBpcGNNYWluLm9uY2UoYCR7Y29uc3RhbnRzLlJVTlRJTUVfT05NRVNTQUdFX1JFU1VMVF99JHtyZXN1bHRJRH1gLCAoYmFja2dyb3VuZFBhZ2VFdmVudCwgcmVzdWx0KSA9PiB7XG4gICAgY29udGVudFNjcmlwdEV2ZW50LnNlbmRlci5zZW5kKGAke2NvbnN0YW50cy5SVU5USU1FX1NFTkRNRVNTQUdFX1JFU1VMVF99JHtvcmlnaW5SZXN1bHRJRH1gLCByZXN1bHQpXG4gIH0pXG4gIHJlc3VsdElEKytcbn0pXG5cbmlwY01haW4ub24oY29uc3RhbnRzLlRBQlNfU0VORF9NRVNTQUdFLCBmdW5jdGlvbiAoZXZlbnQsIHRhYklkLCBleHRlbnNpb25JZCwgaXNCYWNrZ3JvdW5kUGFnZSwgbWVzc2FnZSwgb3JpZ2luUmVzdWx0SUQpIHtcbiAgY29uc3QgY29udGVudHMgPSB3ZWJDb250ZW50cy5mcm9tSWQodGFiSWQpXG4gIGlmICghY29udGVudHMpIHtcbiAgICBjb25zb2xlLmVycm9yKGBTZW5kaW5nIG1lc3NhZ2UgdG8gdW5rbm93biB0YWIgJHt0YWJJZH1gKVxuICAgIHJldHVyblxuICB9XG5cbiAgY29uc3Qgc2VuZGVyVGFiSWQgPSBpc0JhY2tncm91bmRQYWdlID8gbnVsbCA6IGV2ZW50LnNlbmRlci5pZFxuXG4gIGNvbnRlbnRzLnNlbmRUb0FsbChgJHtjb25zdGFudHMuUlVOVElNRV9PTk1FU1NBR0VffSR7ZXh0ZW5zaW9uSWR9YCwgc2VuZGVyVGFiSWQsIG1lc3NhZ2UsIHJlc3VsdElEKVxuICBpcGNNYWluLm9uY2UoYCR7Y29uc3RhbnRzLlJVTlRJTUVfT05NRVNTQUdFX1JFU1VMVF99JHtyZXN1bHRJRH1gLCAoZXZlbnRSZXN1bHQsIHJlc3VsdCkgPT4ge1xuICAgIGV2ZW50UmVzdWx0LnNlbmRlci5zZW5kKGAke2NvbnN0YW50cy5UQUJTX1NFTkRfTUVTU0FHRV9SRVNVTFRffSR7b3JpZ2luUmVzdWx0SUR9YCwgcmVzdWx0KVxuICB9KVxuICByZXN1bHRJRCsrXG59KVxuXG5pcGNNYWluLm9uKGNvbnN0YW50cy5UQUJTX0VYRUNVVEVTQ1JJUFQsIGZ1bmN0aW9uIChldmVudCwgcmVxdWVzdElkLCB0YWJJZCwgZXh0ZW5zaW9uSWQsIGRldGFpbHMpIHtcbiAgY29uc3QgY29udGVudHMgPSB3ZWJDb250ZW50cy5mcm9tSWQodGFiSWQpXG4gIGlmICghY29udGVudHMpIHtcbiAgICBjb25zb2xlLmVycm9yKGBTZW5kaW5nIG1lc3NhZ2UgdG8gdW5rbm93biB0YWIgJHt0YWJJZH1gKVxuICAgIHJldHVyblxuICB9XG5cbiAgbGV0IGNvZGUsIHVybFxuICBpZiAoZGV0YWlscy5maWxlKSB7XG4gICAgY29uc3QgbWFuaWZlc3QgPSBtYW5pZmVzdE1hcFtleHRlbnNpb25JZF1cbiAgICBjb2RlID0gU3RyaW5nKGZzLnJlYWRGaWxlU3luYyhwYXRoLmpvaW4obWFuaWZlc3Quc3JjRGlyZWN0b3J5LCBkZXRhaWxzLmZpbGUpKSlcbiAgICB1cmwgPSBgJHtjb25zdGFudHMuRVhURU5TSU9OX1BST1RPQ09MfTovLyR7ZXh0ZW5zaW9uSWR9JHtkZXRhaWxzLmZpbGV9YFxuICB9IGVsc2Uge1xuICAgIGNvZGUgPSBkZXRhaWxzLmNvZGVcbiAgICB1cmwgPSBgJHtjb25zdGFudHMuRVhURU5TSU9OX1BST1RPQ09MfTovLyR7ZXh0ZW5zaW9uSWR9LyR7U3RyaW5nKE1hdGgucmFuZG9tKCkpLnN1YnN0cigyLCA4KX0uanNgXG4gIH1cblxuICBjb250ZW50cy5zZW5kKGNvbnN0YW50cy5UQUJTX0VYRUNVVEVTQ1JJUFQsIGV2ZW50LnNlbmRlci5pZCwgcmVxdWVzdElkLCBleHRlbnNpb25JZCwgdXJsLCBjb2RlKVxufSlcblxuaXBjTWFpbi5vbihcbiAgY29uc3RhbnRzLlRBQlNfUVVFUlksXG4gIGZ1bmN0aW9uIChldmVudCwgcmVxdWVzdElkLCBfZXh0ZW5zaW9uSWQpIHtcbiAgICBjb25zdCB0YWJzID0gd2ViQ29udGVudHMuZ2V0QWxsV2ViQ29udGVudHMoKVxuICAgICAgLmZpbHRlcih3YyA9PiB3Yy5nZXRUeXBlKCkgPT09ICd3ZWJ2aWV3JylcbiAgICAgIC5tYXAod2NBc1RhYilcblxuICAgIGV2ZW50LnNlbmRlci5zZW5kKGAke2NvbnN0YW50cy5UQUJTX1FVRVJZX1JFU1VMVF99JHtyZXF1ZXN0SWR9YCwgdGFicyk7XG4gIH1cbik7XG5cbmlwY01haW4ub24oXG4gIGNvbnN0YW50cy5UQUJTX0dFVCxcbiAgZnVuY3Rpb24gKGV2ZW50LCByZXF1ZXN0SWQsIF9leHRlbnNpb25JZCwgdGFiSWQpIHtcbiAgICBjb25zdCB3YyA9IHdlYkNvbnRlbnRzLmdldEFsbFdlYkNvbnRlbnRzKClcbiAgICAgIC5maW5kKHdjID0+IHdjLmlkID09PSB0YWJJZCk7XG5cbiAgICBpZiAod2MpIHtcbiAgICAgIGV2ZW50LnNlbmRlci5zZW5kKGAke2NvbnN0YW50cy5UQUJTX0dFVF9SRVNVTFRffSR7cmVxdWVzdElkfWAsIHdjQXNUYWIod2MpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZXZlbnQuc2VuZGVyLnNlbmQoYCR7Y29uc3RhbnRzLlRBQlNfR0VUX1JFU1VMVF99JHtyZXF1ZXN0SWR9YCwgdW5kZWZpbmVkKTtcbiAgICB9XG4gIH1cbik7XG5cbmlwY01haW4ub24oY29uc3RhbnRzLlJVTlRJTUVfR0VUX01BTklGRVNULCAoZXZlbnQsIGV4dGVuc2lvbklkKSA9PiB7XG4gIGV2ZW50LnJldHVyblZhbHVlID0gbWFuaWZlc3RNYXBbZXh0ZW5zaW9uSWRdO1xufSlcblxuLy8gVHJhbnNmZXIgdGhlIGNvbnRlbnQgc2NyaXB0cyB0byByZW5kZXJlci5cbmNvbnN0IGNvbnRlbnRTY3JpcHRzID0ge31cblxuY29uc3QgaW5qZWN0Q29udGVudFNjcmlwdHMgPSBmdW5jdGlvbiAobWFuaWZlc3QpIHtcbiAgaWYgKGNvbnRlbnRTY3JpcHRzW21hbmlmZXN0Lm5hbWVdIHx8ICFtYW5pZmVzdC5jb250ZW50X3NjcmlwdHMpIHJldHVyblxuXG4gIGNvbnN0IHJlYWRBcnJheU9mRmlsZXMgPSBmdW5jdGlvbiAocmVsYXRpdmVQYXRoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHVybDogYCR7Y29uc3RhbnRzLkVYVEVOU0lPTl9QUk9UT0NPTH06Ly8ke21hbmlmZXN0LmV4dGVuc2lvbklkfSR7cmVsYXRpdmVQYXRofWAsXG4gICAgICBjb2RlOiBTdHJpbmcoZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbihtYW5pZmVzdC5zcmNEaXJlY3RvcnksIHJlbGF0aXZlUGF0aCkpKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGNvbnRlbnRTY3JpcHRUb0VudHJ5ID0gZnVuY3Rpb24gKHNjcmlwdCkge1xuICAgIHJldHVybiB7XG4gICAgICBtYXRjaGVzOiBzY3JpcHQubWF0Y2hlcyxcbiAgICAgIGV4Y2x1ZGVfbWF0Y2hlczogc2NyaXB0LmV4Y2x1ZGVfbWF0Y2hlcyxcbiAgICAgIGpzOiBzY3JpcHQuanMgPyBzY3JpcHQuanMubWFwKHJlYWRBcnJheU9mRmlsZXMpIDogW10sXG4gICAgICBjc3M6IHNjcmlwdC5jc3MgPyBzY3JpcHQuY3NzLm1hcChyZWFkQXJyYXlPZkZpbGVzKSA6IFtdLFxuICAgICAgcnVuQXQ6IHNjcmlwdC5ydW5fYXQgfHwgJ2RvY3VtZW50X2lkbGUnXG4gICAgfVxuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBlbnRyeSA9IHtcbiAgICAgIGV4dGVuc2lvbklkOiBtYW5pZmVzdC5leHRlbnNpb25JZCxcbiAgICAgIGV4dGVuc2lvbk5hbWU6IG1hbmlmZXN0Lm5hbWUsXG4gICAgICBjb250ZW50U2NyaXB0czogbWFuaWZlc3QuY29udGVudF9zY3JpcHRzLm1hcChjb250ZW50U2NyaXB0VG9FbnRyeSlcbiAgICB9XG4gICAgY29udGVudFNjcmlwdHNbbWFuaWZlc3QubmFtZV0gPSBlbnRyeTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byByZWFkIGNvbnRlbnQgc2NyaXB0cycsIGUpXG4gIH1cbn1cblxuY29uc3QgY29udGVudFNlY3VyaXR5UG9saWN5ID0ge1xuICBleHRlbnNpb25JZDogdW5kZWZpbmVkLFxuICBwb2xpY3k6IHVuZGVmaW5lZFxufVxuXG5jb25zdCBpbmplY3RDb250ZW50U2VjdXJpdHlQb2xpY3kgPSBmdW5jdGlvbiAobWFuaWZlc3QpIHtcbiAgaWYgKCFtYW5pZmVzdC5jb250ZW50X3NlY3VyaXR5X3BvbGljeSkgcmV0dXJuXG5cbiAgY29udGVudFNlY3VyaXR5UG9saWN5LmV4dGVuc2lvbklkID0gbWFuaWZlc3QuZXh0ZW5zaW9uSWQ7XG4gIGNvbnRlbnRTZWN1cml0eVBvbGljeS5wb2xpY3kgPSBtYW5pZmVzdC5jb250ZW50X3NlY3VyaXR5X3BvbGljeTtcbn1cblxuY29uc3QgcmVtb3ZlQ29udGVudFNjcmlwdHMgPSBmdW5jdGlvbiAobWFuaWZlc3QpIHtcbiAgaWYgKCFjb250ZW50U2NyaXB0c1ttYW5pZmVzdC5uYW1lXSkgcmV0dXJuXG5cbiAgZGVsZXRlIGNvbnRlbnRTY3JpcHRzW21hbmlmZXN0Lm5hbWVdXG59XG5cbmlwY01haW4ub24oJ0dFVF9DT05URU5UU0NSSVBUU19TWU5DJywgZSA9PiB7XG4gIGUucmV0dXJuVmFsdWUgPSBjb250ZW50U2NyaXB0cztcbn0pXG5cbmlwY01haW4ub24oJ0dFVF9DT05URU5UU0VDVVJJVFlQT0xJQ1lfU1lOQycsIGUgPT4ge1xuICBlLnJldHVyblZhbHVlID0gY29udGVudFNlY3VyaXR5UG9saWN5O1xufSlcblxuLy8gVHJhbnNmZXIgdGhlIHxtYW5pZmVzdHwgdG8gYSBmb3JtYXQgdGhhdCBjYW4gYmUgcmVjb2duaXplZCBieSB0aGVcbi8vIHxEZXZUb29sc0FQSS5hZGRFeHRlbnNpb25zfC5cbmNvbnN0IG1hbmlmZXN0VG9FeHRlbnNpb25JbmZvID0gZnVuY3Rpb24gKG1hbmlmZXN0KSB7XG4gIHJldHVybiB7XG4gICAgc3RhcnRQYWdlOiBtYW5pZmVzdC5zdGFydFBhZ2UsXG4gICAgc3JjRGlyZWN0b3J5OiBtYW5pZmVzdC5zcmNEaXJlY3RvcnksXG4gICAgbmFtZTogbWFuaWZlc3QubmFtZSxcbiAgICBleHBvc2VFeHBlcmltZW50YWxBUElzOiB0cnVlXG4gIH1cbn1cblxuLy8gTG9hZCB0aGUgZXh0ZW5zaW9ucyBmb3IgdGhlIHdpbmRvdy5cbmNvbnN0IGxvYWRFeHRlbnNpb24gPSBmdW5jdGlvbiAobWFuaWZlc3QpIHtcbiAgY29uc3QgeyBleHRlbnNpb25JZCB9ID0gbWFuaWZlc3Q7XG5cbiAgaWYgKCEoZXh0ZW5zaW9uSWQgaW4gYXBpSGFuZGxlcnNNYXApKSB7XG4gICAgYXBpSGFuZGxlcnNNYXBbZXh0ZW5zaW9uSWRdID0gbmV3IENocm9tZUFQSUhhbmRsZXIoZXh0ZW5zaW9uSWQsIHNlbmRFdmVudFRvRXh0ZW5zaW9ucyk7XG4gIH1cblxuICBzdGFydEJhY2tncm91bmRQYWdlcyhtYW5pZmVzdClcbiAgaW5qZWN0Q29udGVudFNjcmlwdHMobWFuaWZlc3QpXG4gIGluamVjdENvbnRlbnRTZWN1cml0eVBvbGljeShtYW5pZmVzdClcbn1cblxuY29uc3QgbG9hZERldlRvb2xzRXh0ZW5zaW9ucyA9IGZ1bmN0aW9uICh3aW4sIG1hbmlmZXN0cykge1xuICBpZiAoIXdpbi5kZXZUb29sc1dlYkNvbnRlbnRzKSByZXR1cm5cblxuICBtYW5pZmVzdHMuZm9yRWFjaChsb2FkRXh0ZW5zaW9uKVxuXG4gIGNvbnN0IGV4dGVuc2lvbkluZm9BcnJheSA9IG1hbmlmZXN0cy5tYXAobWFuaWZlc3RUb0V4dGVuc2lvbkluZm8pXG4gIGV4dGVuc2lvbkluZm9BcnJheS5mb3JFYWNoKChleHRlbnNpb24pID0+IHtcbiAgICB3aW4uZGV2VG9vbHNXZWJDb250ZW50cy5fZ3JhbnRPcmlnaW5BY2Nlc3MoZXh0ZW5zaW9uLnN0YXJ0UGFnZSlcbiAgfSlcbiAgLy8gcmVmOiBodHRwczovL2dpdGh1Yi5jb20vZWxlY3Ryb24vZWxlY3Ryb24vcHVsbC8xNzYxNC9maWxlcyNkaWZmLThkODVjNjUxY2IwZmI4ZmVlZjJjNDY5NGQ1MmRhMmUzUjQwMFxuICB3aW4uZGV2VG9vbHNXZWJDb250ZW50cy5leGVjdXRlSmF2YVNjcmlwdChgSW5zcGVjdG9yRnJvbnRlbmRBUEkuYWRkRXh0ZW5zaW9ucygke0pTT04uc3RyaW5naWZ5KGV4dGVuc2lvbkluZm9BcnJheSl9KWApXG59XG5cbmFwcC5vbignd2ViLWNvbnRlbnRzLWNyZWF0ZWQnLCBmdW5jdGlvbiAoZXZlbnQsIHdlYkNvbnRlbnRzKSB7XG4gIGlmICghaXNXaW5kb3dPcldlYlZpZXcod2ViQ29udGVudHMpKSByZXR1cm5cblxuICBob29rV2ViQ29udGVudHNFdmVudHMod2ViQ29udGVudHMpXG4gIHdlYkNvbnRlbnRzLm9uKCdkZXZ0b29scy1vcGVuZWQnLCBmdW5jdGlvbiAoKSB7XG4gICAgbG9hZERldlRvb2xzRXh0ZW5zaW9ucyh3ZWJDb250ZW50cywgb2JqZWN0VmFsdWVzKG1hbmlmZXN0TWFwKSlcbiAgfSlcbn0pXG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBzZW5kRXZlbnRUb0V4dGVuc2lvbnMsXG5cbiAgLy8gc2hvdWxkIGJlIHJlbW92ZWQgd2hlbiB3ZSBoYXZlIGEgdHlwZWQgZXh0ZW5zaW9ucyBtZW1vcnkgc3RvcmVcbiAgZ2V0RXh0ZW5zaW9uQnlJZDogZnVuY3Rpb24gKGV4dGVuc2lvbklkKSB7XG4gICAgY29uc3QgYmdFeHQgPSBiYWNrZ3JvdW5kUGFnZXNbZXh0ZW5zaW9uSWRdXG5cbiAgICBpZiAoYmdFeHQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHNyYzogYmdFeHQuc3JjLFxuICAgICAgICBiYWNrZ3JvdW5kUGFnZToge1xuICAgICAgICAgIG5hbWU6IGJnRXh0Lm5hbWUsXG4gICAgICAgICAgaHRtbDogYmdFeHQuaHRtbCxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgbWFuaWZlc3QgPSBtYW5pZmVzdFdTTWFwW2V4dGVuc2lvbklkXTtcblxuICAgIGlmIChtYW5pZmVzdCkge1xuICAgICAgY29uc3QgZXh0ID0gYmFja2dyb3VuZFBhZ2VzW21hbmlmZXN0LmV4dGVuc2lvbklkXVxuXG4gICAgICBpZiAoZXh0KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3JjOiBleHQuc3JjLFxuICAgICAgICAgIGJhY2tncm91bmRQYWdlOiB7XG4gICAgICAgICAgICBuYW1lOiBleHQubmFtZSxcbiAgICAgICAgICAgIGh0bWw6IGV4dC5odG1sLFxuICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfSxcbiAgLy8gVGhlIHB1YmxpYyBBUEkgdG8gYWRkL3JlbW92ZSBleHRlbnNpb25zLlxuICBhZGRFeHRlbnNpb246IGZ1bmN0aW9uIChleHRlbnNpb25JZCwgc3JjRGlyZWN0b3J5KSB7XG4gICAgY29uc3QgbWFuaWZlc3QgPSBnZXRNYW5pZmVzdEZyb21QYXRoKGV4dGVuc2lvbklkLCBzcmNEaXJlY3RvcnkpXG4gICAgaWYgKG1hbmlmZXN0KSB7XG4gICAgICBsb2FkRXh0ZW5zaW9uKG1hbmlmZXN0KVxuICAgICAgZm9yIChjb25zdCB3ZWJDb250ZW50cyBvZiBnZXRBbGxXZWJDb250ZW50cygpKSB7XG4gICAgICAgIGlmIChpc1dpbmRvd09yV2ViVmlldyh3ZWJDb250ZW50cykpIHtcbiAgICAgICAgICBsb2FkRGV2VG9vbHNFeHRlbnNpb25zKHdlYkNvbnRlbnRzLCBbbWFuaWZlc3RdKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gbWFuaWZlc3QubmFtZVxuICAgIH1cbiAgfSxcblxuICByZW1vdmVFeHRlbnNpb246IGZ1bmN0aW9uIChpZCkge1xuICAgIGNvbnN0IG1hbmlmZXN0ID0gbWFuaWZlc3RXU01hcFtpZF07XG5cbiAgICBpZiAoIW1hbmlmZXN0KSByZXR1cm5cbiAgICBjb25zdCB7IGV4dGVuc2lvbklkIH0gPSBtYW5pZmVzdDtcblxuICAgIGFwaUhhbmRsZXJzTWFwW2V4dGVuc2lvbklkXS5yZWxlYXNlKCk7XG4gICAgZGVsZXRlIGFwaUhhbmRsZXJzTWFwW2V4dGVuc2lvbklkXTtcblxuICAgIHJlbW92ZUJhY2tncm91bmRQYWdlcyhtYW5pZmVzdClcbiAgICByZW1vdmVDb250ZW50U2NyaXB0cyhtYW5pZmVzdClcbiAgICBkZWxldGUgbWFuaWZlc3RNYXBbbWFuaWZlc3QuZXh0ZW5zaW9uSWRdXG4gICAgZGVsZXRlIG1hbmlmZXN0TmFtZU1hcFttYW5pZmVzdC5uYW1lXVxuICAgIGRlbGV0ZSBtYW5pZmVzdFdTTWFwW2lkXTtcbiAgfSxcbn1cbiJdfQ==
