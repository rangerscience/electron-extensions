"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const electron_1 = require("electron");
const electron_better_web_request_1 = tslib_1.__importDefault(require("electron-better-web-request"));
// @ts-ignore
const recursive_lowercase_json_1 = tslib_1.__importDefault(require("recursive-lowercase-json"));
// @ts-ignore
const content_security_policy_parser_1 = tslib_1.__importDefault(require("content-security-policy-parser"));
const common_1 = require("../../common");
const utils_1 = require("../../common/utils");
/**
 * Convert object of policies into content security policy heder value
 *
 * @example
 * {
 * 'default-src': ["'self'"],
 * 'script-src': ["'unsafe-eval'", 'scripts.com'],
 * 'object-src': [],
 * 'style-src': ['styles.biz']
 * } => "default-src 'self'; script-src 'unsafe-eval' scripts.com; object-src; style-src styles.biz"
 *
 * @param { [name: string]: string[] } policies policies as object
 * @return {string} the stringified policies
 */
const stringify = (policies) => Object.entries(policies)
    .map(([name, value]) => `${name} ${value.join(' ')}`)
    .join(';');
const requestIsXhrOrSubframe = (details) => {
    const { resourcetype } = details;
    const isXhr = resourcetype === 'xhr';
    const isSubframe = resourcetype === 'subFrame';
    return isXhr || isSubframe;
};
const requestHasExtensionOrigin = (details) => {
    const { headers: { origin } } = details;
    if (origin) {
        return origin.startsWith(common_1.Protocol.Extension);
    }
    return false;
};
const requestIsFromBackgroundPage = (details) => {
    const { webcontentsid } = details;
    if (webcontentsid) {
        const wc = electron_1.webContents.fromId(webcontentsid);
        if (wc) {
            return wc.getURL().startsWith(common_1.Protocol.Extension);
        }
        return false;
    }
    return false;
};
const requestIsOption = (details) => {
    const { method } = details;
    return method === 'OPTIONS';
};
const requestIsForExtension = (details) => requestHasExtensionOrigin(details) && requestIsXhrOrSubframe(details);
const requestsOrigins = new Map();
electron_1.app.on('session-created', (session) => {
    electron_better_web_request_1.default(session);
    /**
     * Capture origin header to override CSP on response received
     * See comment below for full explanation
     * Capture in two listeners: onBeforeRequest and onBeforeSendHeaders
     * since some requests with custom protocol are not catched
     * in the onBeforeSendHeaders listener but in onBeforeRequest
     */
    session.webRequest.onBeforeRequest(
    // @ts-ignore
    (details, callback) => {
        Object.assign(details, {headers: {}})
        const formattedDetails = recursive_lowercase_json_1.default(details);
        console.log(details, formattedDetails)
        const { id, headers: { origin } } = formattedDetails;
        requestsOrigins.set(id, origin);
        callback({
            cancel: false,
        });
    }, {
        origin: 'ecx-cors',
    });
    session.webRequest.onBeforeSendHeaders(
    // @ts-ignore
    (details, callback) => {
        const formattedDetails = recursive_lowercase_json_1.default(details);
        const { id, headers: { origin } } = formattedDetails;
        requestsOrigins.set(id, origin);
        if (!requestIsFromBackgroundPage(formattedDetails) && requestIsForExtension(formattedDetails)
            && !requestIsOption(formattedDetails)) {
            return callback({
                cancel: false,
                requestHeaders: Object.assign({}, formattedDetails.requestheaders, { origin: ['null'] }),
            });
        }
        callback({
            cancel: false,
            requestHeaders: formattedDetails.requestheaders,
        });
    }, {
        origin: 'ecx-cors',
    });
    session.webRequest.onHeadersReceived(
    // @ts-ignore
    (details, callback) => {
        const formattedDetails = recursive_lowercase_json_1.default(details);
        const { id, responseheaders } = formattedDetails;
        const headers = new Map(Object.entries(responseheaders));
        // Override Content Security Policy Header
        //
        // `chrome-extension://` is registered as privilegied
        // with `webFrame.registerURLSchemeAsPrivileged()`
        // but added iFrames with extension protocol
        // don't bypass top frame CSP frame-src policy
        //
        // ref: https://bugs.chromium.org/p/chromium/issues/detail?id=408932#c35
        // todo: remove this block since Electron 5 fix the problem
        //
        // * Protocol `chrome-extension://` is considered trustworthy
        // ref: https://w3c.github.io/webappsec-secure-contexts/#is-origin-trustworthy
        //
        // * Protocol can bypass secure context check
        // ref: //src/chrome/common/secure_origin_whitelist.cc
        // https://cs.chromium.org/chromium/src/chrome/common/secure_origin_whitelist.cc?l=16
        //
        // * Protocol added to the Renderer Web Secure Context Safelist
        // ref: //src/chrome/renderer/chrome_content_renderer_client.cc
        // https://cs.chromium.org/chromium/src/chrome/renderer/chrome_content_renderer_client.cc?l=428
        //
        // * Protocol should bypass CSP check
        // ref: //src/third_party/blink/renderer/core/frame/csp/content_security_policy.cc?l=706
        // https://cs.chromium.org/chromium/src/third_party/blink/renderer/core/frame/csp/content_security_policy.cc?l=1557
        //
        // * Secure Directive Values
        // ref: //src/extensions/common/csp_validator.cc
        // https://cs.chromium.org/chromium/src/extensions/common/csp_validator.cc?l=256
        const cspHeaderKey = 'content-security-policy';
        const cspPolicyKey = 'frame-src';
        const cspDirective = (responseheaders[cspHeaderKey] || [])[0];
        if (cspDirective) {
            const policies = content_security_policy_parser_1.default(cspDirective);
            const frameSrcPolicy = policies[cspPolicyKey];
            if (frameSrcPolicy) {
                const policiesWithOverride = Object.assign({}, policies, { [cspPolicyKey]: [...frameSrcPolicy, common_1.Protocol.Extension] });
                headers.set(cspHeaderKey, [stringify(policiesWithOverride)]);
            }
        }
        // End override CSP iframe-src policy
        const accessControlAllowOrigin = responseheaders['access-control-allow-origin'] || [];
        const allowedOriginIsWildcard = accessControlAllowOrigin.includes('*');
        // Code block for bypass preflight CORS check like Wavebox is doing it
        // `chrome-extension://` requests doesn't bypass CORS
        // check like in Chromium
        //
        // refs:
        // https://fetch.spec.whatwg.org/#cors-check
        // https://cs.chromium.org/chromium/src/extensions/common/cors_util.h?rcl=faf5cf5cb5985875dedd065d852b35a027e50914&l=21
        // https://github.com/wavebox/waveboxapp/blob/09f791314e1ecc808cbbf919ac65e5f6dda785bd/src/app/src/Extensions/Chrome/CRExtensionRuntime/CRExtensionBackgroundPage.js#L195
        // todo(hugo): find a better and understandable solution
        if (requestIsForExtension(formattedDetails)
            || allowedOriginIsWildcard) {
            headers.set('access-control-allow-credentials', ['true']);
            headers.set('access-control-allow-origin', [requestsOrigins.get(id)]);
        }
        else {
            headers.set('access-control-allow-credentials', ['true']);
        }
        requestsOrigins.delete(id);
        callback({
            cancel: false,
            responseHeaders: utils_1.fromEntries(headers),
        });
    }, {
        origin: 'ecx-cors',
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2ViUmVxdWVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL2VuZ2luZS93ZWJSZXF1ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHVDQUE0QztBQUM1QyxzR0FBNEQ7QUFDNUQsYUFBYTtBQUNiLGdHQUFvRTtBQUNwRSxhQUFhO0FBQ2IsNEdBQW1EO0FBRW5ELHlDQUF3QztBQUN4Qyw4Q0FBaUQ7QUFFakQ7Ozs7Ozs7Ozs7Ozs7R0FhRztBQUNILE1BQU0sU0FBUyxHQUFHLENBQUMsUUFBc0MsRUFBVSxFQUFFLENBQ25FLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDO0tBQ3JCLEdBQUcsQ0FDRixDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBcUIsRUFBRSxFQUFFLENBQ3BDLEdBQUcsSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FDL0I7S0FDQSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFFZixNQUFNLHNCQUFzQixHQUFHLENBQUMsT0FBWSxFQUFFLEVBQUU7SUFDOUMsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLE9BQU8sQ0FBQztJQUVqQyxNQUFNLEtBQUssR0FBRyxZQUFZLEtBQUssS0FBSyxDQUFDO0lBQ3JDLE1BQU0sVUFBVSxHQUFHLFlBQVksS0FBSyxVQUFVLENBQUM7SUFFL0MsT0FBTyxLQUFLLElBQUksVUFBVSxDQUFDO0FBQzdCLENBQUMsQ0FBQztBQUVGLE1BQU0seUJBQXlCLEdBQUcsQ0FBQyxPQUFZLEVBQUUsRUFBRTtJQUNqRCxNQUFNLEVBQUUsT0FBTyxFQUFFLEVBQUUsTUFBTSxFQUFFLEVBQUUsR0FBRyxPQUFPLENBQUM7SUFFeEMsSUFBSSxNQUFNLEVBQUU7UUFDVixPQUFPLE1BQU0sQ0FBQyxVQUFVLENBQUMsaUJBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUM5QztJQUVELE9BQU8sS0FBSyxDQUFDO0FB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QUFHLENBQUMsWUFBWSxFQUFFLENBQUMsU0FBUyxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzlEO1NBQ0Y7UUFDRCxxQ0FBcUM7UUFFckMsTUFBTSx3QkFBd0IsR0FBRyxlQUFlLENBQUMsNkJBQTZCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDdEYsTUFBTSx1QkFBdUIsR0FBRyx3QkFBd0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFdkUsc0VBQXNFO1FBQ3RFLHFEQUFxRDtRQUNyRCx5QkFBeUI7UUFDekIsRUFBRTtRQUNGLFFBQVE7UUFDUiw0Q0FBNEM7UUFDNUMsdUhBQXVIO1FBQ3ZILHlLQUF5SztRQUN6Syx3REFBd0Q7UUFDeEQsSUFBSSxxQkFBcUIsQ0FBQyxnQkFBZ0IsQ0FBQztlQUN0Qyx1QkFBdUIsRUFBRTtZQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDLGtDQUFrQyxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUMxRCxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUUsQ0FBQyxDQUFDLENBQUM7U0FDeEU7YUFBTTtZQUNMLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0NBQWtDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1NBQzNEO1FBRUQsZUFBZSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUUzQixRQUFRLENBQUM7WUFDUCxNQUFNLEVBQUUsS0FBSztZQUNiLGVBQWUsRUFBRSxtQkFBVyxDQUFDLE9BQU8sQ0FBQztTQUN0QyxDQUFDLENBQUM7SUFDTCxDQUFDLEVBQ0Q7UUFDRSxNQUFNLEVBQUUsVUFBVTtLQUNuQixDQUNGLENBQUM7QUFDSixDQUFDLENBQ0YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFwcCwgd2ViQ29udGVudHMgfSBmcm9tICdlbGVjdHJvbic7XG5pbXBvcnQgZW5oYW5jZVdlYlJlcXVlc3QgZnJvbSAnZWxlY3Ryb24tYmV0dGVyLXdlYi1yZXF1ZXN0Jztcbi8vIEB0cy1pZ25vcmVcbmltcG9ydCByZWN1cnNpdmVseUxvd2VyY2FzZUpTT05LZXlzIGZyb20gJ3JlY3Vyc2l2ZS1sb3dlcmNhc2UtanNvbic7XG4vLyBAdHMtaWdub3JlXG5pbXBvcnQgcGFyc2UgZnJvbSAnY29udGVudC1zZWN1cml0eS1wb2xpY3ktcGFyc2VyJztcblxuaW1wb3J0IHsgUHJvdG9jb2wgfSBmcm9tICcuLi8uLi9jb21tb24nO1xuaW1wb3J0IHsgZnJvbUVudHJpZXMgfSBmcm9tICcuLi8uLi9jb21tb24vdXRpbHMnO1xuXG4vKipcbiAqIENvbnZlcnQgb2JqZWN0IG9mIHBvbGljaWVzIGludG8gY29udGVudCBzZWN1cml0eSBwb2xpY3kgaGVkZXIgdmFsdWVcbiAqXG4gKiBAZXhhbXBsZVxuICoge1xuICogJ2RlZmF1bHQtc3JjJzogW1wiJ3NlbGYnXCJdLFxuICogJ3NjcmlwdC1zcmMnOiBbXCIndW5zYWZlLWV2YWwnXCIsICdzY3JpcHRzLmNvbSddLFxuICogJ29iamVjdC1zcmMnOiBbXSxcbiAqICdzdHlsZS1zcmMnOiBbJ3N0eWxlcy5iaXonXVxuICogfSA9PiBcImRlZmF1bHQtc3JjICdzZWxmJzsgc2NyaXB0LXNyYyAndW5zYWZlLWV2YWwnIHNjcmlwdHMuY29tOyBvYmplY3Qtc3JjOyBzdHlsZS1zcmMgc3R5bGVzLmJpelwiXG4gKlxuICogQHBhcmFtIHsgW25hbWU6IHN0cmluZ106IHN0cmluZ1tdIH0gcG9saWNpZXMgcG9saWNpZXMgYXMgb2JqZWN0XG4gKiBAcmV0dXJuIHtzdHJpbmd9IHRoZSBzdHJpbmdpZmllZCBwb2xpY2llc1xuICovXG5jb25zdCBzdHJpbmdpZnkgPSAocG9saWNpZXM6IHsgW25hbWU6IHN0cmluZ106IHN0cmluZ1tdIH0pOiBzdHJpbmcgPT5cbiAgT2JqZWN0LmVudHJpZXMocG9saWNpZXMpXG4gICAgLm1hcChcbiAgICAgIChbbmFtZSwgdmFsdWVdOiBbc3RyaW5nLCBzdHJpbmdbXV0pID0+XG4gICAgICAgIGAke25hbWV9ICR7dmFsdWUuam9pbignICcpfWBcbiAgICApXG4gICAgLmpvaW4oJzsnKTtcblxuY29uc3QgcmVxdWVzdElzWGhyT3JTdWJmcmFtZSA9IChkZXRhaWxzOiBhbnkpID0+IHtcbiAgY29uc3QgeyByZXNvdXJjZXR5cGUgfSA9IGRldGFpbHM7XG5cbiAgY29uc3QgaXNYaHIgPSByZXNvdXJjZXR5cGUgPT09ICd4aHInO1xuICBjb25zdCBpc1N1YmZyYW1lID0gcmVzb3VyY2V0eXBlID09PSAnc3ViRnJhbWUnO1xuXG4gIHJldHVybiBpc1hociB8fCBpc1N1YmZyYW1lO1xufTtcblxuY29uc3QgcmVxdWVzdEhhc0V4dGVuc2lvbk9yaWdpbiA9IChkZXRhaWxzOiBhbnkpID0+IHtcbiAgY29uc3QgeyBoZWFkZXJzOiB7IG9yaWdpbiB9IH0gPSBkZXRhaWxzO1xuXG4gIGlmIChvcmlnaW4pIHtcbiAgICByZXR1cm4gb3JpZ2luLnN0YXJ0c1dpdGgoUHJvdG9jb2wuRXh0ZW5zaW9uKTtcbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn07XG5cbmNvbnN0IHJlcXVlc3RJc0Zyb21CYWNrZ3JvdW5kUGFnZSA9IChkZXRhaWxzOiBhbnkpOiBib29sZWFuID0+IHtcbiAgY29uc3QgeyB3ZWJjb250ZW50c2lkIH0gPSBkZXRhaWxzO1xuXG4gIGlmICh3ZWJjb250ZW50c2lkKSB7XG4gICAgY29uc3Qgd2MgPSB3ZWJDb250ZW50cy5mcm9tSWQod2ViY29udGVudHNpZCk7XG5cbiAgICBpZiAod2MpIHtcbiAgICAgIHJldHVybiB3Yy5nZXRVUkwoKS5zdGFydHNXaXRoKFByb3RvY29sLkV4dGVuc2lvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcmV0dXJuIGZhbHNlO1xufTtcblxuY29uc3QgcmVxdWVzdElzT3B0aW9uID0gKGRldGFpbHM6IGFueSkgPT4ge1xuICBjb25zdCB7IG1ldGhvZCB9ID0gZGV0YWlscztcblxuICByZXR1cm4gbWV0aG9kID09PSAnT1BUSU9OUyc7XG59O1xuXG5jb25zdCByZXF1ZXN0SXNGb3JFeHRlbnNpb24gPSAoZGV0YWlsczogYW55KSA9PlxuICByZXF1ZXN0SGFzRXh0ZW5zaW9uT3JpZ2luKGRldGFpbHMpICYmIHJlcXVlc3RJc1hock9yU3ViZnJhbWUoZGV0YWlscyk7XG5cbmNvbnN0IHJlcXVlc3RzT3JpZ2lucyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG5cbmFwcC5vbihcbiAgJ3Nlc3Npb24tY3JlYXRlZCcsXG4gIChzZXNzaW9uOiBFbGVjdHJvbi5TZXNzaW9uKSA9PiB7XG4gICAgZW5oYW5jZVdlYlJlcXVlc3Qoc2Vzc2lvbik7XG5cbiAgICAvKipcbiAgICAgKiBDYXB0dXJlIG9yaWdpbiBoZWFkZXIgdG8gb3ZlcnJpZGUgQ1NQIG9uIHJlc3BvbnNlIHJlY2VpdmVkXG4gICAgICogU2VlIGNvbW1lbnQgYmVsb3cgZm9yIGZ1bGwgZXhwbGFuYXRpb25cbiAgICAgKiBDYXB0dXJlIGluIHR3byBsaXN0ZW5lcnM6IG9uQmVmb3JlUmVxdWVzdCBhbmQgb25CZWZvcmVTZW5kSGVhZGVyc1xuICAgICAqIHNpbmNlIHNvbWUgcmVxdWVzdHMgd2l0aCBjdXN0b20gcHJvdG9jb2wgYXJlIG5vdCBjYXRjaGVkXG4gICAgICogaW4gdGhlIG9uQmVmb3JlU2VuZEhlYWRlcnMgbGlzdGVuZXIgYnV0IGluIG9uQmVmb3JlUmVxdWVzdFxuICAgICAqL1xuICAgIHNlc3Npb24ud2ViUmVxdWVzdC5vbkJlZm9yZVJlcXVlc3QoXG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAoZGV0YWlsczogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pID0+IHtcbiAgICAgICAgY29uc3QgZm9ybWF0dGVkRGV0YWlscyA9IHJlY3Vyc2l2ZWx5TG93ZXJjYXNlSlNPTktleXMoZGV0YWlscyk7XG4gICAgICAgIGNvbnN0IHsgaWQsIGhlYWRlcnM6IHsgb3JpZ2luIH0gfSA9IGZvcm1hdHRlZERldGFpbHM7XG5cbiAgICAgICAgcmVxdWVzdHNPcmlnaW5zLnNldChpZCwgb3JpZ2luKTtcblxuICAgICAgICBjYWxsYmFjayh7XG4gICAgICAgICAgY2FuY2VsOiBmYWxzZSxcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBvcmlnaW46ICdlY3gtY29ycycsXG4gICAgICB9XG4gICAgKTtcblxuICAgIHNlc3Npb24ud2ViUmVxdWVzdC5vbkJlZm9yZVNlbmRIZWFkZXJzKFxuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgKGRldGFpbHM6IGFueSwgY2FsbGJhY2s6IEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgIGNvbnN0IGZvcm1hdHRlZERldGFpbHMgPSByZWN1cnNpdmVseUxvd2VyY2FzZUpTT05LZXlzKGRldGFpbHMpO1xuICAgICAgICBjb25zdCB7IGlkLCBoZWFkZXJzOiB7IG9yaWdpbiB9IH0gPSBmb3JtYXR0ZWREZXRhaWxzO1xuXG4gICAgICAgIHJlcXVlc3RzT3JpZ2lucy5zZXQoaWQsIG9yaWdpbik7XG5cbiAgICAgICAgaWYgKCFyZXF1ZXN0SXNGcm9tQmFja2dyb3VuZFBhZ2UoZm9ybWF0dGVkRGV0YWlscykgJiYgcmVxdWVzdElzRm9yRXh0ZW5zaW9uKGZvcm1hdHRlZERldGFpbHMpXG4gICAgICAgICAgJiYgIXJlcXVlc3RJc09wdGlvbihmb3JtYXR0ZWREZXRhaWxzKSkge1xuICAgICAgICAgIHJldHVybiBjYWxsYmFjayh7XG4gICAgICAgICAgICBjYW5jZWw6IGZhbHNlLFxuICAgICAgICAgICAgcmVxdWVzdEhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgLi4uZm9ybWF0dGVkRGV0YWlscy5yZXF1ZXN0aGVhZGVycyxcbiAgICAgICAgICAgICAgb3JpZ2luOiBbJ251bGwnXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjYWxsYmFjayh7XG4gICAgICAgICAgY2FuY2VsOiBmYWxzZSxcbiAgICAgICAgICByZXF1ZXN0SGVhZGVyczogZm9ybWF0dGVkRGV0YWlscy5yZXF1ZXN0aGVhZGVycyxcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBvcmlnaW46ICdlY3gtY29ycycsXG4gICAgICB9XG4gICAgKTtcblxuICAgIHNlc3Npb24ud2ViUmVxdWVzdC5vbkhlYWRlcnNSZWNlaXZlZChcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIChkZXRhaWxzOiBhbnksIGNhbGxiYWNrOiBGdW5jdGlvbikgPT4ge1xuICAgICAgICBjb25zdCBmb3JtYXR0ZWREZXRhaWxzID0gcmVjdXJzaXZlbHlMb3dlcmNhc2VKU09OS2V5cyhkZXRhaWxzKTtcbiAgICAgICAgY29uc3QgeyBpZCwgcmVzcG9uc2VoZWFkZXJzIH0gPSBmb3JtYXR0ZWREZXRhaWxzO1xuXG4gICAgICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nW10+KE9iamVjdC5lbnRyaWVzKHJlc3BvbnNlaGVhZGVycykpO1xuXG4gICAgICAgIC8vIE92ZXJyaWRlIENvbnRlbnQgU2VjdXJpdHkgUG9saWN5IEhlYWRlclxuICAgICAgICAvL1xuICAgICAgICAvLyBgY2hyb21lLWV4dGVuc2lvbjovL2AgaXMgcmVnaXN0ZXJlZCBhcyBwcml2aWxlZ2llZFxuICAgICAgICAvLyB3aXRoIGB3ZWJGcmFtZS5yZWdpc3RlclVSTFNjaGVtZUFzUHJpdmlsZWdlZCgpYFxuICAgICAgICAvLyBidXQgYWRkZWQgaUZyYW1lcyB3aXRoIGV4dGVuc2lvbiBwcm90b2NvbFxuICAgICAgICAvLyBkb24ndCBieXBhc3MgdG9wIGZyYW1lIENTUCBmcmFtZS1zcmMgcG9saWN5XG4gICAgICAgIC8vXG4gICAgICAgIC8vIHJlZjogaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NDA4OTMyI2MzNVxuICAgICAgICAvLyB0b2RvOiByZW1vdmUgdGhpcyBibG9jayBzaW5jZSBFbGVjdHJvbiA1IGZpeCB0aGUgcHJvYmxlbVxuICAgICAgICAvL1xuICAgICAgICAvLyAqIFByb3RvY29sIGBjaHJvbWUtZXh0ZW5zaW9uOi8vYCBpcyBjb25zaWRlcmVkIHRydXN0d29ydGh5XG4gICAgICAgIC8vIHJlZjogaHR0cHM6Ly93M2MuZ2l0aHViLmlvL3dlYmFwcHNlYy1zZWN1cmUtY29udGV4dHMvI2lzLW9yaWdpbi10cnVzdHdvcnRoeVxuICAgICAgICAvL1xuICAgICAgICAvLyAqIFByb3RvY29sIGNhbiBieXBhc3Mgc2VjdXJlIGNvbnRleHQgY2hlY2tcbiAgICAgICAgLy8gcmVmOiAvL3NyYy9jaHJvbWUvY29tbW9uL3NlY3VyZV9vcmlnaW5fd2hpdGVsaXN0LmNjXG4gICAgICAgIC8vIGh0dHBzOi8vY3MuY2hyb21pdW0ub3JnL2Nocm9taXVtL3NyYy9jaHJvbWUvY29tbW9uL3NlY3VyZV9vcmlnaW5fd2hpdGVsaXN0LmNjP2w9MTZcbiAgICAgICAgLy9cbiAgICAgICAgLy8gKiBQcm90b2NvbCBhZGRlZCB0byB0aGUgUmVuZGVyZXIgV2ViIFNlY3VyZSBDb250ZXh0IFNhZmVsaXN0XG4gICAgICAgIC8vIHJlZjogLy9zcmMvY2hyb21lL3JlbmRlcmVyL2Nocm9tZV9jb250ZW50X3JlbmRlcmVyX2NsaWVudC5jY1xuICAgICAgICAvLyBodHRwczovL2NzLmNocm9taXVtLm9yZy9jaHJvbWl1bS9zcmMvY2hyb21lL3JlbmRlcmVyL2Nocm9tZV9jb250ZW50X3JlbmRlcmVyX2NsaWVudC5jYz9sPTQyOFxuICAgICAgICAvL1xuICAgICAgICAvLyAqIFByb3RvY29sIHNob3VsZCBieXBhc3MgQ1NQIGNoZWNrXG4gICAgICAgIC8vIHJlZjogLy9zcmMvdGhpcmRfcGFydHkvYmxpbmsvcmVuZGVyZXIvY29yZS9mcmFtZS9jc3AvY29udGVudF9zZWN1cml0eV9wb2xpY3kuY2M/bD03MDZcbiAgICAgICAgLy8gaHR0cHM6Ly9jcy5jaHJvbWl1bS5vcmcvY2hyb21pdW0vc3JjL3RoaXJkX3BhcnR5L2JsaW5rL3JlbmRlcmVyL2NvcmUvZnJhbWUvY3NwL2NvbnRlbnRfc2VjdXJpdHlfcG9saWN5LmNjP2w9MTU1N1xuICAgICAgICAvL1xuICAgICAgICAvLyAqIFNlY3VyZSBEaXJlY3RpdmUgVmFsdWVzXG4gICAgICAgIC8vIHJlZjogLy9zcmMvZXh0ZW5zaW9ucy9jb21tb24vY3NwX3ZhbGlkYXRvci5jY1xuICAgICAgICAvLyBodHRwczovL2NzLmNocm9taXVtLm9yZy9jaHJvbWl1bS9zcmMvZXh0ZW5zaW9ucy9jb21tb24vY3NwX3ZhbGlkYXRvci5jYz9sPTI1NlxuXG4gICAgICAgIGNvbnN0IGNzcEhlYWRlcktleSA9ICdjb250ZW50LXNlY3VyaXR5LXBvbGljeSc7XG4gICAgICAgIGNvbnN0IGNzcFBvbGljeUtleSA9ICdmcmFtZS1zcmMnO1xuICAgICAgICBjb25zdCBjc3BEaXJlY3RpdmU6IHN0cmluZyA9IChyZXNwb25zZWhlYWRlcnNbY3NwSGVhZGVyS2V5XSB8fCBbXSlbMF07XG5cbiAgICAgICAgaWYgKGNzcERpcmVjdGl2ZSkge1xuICAgICAgICAgIGNvbnN0IHBvbGljaWVzID0gcGFyc2UoY3NwRGlyZWN0aXZlKTtcbiAgICAgICAgICBjb25zdCBmcmFtZVNyY1BvbGljeSA9IHBvbGljaWVzW2NzcFBvbGljeUtleV07XG5cbiAgICAgICAgICBpZiAoZnJhbWVTcmNQb2xpY3kpIHtcbiAgICAgICAgICAgIGNvbnN0IHBvbGljaWVzV2l0aE92ZXJyaWRlID0ge1xuICAgICAgICAgICAgICAuLi5wb2xpY2llcyxcbiAgICAgICAgICAgICAgW2NzcFBvbGljeUtleV06IFsuLi5mcmFtZVNyY1BvbGljeSwgUHJvdG9jb2wuRXh0ZW5zaW9uXSxcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIGhlYWRlcnMuc2V0KGNzcEhlYWRlcktleSwgW3N0cmluZ2lmeShwb2xpY2llc1dpdGhPdmVycmlkZSldKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gRW5kIG92ZXJyaWRlIENTUCBpZnJhbWUtc3JjIHBvbGljeVxuXG4gICAgICAgIGNvbnN0IGFjY2Vzc0NvbnRyb2xBbGxvd09yaWdpbiA9IHJlc3BvbnNlaGVhZGVyc1snYWNjZXNzLWNvbnRyb2wtYWxsb3ctb3JpZ2luJ10gfHwgW107XG4gICAgICAgIGNvbnN0IGFsbG93ZWRPcmlnaW5Jc1dpbGRjYXJkID0gYWNjZXNzQ29udHJvbEFsbG93T3JpZ2luLmluY2x1ZGVzKCcqJyk7XG5cbiAgICAgICAgLy8gQ29kZSBibG9jayBmb3IgYnlwYXNzIHByZWZsaWdodCBDT1JTIGNoZWNrIGxpa2UgV2F2ZWJveCBpcyBkb2luZyBpdFxuICAgICAgICAvLyBgY2hyb21lLWV4dGVuc2lvbjovL2AgcmVxdWVzdHMgZG9lc24ndCBieXBhc3MgQ09SU1xuICAgICAgICAvLyBjaGVjayBsaWtlIGluIENocm9taXVtXG4gICAgICAgIC8vXG4gICAgICAgIC8vIHJlZnM6XG4gICAgICAgIC8vIGh0dHBzOi8vZmV0Y2guc3BlYy53aGF0d2cub3JnLyNjb3JzLWNoZWNrXG4gICAgICAgIC8vIGh0dHBzOi8vY3MuY2hyb21pdW0ub3JnL2Nocm9taXVtL3NyYy9leHRlbnNpb25zL2NvbW1vbi9jb3JzX3V0aWwuaD9yY2w9ZmFmNWNmNWNiNTk4NTg3NWRlZGQwNjVkODUyYjM1YTAyN2U1MDkxNCZsPTIxXG4gICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS93YXZlYm94L3dhdmVib3hhcHAvYmxvYi8wOWY3OTEzMTRlMWVjYzgwOGNiYmY5MTlhYzY1ZTVmNmRkYTc4NWJkL3NyYy9hcHAvc3JjL0V4dGVuc2lvbnMvQ2hyb21lL0NSRXh0ZW5zaW9uUnVudGltZS9DUkV4dGVuc2lvbkJhY2tncm91bmRQYWdlLmpzI0wxOTVcbiAgICAgICAgLy8gdG9kbyhodWdvKTogZmluZCBhIGJldHRlciBhbmQgdW5kZXJzdGFuZGFibGUgc29sdXRpb25cbiAgICAgICAgaWYgKHJlcXVlc3RJc0ZvckV4dGVuc2lvbihmb3JtYXR0ZWREZXRhaWxzKVxuICAgICAgICAgIHx8IGFsbG93ZWRPcmlnaW5Jc1dpbGRjYXJkKSB7XG4gICAgICAgICAgaGVhZGVycy5zZXQoJ2FjY2Vzcy1jb250cm9sLWFsbG93LWNyZWRlbnRpYWxzJywgWyd0cnVlJ10pO1xuICAgICAgICAgIGhlYWRlcnMuc2V0KCdhY2Nlc3MtY29udHJvbC1hbGxvdy1vcmlnaW4nLCBbcmVxdWVzdHNPcmlnaW5zLmdldChpZCkhXSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaGVhZGVycy5zZXQoJ2FjY2Vzcy1jb250cm9sLWFsbG93LWNyZWRlbnRpYWxzJywgWyd0cnVlJ10pO1xuICAgICAgICB9XG5cbiAgICAgICAgcmVxdWVzdHNPcmlnaW5zLmRlbGV0ZShpZCk7XG5cbiAgICAgICAgY2FsbGJhY2soe1xuICAgICAgICAgIGNhbmNlbDogZmFsc2UsXG4gICAgICAgICAgcmVzcG9uc2VIZWFkZXJzOiBmcm9tRW50cmllcyhoZWFkZXJzKSxcbiAgICAgICAgfSk7XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBvcmlnaW46ICdlY3gtY29ycycsXG4gICAgICB9XG4gICAgKTtcbiAgfVxuKTtcbiJdfQ==
