"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const electron_1 = require("electron");
const windows_1 = require("../../common/apis/windows");
const handler_1 = tslib_1.__importDefault(require("../engine/handler"));
class Windows extends handler_1.default {
    constructor(extensionId, emitter) {
        super(extensionId, emitter);
        this.extensionWebContents = new Map();
    }
    handleGet(windowId, _getInfo) {
        const window = this.findBrowserWindow(windowId);
        if (window) {
            return {
                id: window.webContents.id,
                focused: window.isFocused(),
                incognito: false,
                alwaysOnTop: false,
            };
        }
        return {};
    }
    handleGetCurrent(_getInfo) {
        const window = electron_1.BrowserWindow.getFocusedWindow();
        if (window) {
            return {
                id: window.webContents.id,
                focused: window.isFocused(),
                incognito: false,
                alwaysOnTop: false,
            };
        }
        return {};
    }
    handleGetLastFocused(_getInfo) {
        const window = electron_1.BrowserWindow.getFocusedWindow();
        if (window) {
            return {
                id: window.webContents.id,
                focused: window.isFocused(),
                incognito: false,
                alwaysOnTop: false,
            };
        }
        return {};
    }
    handleGetAll(_getInfo) {
        const windows = electron_1.BrowserWindow.getAllWindows();
        const focusedWindow = electron_1.BrowserWindow.getFocusedWindow();
        const webContentsIds = focusedWindow ?
            new Set([...this.extensionWebContents.keys(), focusedWindow.webContents.id]) :
            new Set(this.extensionWebContents.keys());
        return windows
            .filter((window) => webContentsIds.has(window.webContents.id))
            .map((window) => ({
            id: window.webContents.id,
            focused: window.isFocused(),
            incognito: false,
            alwaysOnTop: false,
        }));
    }
    handleCreate(createData) {
        const { width, height, left, top, url } = createData;
        const window = new electron_1.BrowserWindow({
            width: width || 800,
            height: height || 600,
            x: left,
            y: top,
        });
        if (url)
            window.loadURL(url);
        this.extensionWebContents.set(window.webContents.id, window.webContents);
        const response = {
            id: window.webContents.id,
            focused: window.isFocused(),
            incognito: false,
            alwaysOnTop: false,
        };
        this.emit(windows_1.Events.OnCreated, response);
        return response;
    }
    handleUpdate(windowId, updateInfo) {
        const window = this.findBrowserWindow(windowId);
        if (window) {
            if (!this.extensionWebContents.has(window.webContents.id)) {
                return {};
            }
            if (updateInfo) {
                const { width, height, left, top } = updateInfo;
                if (updateInfo.width || updateInfo.height) {
                    const [windowWidth, windowHeight] = window.getSize();
                    window.setSize(width || windowWidth, height || windowHeight);
                }
                if (left || top) {
                    const [windowLeft, windowTop] = window.getPosition();
                    window.setPosition(left || windowLeft, top || windowTop);
                }
            }
            return {
                id: window.webContents.id,
                focused: window.isFocused(),
                incognito: false,
                alwaysOnTop: false,
            };
        }
        return {};
    }
    handleRemove(windowId) {
        const window = this.findBrowserWindow(windowId);
        if (window && this.extensionWebContents.has(window.webContents.id)) {
            window.close();
            this.extensionWebContents.delete(window.webContents.id);
            this.emit(windows_1.Events.OnRemoved, windowId);
        }
        return;
    }
    findBrowserWindow(windowId) {
        return electron_1.BrowserWindow
            .getAllWindows()
            .find((window) => window.webContents.id === windowId);
    }
}
exports.default = Windows;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL2hhbmRsZXJzL3dpbmRvd3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQXlDO0FBRXpDLHVEQU1tQztBQUVuQyx3RUFBd0M7QUFFeEMsTUFBcUIsT0FBUSxTQUFRLGlCQUFlO0lBTWxELFlBQVksV0FBNkIsRUFBRSxPQUE0RDtRQUNyRyxLQUFLLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzVCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxTQUFTLENBQUMsUUFBc0IsRUFBRSxRQUFpQjtRQUNqRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFaEQsSUFBSSxNQUFNLEVBQUU7WUFDVixPQUFPO2dCQUNMLEVBQUUsRUFBRSxNQUFNLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQ3pCLE9BQU8sRUFBRSxNQUFNLENBQUMsU0FBUyxFQUFFO2dCQUMzQixTQUFTLEVBQUUsS0FBSztnQkFDaEIsV0FBVyxFQUFFLEtBQUs7YUFDbkIsQ0FBQztTQUNIO1FBRUQsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsUUFBaUI7UUFDaEMsTUFBTSxNQUFNLEdBQUcsd0JBQWEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBRWhELElBQUksTUFBTSxFQUFFO1lBQ1YsT0FBTztnQkFDTCxFQUFFLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFO2dCQUN6QixPQUFPLEVBQUUsTUFBTSxDQUFDLFNBQVMsRUFBRTtnQkFDM0IsU0FBUyxFQUFFLEtBQUs7Z0JBQ2hCLFdBQVcsRUFBRSxLQUFLO2FBQ25CLENBQUM7U0FDSDtRQUVELE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVELG9CQUFvQixDQUFD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QyxnQkFBTSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUN2QztRQUVELE9BQU87SUFDVCxDQUFDO0lBRU8saUJBQWlCLENBQUMsUUFBc0I7UUFDOUMsT0FBTyx3QkFBYTthQUNqQixhQUFhLEVBQUU7YUFDZixJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLFFBQVEsQ0FBQyxDQUFDO0lBQzFELENBQUM7Q0FDRjtBQXZKRCwwQkF1SkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCcm93c2VyV2luZG93IH0gZnJvbSAnZWxlY3Ryb24nO1xuXG5pbXBvcnQge1xuICBXaW5kb3csXG4gIENyZWF0ZURhdGEsXG4gIEdldEluZm8sXG4gIFVwZGF0ZUluZm8sXG4gIEV2ZW50cyxcbn0gZnJvbSAnLi4vLi4vY29tbW9uL2FwaXMvd2luZG93cyc7XG5pbXBvcnQgeyBJRXh0ZW5zaW9uLCBFeHRlbnNpb25FdmVudE1lc3NhZ2UgfSBmcm9tICcuLi8uLi9jb21tb24vdHlwZXMnO1xuaW1wb3J0IEhhbmRsZXIgZnJvbSAnLi4vZW5naW5lL2hhbmRsZXInO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXaW5kb3dzIGV4dGVuZHMgSGFuZGxlcjxFdmVudHM+IHtcbiAgcHJvdGVjdGVkIGV4dGVuc2lvbldlYkNvbnRlbnRzOiBNYXA8XG4gICAgRWxlY3Ryb24uV2ViQ29udGVudHNbJ2lkJ10sXG4gICAgRWxlY3Ryb24uV2ViQ29udGVudHNcbiAgPjtcblxuICBjb25zdHJ1Y3RvcihleHRlbnNpb25JZDogSUV4dGVuc2lvblsnaWQnXSwgZW1pdHRlcjogKHBheWxvYWQ6IEV4dGVuc2lvbkV2ZW50TWVzc2FnZVsncGF5bG9hZCddKSA9PiB2b2lkKSB7XG4gICAgc3VwZXIoZXh0ZW5zaW9uSWQsIGVtaXR0ZXIpO1xuICAgIHRoaXMuZXh0ZW5zaW9uV2ViQ29udGVudHMgPSBuZXcgTWFwKCk7XG4gIH1cblxuICBoYW5kbGVHZXQod2luZG93SWQ6IFdpbmRvd1snaWQnXSwgX2dldEluZm86IEdldEluZm8pIHtcbiAgICBjb25zdCB3aW5kb3cgPSB0aGlzLmZpbmRCcm93c2VyV2luZG93KHdpbmRvd0lkKTtcblxuICAgIGlmICh3aW5kb3cpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiB3aW5kb3cud2ViQ29udGVudHMuaWQsXG4gICAgICAgIGZvY3VzZWQ6IHdpbmRvdy5pc0ZvY3VzZWQoKSxcbiAgICAgICAgaW5jb2duaXRvOiBmYWxzZSxcbiAgICAgICAgYWx3YXlzT25Ub3A6IGZhbHNlLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge307XG4gIH1cblxuICBoYW5kbGVHZXRDdXJyZW50KF9nZXRJbmZvOiBHZXRJbmZvKSB7XG4gICAgY29uc3Qgd2luZG93ID0gQnJvd3NlcldpbmRvdy5nZXRGb2N1c2VkV2luZG93KCk7XG5cbiAgICBpZiAod2luZG93KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpZDogd2luZG93LndlYkNvbnRlbnRzLmlkLFxuICAgICAgICBmb2N1c2VkOiB3aW5kb3cuaXNGb2N1c2VkKCksXG4gICAgICAgIGluY29nbml0bzogZmFsc2UsXG4gICAgICAgIGFsd2F5c09uVG9wOiBmYWxzZSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgaGFuZGxlR2V0TGFzdEZvY3VzZWQoX2dldEluZm86IEdldEluZm8pIHtcbiAgICBjb25zdCB3aW5kb3cgPSBCcm93c2VyV2luZG93LmdldEZvY3VzZWRXaW5kb3coKTtcblxuICAgIGlmICh3aW5kb3cpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGlkOiB3aW5kb3cud2ViQ29udGVudHMuaWQsXG4gICAgICAgIGZvY3VzZWQ6IHdpbmRvdy5pc0ZvY3VzZWQoKSxcbiAgICAgICAgaW5jb2duaXRvOiBmYWxzZSxcbiAgICAgICAgYWx3YXlzT25Ub3A6IGZhbHNlLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge307XG4gIH1cblxuICBoYW5kbGVHZXRBbGwoX2dldEluZm86IEdldEluZm8pIHtcbiAgICBjb25zdCB3aW5kb3dzID0gQnJvd3NlcldpbmRvdy5nZXRBbGxXaW5kb3dzKCk7XG4gICAgY29uc3QgZm9jdXNlZFdpbmRvdyA9IEJyb3dzZXJXaW5kb3cuZ2V0Rm9jdXNlZFdpbmRvdygpO1xuXG4gICAgY29uc3Qgd2ViQ29udGVudHNJZHMgPSBmb2N1c2VkV2luZG93ID9cbiAgICAgIG5ldyBTZXQoWy4uLnRoaXMuZXh0ZW5zaW9uV2ViQ29udGVudHMua2V5cygpLCBmb2N1c2VkV2luZG93LndlYkNvbnRlbnRzLmlkXSkgOlxuICAgICAgbmV3IFNldCh0aGlzLmV4dGVuc2lvbldlYkNvbnRlbnRzLmtleXMoKSk7XG5cbiAgICByZXR1cm4gd2luZG93c1xuICAgICAgLmZpbHRlcigod2luZG93KSA9PiB3ZWJDb250ZW50c0lkcy5oYXMod2luZG93LndlYkNvbnRlbnRzLmlkKSlcbiAgICAgIC5tYXAoXG4gICAgICAgICh3aW5kb3cpID0+ICh7XG4gICAgICAgICAgaWQ6IHdpbmRvdy53ZWJDb250ZW50cy5pZCxcbiAgICAgICAgICBmb2N1c2VkOiB3aW5kb3cuaXNGb2N1c2VkKCksXG4gICAgICAgICAgaW5jb2duaXRvOiBmYWxzZSxcbiAgICAgICAgICBhbHdheXNPblRvcDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgaGFuZGxlQ3JlYXRlKGNyZWF0ZURhdGE6IENyZWF0ZURhdGEpIHtcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIGxlZnQsIHRvcCwgdXJsIH0gPSBjcmVhdGVEYXRhO1xuXG4gICAgY29uc3Qgd2luZG93ID0gbmV3IEJyb3dzZXJXaW5kb3coe1xuICAgICAgd2lkdGg6IHdpZHRoIHx8IDgwMCxcbiAgICAgIGhlaWdodDogaGVpZ2h0IHx8IDYwMCxcbiAgICAgIHg6IGxlZnQsXG4gICAgICB5OiB0b3AsXG4gICAgfSk7XG5cbiAgICBpZiAodXJsKSB3aW5kb3cubG9hZFVSTCh1cmwpO1xuXG4gICAgdGhpcy5leHRlbnNpb25XZWJDb250ZW50cy5zZXQod2luZG93LndlYkNvbnRlbnRzLmlkLCB3aW5kb3cud2ViQ29udGVudHMpO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICBpZDogd2luZG93LndlYkNvbnRlbnRzLmlkLFxuICAgICAgZm9jdXNlZDogd2luZG93LmlzRm9jdXNlZCgpLFxuICAgICAgaW5jb2duaXRvOiBmYWxzZSxcbiAgICAgIGFsd2F5c09uVG9wOiBmYWxzZSxcbiAgICB9O1xuXG4gICAgdGhpcy5lbWl0KEV2ZW50cy5PbkNyZWF0ZWQsIHJlc3BvbnNlKTtcblxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfVxuXG4gIGhhbmRsZVVwZGF0ZSh3aW5kb3dJZDogV2luZG93WydpZCddLCB1cGRhdGVJbmZvOiBVcGRhdGVJbmZvKSB7XG4gICAgY29uc3Qgd2luZG93ID0gdGhpcy5maW5kQnJvd3NlcldpbmRvdyh3aW5kb3dJZCk7XG5cbiAgICBpZiAod2luZG93KSB7XG4gICAgICBpZiAoIXRoaXMuZXh0ZW5zaW9uV2ViQ29udGVudHMuaGFzKHdpbmRvdy53ZWJDb250ZW50cy5pZCkpIHtcbiAgICAgICAgcmV0dXJuIHt9O1xuICAgICAgfVxuXG4gICAgICBpZiAodXBkYXRlSW5mbykge1xuICAgICAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQsIGxlZnQsIHRvcCB9ID0gdXBkYXRlSW5mbztcbiAgICAgICAgaWYgKHVwZGF0ZUluZm8ud2lkdGggfHwgdXBkYXRlSW5mby5oZWlnaHQpIHtcbiAgICAgICAgICBjb25zdCBbd2luZG93V2lkdGgsIHdpbmRvd0hlaWdodF0gPSB3aW5kb3cuZ2V0U2l6ZSgpO1xuICAgICAgICAgIHdpbmRvdy5zZXRTaXplKHdpZHRoIHx8IHdpbmRvd1dpZHRoLCBoZWlnaHQgfHwgd2luZG93SGVpZ2h0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChsZWZ0IHx8IHRvcCkge1xuICAgICAgICAgIGNvbnN0IFt3aW5kb3dMZWZ0LCB3aW5kb3dUb3BdID0gd2luZG93LmdldFBvc2l0aW9uKCk7XG4gICAgICAgICAgd2luZG93LnNldFBvc2l0aW9uKGxlZnQgfHwgd2luZG93TGVmdCwgdG9wIHx8IHdpbmRvd1RvcCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaWQ6IHdpbmRvdy53ZWJDb250ZW50cy5pZCxcbiAgICAgICAgZm9jdXNlZDogd2luZG93LmlzRm9jdXNlZCgpLFxuICAgICAgICBpbmNvZ25pdG86IGZhbHNlLFxuICAgICAgICBhbHdheXNPblRvcDogZmFsc2UsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIGhhbmRsZVJlbW92ZSh3aW5kb3dJZDogV2luZG93WydpZCddKSB7XG4gICAgY29uc3Qgd2luZG93ID0gdGhpcy5maW5kQnJvd3NlcldpbmRvdyh3aW5kb3dJZCk7XG5cbiAgICBpZiAod2luZG93ICYmIHRoaXMuZXh0ZW5zaW9uV2ViQ29udGVudHMuaGFzKHdpbmRvdy53ZWJDb250ZW50cy5pZCkpIHtcbiAgICAgIHdpbmRvdy5jbG9zZSgpO1xuICAgICAgdGhpcy5leHRlbnNpb25XZWJDb250ZW50cy5kZWxldGUod2luZG93LndlYkNvbnRlbnRzLmlkKTtcbiAgICAgIHRoaXMuZW1pdChFdmVudHMuT25SZW1vdmVkLCB3aW5kb3dJZCk7XG4gICAgfVxuXG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kQnJvd3NlcldpbmRvdyh3aW5kb3dJZDogV2luZG93WydpZCddKSB7XG4gICAgcmV0dXJuIEJyb3dzZXJXaW5kb3dcbiAgICAgIC5nZXRBbGxXaW5kb3dzKClcbiAgICAgIC5maW5kKCh3aW5kb3cpID0+IHdpbmRvdy53ZWJDb250ZW50cy5pZCA9PT0gd2luZG93SWQpO1xuICB9XG59XG4iXX0=