const { RpcIpcManager } = require('electron-simple-rpc');
const { ipcSend, ipcReceive } = require('electron-simple-ipc');
const capitalize = require('capitalize');
const path = require('path');
const fs = require('fs-extra');
const PQueue = require('p-queue');
const { app } = require('electron');
const { EventEmitter } = require('events');
class FileChromeStorageBackend {
    constructor(areaName, extensionId) {
        this.areaName = areaName;
        this.extensionId = extensionId;
    }
    get storageFilePath() {
        return path.join(app.getPath('userData'), `/Chrome Storage/${this.extensionId}-${this.areaName}.json`);
    }
    readStorageFile() {
        return fs
            .readJson(this.storageFilePath)
            .catch(err => {
            if (err.code === 'ENOENT' || err instanceof SyntaxError)
                return {};
            throw err;
        });
    }
    writeStorageFile(data) {
        return fs.outputJson(this.storageFilePath, data);
    }
    get() {
        return this.readStorageFile();
    }
    set(data) {
        return this.writeStorageFile(data);
    }
}
class ChromeStorageAreaAPIHandler extends EventEmitter {
    constructor(areaName, extensionId) {
        super();
        this.storage = new FileChromeStorageBackend(areaName, extensionId);
        // via operatonsQueue, we make get, set, remove, clear methods atomique
        this.operationsQueue = new PQueue({ concurrency: 1 });
        const lib = {};
        ['get', 'set', 'remove', 'clear'].forEach(methodName => {
            const handler = this[`handle${capitalize(methodName)}`];
            lib[methodName] = (...args) => {
                return this.operationsQueue.add(() => handler.apply(this, args));
            };
        });
        const rpcScope = `chrome-storage-${areaName}-${extensionId}`;
        this.rpcManager = new RpcIpcManager(lib, rpcScope);
    }
    handleGet(keys) {
        return this.storage.get().then(storage => {
            if (keys == null)
                return storage;
            let defaults = {};
            switch (typeof keys) {
                case 'string':
                    keys = [keys];
                    break;
                case 'object':
                    if (!Array.isArray(keys)) {
                        defaults = keys;
                        keys = Object.keys(keys);
                    }
                    break;
            }
            if (keys.length === 0)
                return {};
            let items = {};
            keys.forEach(function (key) {
                var value = storage[key];
                if (value == null)
                    value = defaults[key];
                items[key] = value;
            });
            return items;
        });
    }
    handleSet(items) {
        return this.storage.get().then(storage => {
            Object.keys(items).forEach(function (name) {
                storage[name] = items[name];
            });
            return this.storage.set(storage);
        })
            // TODO: properly populate changes
            .then(() => this.emit('changed', {}));
    }
    handleRemove(keys) {
        return this.storage.get().then(storage => {
            if (!Array.isArray(keys)) {
                keys = [keys];
            }
            keys.forEach(function (key) {
                delete storage[key];
            });
            return this.storage.set(storage);
        })
            // TODO: properly populate changes
            .then(() => this.emit('changed', {}));
    }
    handleClear() {
        return this.storage.set({})
            // TODO: properly populate changes
            .then(() => this.emit('changed', {}));
    }
    release() {
        this.rpcManager.release();
    }
}
class ChromeStorageAPIHandler {
    constructor(extensionId) {
        this.syncStorageAPIHandler = new ChromeStorageAreaAPIHandler('sync', extensionId);
        this.localStorageAPIHandler = new ChromeStorageAreaAPIHandler('local', extensionId);
        const eventName = `chrome-storage-changed-${extensionId}`;
        this.syncStorageAPIHandler.on('changed', changes => ipcSend(eventName, [changes, 'sync']));
        this.localStorageAPIHandler.on('changed', changes => ipcSend(eventName, [changes, 'local']));
    }
    release() {
        this.syncStorageAPIHandler.release();
        this.localStorageAPIHandler.release();
    }
}
module.exports = ChromeStorageAPIHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RvcmFnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9icm93c2VyL2hhbmRsZXJzL3N0b3JhZ2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsTUFBTSxFQUFFLGFBQWEsRUFBRSxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ3pELE1BQU0sRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLENBQUM7QUFDL0QsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUM3QixNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDL0IsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2xDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDcEMsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUUzQyxNQUFNLHdCQUF3QjtJQUMxQixZQUFZLFFBQVEsRUFBRSxXQUFXO1FBQzdCLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO0lBQ25DLENBQUM7SUFFRCxJQUFJLGVBQWU7UUFDZixPQUFPLElBQUksQ0FBQyxJQUFJLENBQ1osR0FBRyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsRUFDdkIsbUJBQW1CLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFFBQVEsT0FBTyxDQUM5RCxDQUFBO0lBQ0wsQ0FBQztJQUVELGVBQWU7UUFDWCxPQUFPLEVBQUU7YUFDSixRQUFRLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQzthQUM5QixLQUFLLENBQUMs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R0FBRyx1QkFBdUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgUnBjSXBjTWFuYWdlciB9ID0gcmVxdWlyZSgnZWxlY3Ryb24tc2ltcGxlLXJwYycpO1xuY29uc3QgeyBpcGNTZW5kLCBpcGNSZWNlaXZlIH0gPSByZXF1aXJlKCdlbGVjdHJvbi1zaW1wbGUtaXBjJyk7XG5jb25zdCBjYXBpdGFsaXplID0gcmVxdWlyZSgnY2FwaXRhbGl6ZScpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcbmNvbnN0IFBRdWV1ZSA9IHJlcXVpcmUoJ3AtcXVldWUnKTtcbmNvbnN0IHsgYXBwIH0gPSByZXF1aXJlKCdlbGVjdHJvbicpO1xuY29uc3QgeyBFdmVudEVtaXR0ZXIgfSA9IHJlcXVpcmUoJ2V2ZW50cycpO1xuXG5jbGFzcyBGaWxlQ2hyb21lU3RvcmFnZUJhY2tlbmQge1xuICAgIGNvbnN0cnVjdG9yKGFyZWFOYW1lLCBleHRlbnNpb25JZCkge1xuICAgICAgICB0aGlzLmFyZWFOYW1lID0gYXJlYU5hbWU7XG4gICAgICAgIHRoaXMuZXh0ZW5zaW9uSWQgPSBleHRlbnNpb25JZDtcbiAgICB9XG5cbiAgICBnZXQgc3RvcmFnZUZpbGVQYXRoKCkge1xuICAgICAgICByZXR1cm4gcGF0aC5qb2luKFxuICAgICAgICAgICAgYXBwLmdldFBhdGgoJ3VzZXJEYXRhJyksXG4gICAgICAgICAgICBgL0Nocm9tZSBTdG9yYWdlLyR7dGhpcy5leHRlbnNpb25JZH0tJHt0aGlzLmFyZWFOYW1lfS5qc29uYFxuICAgICAgICApXG4gICAgfVxuXG4gICAgcmVhZFN0b3JhZ2VGaWxlKCkge1xuICAgICAgICByZXR1cm4gZnNcbiAgICAgICAgICAgIC5yZWFkSnNvbih0aGlzLnN0b3JhZ2VGaWxlUGF0aClcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIuY29kZSA9PT0gJ0VOT0VOVCcgfHwgZXJyIGluc3RhbmNlb2YgU3ludGF4RXJyb3IpIHJldHVybiB7fTtcbiAgICAgICAgICAgICAgICB0aHJvdyBlcnJcbiAgICAgICAgICAgIH0pXG4gICAgfVxuXG4gICAgd3JpdGVTdG9yYWdlRmlsZShkYXRhKSB7XG4gICAgICAgIHJldHVybiBmcy5vdXRwdXRKc29uKHRoaXMuc3RvcmFnZUZpbGVQYXRoLCBkYXRhKTtcbiAgICB9XG5cbiAgICBnZXQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlYWRTdG9yYWdlRmlsZSgpXG4gICAgfVxuXG4gICAgc2V0KGRhdGEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMud3JpdGVTdG9yYWdlRmlsZShkYXRhKVxuICAgIH1cblxuXG59XG5cbmNsYXNzIENocm9tZVN0b3JhZ2VBcmVhQVBJSGFuZGxlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgY29uc3RydWN0b3IoYXJlYU5hbWUsIGV4dGVuc2lvbklkKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuc3RvcmFnZSA9IG5ldyBGaWxlQ2hyb21lU3RvcmFnZUJhY2tlbmQoYXJlYU5hbWUsIGV4dGVuc2lvbklkKTtcblxuICAgICAgICAvLyB2aWEgb3BlcmF0b25zUXVldWUsIHdlIG1ha2UgZ2V0LCBzZXQsIHJlbW92ZSwgY2xlYXIgbWV0aG9kcyBhdG9taXF1ZVxuICAgICAgICB0aGlzLm9wZXJhdGlvbnNRdWV1ZSA9IG5ldyBQUXVldWUoeyBjb25jdXJyZW5jeTogMSB9KTtcblxuICAgICAgICBjb25zdCBsaWIgPSB7fTtcbiAgICAgICAgWydnZXQnLCAnc2V0JywgJ3JlbW92ZScsICdjbGVhciddLmZvckVhY2gobWV0aG9kTmFtZSA9PiB7XG4gICAgICAgICAgICBjb25zdCBoYW5kbGVyID0gdGhpc1tgaGFuZGxlJHtjYXBpdGFsaXplKG1ldGhvZE5hbWUpfWBdO1xuICAgICAgICAgICAgbGliW21ldGhvZE5hbWVdID0gKC4uLmFyZ3MpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25zUXVldWUuYWRkKCgpID0+IGhhbmRsZXIuYXBwbHkodGhpcywgYXJncykpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIGNvbnN0IHJwY1Njb3BlID0gYGNocm9tZS1zdG9yYWdlLSR7YXJlYU5hbWV9LSR7ZXh0ZW5zaW9uSWR9YDtcbiAgICAgICAgdGhpcy5ycGNNYW5hZ2VyID0gbmV3IFJwY0lwY01hbmFnZXIobGliLCBycGNTY29wZSk7XG4gICAgfVxuXG4gICAgaGFuZGxlR2V0KGtleXMpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5nZXQoKS50aGVuKHN0b3JhZ2UgPT4ge1xuICAgICAgICAgICAgaWYgKGtleXMgPT0gbnVsbCkgcmV0dXJuIHN0b3JhZ2VcblxuICAgICAgICAgICAgbGV0IGRlZmF1bHRzID0ge31cbiAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIGtleXMpIHtcbiAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgICAgICAgICBrZXlzID0gW2tleXNdXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICAgICAgY2FzZSAnb2JqZWN0JzpcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGtleXMpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWZhdWx0cyA9IGtleXNcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleXMgPSBPYmplY3Qua2V5cyhrZXlzKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoa2V5cy5sZW5ndGggPT09IDApIHJldHVybiB7fVxuXG4gICAgICAgICAgICBsZXQgaXRlbXMgPSB7fVxuICAgICAgICAgICAga2V5cy5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBzdG9yYWdlW2tleV1cbiAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgdmFsdWUgPSBkZWZhdWx0c1trZXldXG4gICAgICAgICAgICAgICAgaXRlbXNba2V5XSA9IHZhbHVlXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgcmV0dXJuIGl0ZW1zXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgaGFuZGxlU2V0KGl0ZW1zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0b3JhZ2UuZ2V0KCkudGhlbihzdG9yYWdlID0+IHtcbiAgICAgICAgICAgIE9iamVjdC5rZXlzKGl0ZW1zKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7XG4gICAgICAgICAgICAgICAgc3RvcmFnZVtuYW1lXSA9IGl0ZW1zW25hbWVdXG4gICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zdG9yYWdlLnNldChzdG9yYWdlKVxuICAgICAgICB9KVxuICAgICAgICAgICAgLy8gVE9ETzogcHJvcGVybHkgcG9wdWxhdGUgY2hhbmdlc1xuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5lbWl0KCdjaGFuZ2VkJywge30pKVxuICAgIH1cblxuICAgIGhhbmRsZVJlbW92ZShrZXlzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0b3JhZ2UuZ2V0KCkudGhlbihzdG9yYWdlID0+IHtcbiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShrZXlzKSkge1xuICAgICAgICAgICAgICAgIGtleXMgPSBba2V5c11cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGtleXMuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIHN0b3JhZ2Vba2V5XVxuICAgICAgICAgICAgfSlcblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5zZXQoc3RvcmFnZSk7XG4gICAgICAgIH0pXG4gICAgICAgICAgICAvLyBUT0RPOiBwcm9wZXJseSBwb3B1bGF0ZSBjaGFuZ2VzXG4gICAgICAgICAgICAudGhlbigoKSA9PiB0aGlzLmVtaXQoJ2NoYW5nZWQnLCB7fSkpXG4gICAgfVxuXG4gICAgaGFuZGxlQ2xlYXIoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0b3JhZ2Uuc2V0KHt9KVxuICAgICAgICAgICAgLy8gVE9ETzogcHJvcGVybHkgcG9wdWxhdGUgY2hhbmdlc1xuICAgICAgICAgICAgLnRoZW4oKCkgPT4gdGhpcy5lbWl0KCdjaGFuZ2VkJywge30pKVxuICAgIH1cblxuICAgIHJlbGVhc2UoKSB7XG4gICAgICAgIHRoaXMucnBjTWFuYWdlci5yZWxlYXNlKCk7XG4gICAgfVxufVxuXG5jbGFzcyBDaHJvbWVTdG9yYWdlQVBJSGFuZGxlciB7XG4gICAgY29uc3RydWN0b3IoZXh0ZW5zaW9uSWQpIHtcbiAgICAgICAgdGhpcy5zeW5jU3RvcmFnZUFQSUhhbmRsZXIgPSBuZXcgQ2hyb21lU3RvcmFnZUFyZWFBUElIYW5kbGVyKCdzeW5jJywgZXh0ZW5zaW9uSWQpO1xuICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZUFQSUhhbmRsZXIgPSBuZXcgQ2hyb21lU3RvcmFnZUFyZWFBUElIYW5kbGVyKCdsb2NhbCcsIGV4dGVuc2lvbklkKTtcblxuICAgICAgICBjb25zdCBldmVudE5hbWUgPSBgY2hyb21lLXN0b3JhZ2UtY2hhbmdlZC0ke2V4dGVuc2lvbklkfWA7XG4gICAgICAgIHRoaXMuc3luY1N0b3JhZ2VBUElIYW5kbGVyLm9uKCdjaGFuZ2VkJywgY2hhbmdlcyA9PlxuICAgICAgICAgICAgaXBjU2VuZChldmVudE5hbWUsIFtjaGFuZ2VzLCAnc3luYyddKSk7XG4gICAgICAgIHRoaXMubG9jYWxTdG9yYWdlQVBJSGFuZGxlci5vbignY2hhbmdlZCcsIGNoYW5nZXMgPT5cbiAgICAgICAgICAgIGlwY1NlbmQoZXZlbnROYW1lLCBbY2hhbmdlcywgJ2xvY2FsJ10pKTtcbiAgICB9XG4gICAgcmVsZWFzZSgpIHtcbiAgICAgICAgdGhpcy5zeW5jU3RvcmFnZUFQSUhhbmRsZXIucmVsZWFzZSgpO1xuICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZUFQSUhhbmRsZXIucmVsZWFzZSgpO1xuICAgIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBDaHJvbWVTdG9yYWdlQVBJSGFuZGxlcjtcbiJdfQ==